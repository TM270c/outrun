# Outrun Codebase – Cleanup Roadmap (Pass 1 Overview)

## 1. Game Overview
- **What it is**: A browser racing game with menus, vehicle selection, races, scoreboards, and bonus items.
- **Where it runs**: In the browser, using WebGL helpers in `src/gl/` to draw the game and normal DOM code for menus.
- **What it loads**: Settings from `src/config.js`, track data from `tracks/`, sprite info from `src/sprite-catalog.js`, and texture info from `src/world.js`.

## 2. Main Building Blocks

### 2.1 Starting the Game
- **`src/bootstrap.js`** loads assets, sets up callbacks, and shares helpers across the rest of the code.
- **`src/app.js`** is the overall game manager. It swaps between menus, races, pause screens, and the scoreboard. It also tracks button presses and animation timing.

### 2.2 Settings and Static Data
- **`src/config.js`** stores constants such as physics values, track layout numbers, render sizes, and debug toggles.
- **`tracks/`** holds the CSV files that describe the track layout, hills, and curves.

### 2.3 Math and Helpers
- **`src/math.js`** is a grab bag of number helpers. It includes easing curves, random helpers, and small math utilities that many files use.

### 2.4 World and Assets
- **`src/world.js`** creates the in-game world. It builds track segments, sets up cliff data, manages boost zones, and keeps track of textures.

### 2.5 Racing Logic
- **`src/gameplay.js`** runs the race. It updates car physics, handles collisions, spawns traffic, keeps time, and calls into rendering.

### 2.6 Drawing the Game
- **`src/render.js`** draws everything on screen. It prepares road geometry, sprites, overlays, and any debug panels each frame.
- **`src/gl/`** contains the low-level WebGL code for shaders, buffers, and textured quads.

### 2.7 Sprites and Animation
- **`src/sprite-catalog.js`** defines every sprite sheet, animation frame, and scaling rule for vehicles, roadside props, and UI icons.

### 2.8 Menus and UI
- **`src/ui/screens.js`** generates the HTML for each menu screen, such as the main menu, pause screen, vehicle select, settings, scoreboard, attract mode, and race complete screens.

### 2.9 Input Handling
- Button handling lives partly in `app.js` (menus) and partly in `gameplay.js` (driving controls). Both listen for key events and update shared input state.

### 2.10 Other Files
- **`docs/`, `tex/`, `video/`** contain written docs and art references.
- **`index.mod.html`** is the main HTML shell for the game canvas and menus.
- **`monolith-old.txt`** is an older architecture reference.

## 3. Function Inventory by Category

### 3.1 Application & Menu Flow (`src/app.js`)
- `createInitialRaceCompleteState`
  - **Purpose**: Factory for a blank race-complete screen state so menus can start fresh when a race ends or restarts.
  - **Inputs**: None.
  - **Outputs**: Object with `active`, `timeMs`, `letters`, `confirmed`, `currentIndex`, `phase`, `timer`, `entryId`, `playerName`, `playerRank`.
  - **Side effects**: None (pure data builder).
  - **Shared state & call sites**: Assigned to `state.raceComplete` in `src/app.js:58`, `85`, `739`.
  - **Dependencies**: No calls.
  - **Edge cases**: Provides safe defaults (zero time, placeholder name); does not validate external inputs.
  - **Performance**: Constant-time object creation when menus reset or a race finishes.
  - **Units / spaces**: `timeMs` in milliseconds.
  - **Determinism**: Yes—always returns identical data.
  - **Keep / change / delete**: Keep; simplest alternative is inlining the literal where used.
  - **Confidence / assumptions**: High confidence; assumes `letters` of `'AAA'` is intended default.
  - **Notes**: Possible reductions: none spotted; placement in `src/app.js` matches usage via `resetRaceCompleteState`; consider renaming to shorter `inputNameState` for clarity.
- `resetRaceCompleteState`
  - **Purpose**: Resets the race-finish screen data back to a clean slate so the next race starts with blank initials and zeroed time.
  - **Inputs**: None.
  - **Outputs**: None; updates in-place.
  - **Side effects**: Replaces `state.raceComplete` with fresh defaults, wiping any prior letters, timers, or entry IDs.
  - **Shared state & call sites**: `state.raceComplete` reassigned; invoked at `src/app.js:232,724,1133`.
  - **Dependencies**: Calls `createInitialRaceCompleteState`.
  - **Edge cases**: Covers stale data by always cloning defaults; does not special-case DNF/DQ or preserve existing names.
  - **Performance**: Constant-time object replacement when leaving the race-complete screen, starting a race, or booting.
  - **Units / spaces**: Defaults include `timeMs` in milliseconds and name letters in uppercase strings.
  - **Determinism**: Yes—same empty state every call.
  - **Keep / change / delete**: Keep; simple helper prevents duplicated setup—alternative is to inline the factory call.
  - **Confidence / assumptions**: High confidence; assumes no other module mutates `state.raceComplete` directly.
  - **Notes**: Reviewer noted there were "no notes" and the helper already looks adequate; I concur and suggest only revisiting if future menu reset work reveals redundant copies or missed shared behavior.
- `now`
  - **Purpose**: Helper that grabs the current timestamp so menu flow can compare idle time without repeating the built-in Date.now call.
  - **Inputs**: None.
  - **Outputs**: Number of milliseconds since January 1, 1970 returned from Date.now.
  - **Side effects**: None; it only reads the system clock.
  - **Shared state & call sites**: Updates and reads state.lastInteractionAt in src/app.js:93, 1119, 1132 when tracking menu idleness.
  - **Dependencies**: JavaScript built-in Date.now.
  - **Edge cases**: Does not guard against someone changing the computer clock or supplying mock timers.
  - **Performance**: Single native call; negligible cost even when polled for idle checks.
  - **Units / spaces**: Milliseconds of real-world time.
  - **Determinism**: Returns whatever the system clock reports, so calls made moments apart differ.
  - **Keep / change / delete**: Change—either inline Date.now, or keep the helper but rename it getTimeNow and allow injecting a test clock to cut indirection.
  - **Confidence / assumptions**: High confidence; assumes there are no hidden callers outside this file.
  - **Notes**: You felt the helper was fine and suggested renaming it to getTimeNow; I still recommend inlining Date.now or accepting an injected clock so tests stay predictable.
- `markInteraction`
  - Purpose: Refreshes the menu idle timer whenever menus or settings detect user activity so attract mode does not trigger unexpectedly.
  - Inputs: None.
  - Outputs: None; the helper only updates the saved timestamp.
  - Side effects: Sets state.lastInteractionAt to the current clock reading.
  - Shared state & call sites: Touches state.lastInteractionAt; invoked in src/app.js:229, 648, 1046, 1067 before mode swaps, race-complete phase changes, and non-race key handling.
  - Dependencies: Calls now(), which wraps the browser clock.
  - Edge cases: No extra handling; assumes the shared state exists and does not guard against clock drift.
  - Performance: Constant-time assignment; runs whenever menu interactions happen.
  - Units / spaces: Timestamp stored in milliseconds since epoch.
  - Determinism: No; each call captures the live clock so repeated calls differ.
  - Keep / change / delete: Keep; central helper prevents repeating the timestamp write.
  - Confidence / assumptions: High confidence; assumes Date.now is available and state was initialized.
  - **Notes**: Previous helpers here all shape the attract-mode idle timer; reviewer noted we could inline to `Date.now()` or rename `now()` to `getTimeNow`, yet centralizing this clock write still makes the idle-timer maintenance easy if we tweak the attract flow.
- `escapeHtml`
  - Purpose: Converts any incoming menu label or score text into safe HTML so UI templates cannot inject tags or break layout.
  - Inputs: `text` (any value; coerced to string; no length guard but intended for short UI snippets).
  - Outputs: Escaped string with `&`, `<`, `>`, `"`, `'` replaced by HTML entities.
  - Side effects: None; leaves globals, files, and timers untouched.
  - Shared state & use: None touched; passed to screen renderers at `src/app.js:260,287,310,321,341,365`, consumed throughout `src/ui/screens.js:5-193`.
  - Dependencies: Built-in `String` conversion plus chained `replace` calls.
  - Edge cases: Handles `null`/`undefined` by returning `'null'`/`'undefined'`; does not trim, truncate, or detect already-escaped text.
  - Performance: Linear per character; only runs when menus build HTML so cost is minimal.
  - Units / spaces: Plain text; no time or coordinate units involved.
  - Determinism: Same input yields same escaped output; running it twice without changes gives the same string.
  - Keep / change / delete: Keep; simplest alternative is to rely on DOM text nodes via `textContent` instead of manual escaping.
  - Confidence / assumptions: High confidence; assumes menu strings stay reasonably short and mostly plain-language characters.
  - Notes: Reviewer confirmed this helper simply keeps player score initials constrained to safe characters like "ABC" so the menu never sees risky markup, and I agree the current implementation is sound while noting we could later simplify by routing menu strings through shared DOM text-node helpers if we consolidate UI rendering.
- `resolveAssetUrlSafe`
  - **Purpose**: Wraps the world's asset resolver so menu templates can turn relative preview filenames into usable URLs without crashing if the resolver is missing.
  - **Inputs**: `path` string; accepts falsy (`''`, `null`, `undefined`) and any other value, though only non-empty strings resolve meaningfully.
  - **Outputs**: Returns the resolved string from `World.resolveAssetUrl(path)` or the original `path`; falls back to `''` when the input is falsy.
  - **Side effects**: None—no writes to state, storage, or logs; only calls the global resolver when available.
  - **Shared state & call sites**: Reads global `World` (`src/app.js:105-114`); passed to `AppScreens.vehicleSelect` as `resolveAssetUrl` helper (`src/app.js:331-341`).
  - **Dependencies**: `World.resolveAssetUrl` when defined; otherwise none.
  - **Edge cases**: Handles missing/falsey paths, missing resolver, and exceptions thrown by the resolver; does not validate URL format or strip whitespace.
  - **Performance**: Constant time; called when building vehicle select screen renders.
  - **Units / spaces**: Operates on raw URL/path strings; no coordinate spaces.
  - **Determinism**: Deterministic for the same `World.resolveAssetUrl` implementation and input; returning input unchanged if resolver state changes between calls.
  - **Keep / change / delete**: Keep; simplest tweak would be to inline a null-safe resolver but helper keeps template call clean.
  - **Confidence / assumptions**: High confidence; assumes `World` global remains stable and resolver returns a string.
  - **Notes**: Possible reductions include inlining the null-check if we ever centralize asset helpers or renaming to `safeResolveAssetUrl` so its guard role is clearer. Reviewer summary: “Uses `escapeHtml` so filenames render despite odd characters?” Clarification: this helper never touches HTML escaping and instead just delegates to `World.resolveAssetUrl`, so unusual characters flow through unchanged unless the resolver rewrites them. Future update could link it with a path sanitizer if we discover malformed inputs.
- `normalizePreviewAtlas`
  - Purpose: Convert optional preview sprite sheet settings into a safe atlas description for the vehicle preview.
  - Inputs: `raw` object with `columns`, `rows`, `frameCount`, `frameRate`, `frameDuration`; expects positive numbers or empty.
  - Outputs: Object with positive `columns`, `rows`, `frameCount`, `frameDuration` seconds, or `null` when data is unusable.
  - Side effects: None; only reads the default frame duration constant.
  - Shared state & call sites: Used by `renderVehicleSelect` in `src/app.js:339`; does not mutate shared state.
  - Dependencies: Basic math helpers (`Number`, `Math`) and `DEFAULT_VEHICLE_PREVIEW_FRAME_DURATION`.
  - Edge cases: Fills missing counts from other fields, derives duration from frame rate, returns `null` on non-positive or absent data.
  - Performance: Constant-time arithmetic when building the menu model; no loops beyond a handful of checks.
  - Units / spaces: Frame duration measured in seconds; counts represent frame totals; independent of render frame rate.
  - Determinism: Yes; same input produces the same atlas and no persistent changes.
  - Keep / change / delete: Keep; consolidates validation that would otherwise live inside `renderVehicleSelect`.
  - Confidence / assumptions: High confidence; assumes preview atlas configs stay small and numeric.
  - Notes: Reviewer summarized this as the helper that lets `renderVehicleSelect` slice the preview atlas, then asked whether it should merge with the atlas animation handler used by player vehicles and animated billboards; keep it separate for now because the preview path needs unique defaults, null returns, and timing fallbacks, but queue a follow-up to lift the shared frame math if those pipelines ever align.
- `formatTimeMs`
  - **Purpose**: Converts a raw millisecond count into a friendly label for menus and scoreboards so players see human-readable times.
  - **Inputs**: `value` (number in milliseconds; accepts any finite number, clamps negatives to zero, ignores non-finite values).
  - **Outputs**: String like `'12,345 ms'` or `'--'` when the input is not a usable number.
  - **Side effects**: None; computes and returns a string without mutating data or logging.
  - **Shared state & call sites**: Used for leaderboard entries at `src/app.js:182` and race-complete label at `src/app.js:353`.
  - **Dependencies**: Built-ins `Number.isFinite`, `Math.round`, `Math.max`, `toLocaleString`.
  - **Edge cases**: Handles non-finite values by returning `'--'` and clamps negatives to zero; does not distinguish DNF/DQ or preserve fractional milliseconds.
  - **Performance**: Constant-time number formatting when leaderboard rows build or race results render.
  - **Units / spaces**: Treats input as milliseconds and formats a locale-aware millisecond string.
  - **Determinism**: Pure for a fixed locale—same input yields the same formatted string; running again has no extra effects.
  - **Keep / change / delete**: Keep; smallest alternative would be inlining the formatting string where used.
  - **Confidence / assumptions**: High confidence; assumes default locale formatting is acceptable for all displays.
  - **Notes**: Reviewer praised the explanation and restated that the helper simply turns raw milliseconds into something readable while asking if we duplicate this logic elsewhere, and my follow-up confirmed the formatter appears only in `src/app.js` today. Should another menu or HUD pathway need the same presentation, we can lift this helper into a shared time-formatting module so we do not drift on style.
- `createLeaderboardEntry`
  - Purpose: Builds a leaderboard row with cleaned initials, numeric time, formatted label, saved date, and empty rank.
  - Inputs: Name text trimmed to three uppercase letters, scoreMs finish time in milliseconds with non-numbers treated as 0, optional date string defaulting to blank.
  - Outputs: Object holding a unique id, cleaned name, raw score, formatted display string, provided date, and null rank.
  - Side effects: None; only makes and returns new data.
  - Shared state touched and where it’s used: No direct shared state; called at src/app.js:212 (local add) and src/app.js:850 (CSV import).
  - Dependencies: Uses formatTimeMs for the display string.
  - Edge cases handled or missed: Covers empty names and non-numeric scores; allows negative scores (shown as 0 ms) and ignores DNF/DQ notes or tie rules beyond later sorting.
  - Performance: Constant-time string and number cleanup when leaderboard entries are made.
  - Units/spaces: Treats scores as milliseconds and display text suffixed with “ms”.
  - Determinism: Fields repeat for the same inputs except for a new unique id each call.
  - Keep / change / delete: Keep; alternative is to inline the object build at the two use sites.
  - Confidence / assumptions: High confidence; assumes the board expects three-letter uppercase initials and millisecond scores.
  - Notes: Reviewer asked, “What actually updates the entry in the .csv file?”—right now nothing writes back, because entries only live in memory while `fetch('data/leaderboard.csv')` seeds the list; if persistence ever arrives we could fold this helper into a loader/saver module or attach a dedicated save routine, but until then the clearest update is to document that gap.
- `recomputeLeaderboardRanks`
  - **Purpose**: Walks the current leaderboard list and stamps each non-empty entry with its 1-based place so the menu can show accurate ranks after sorting or CSV import.
  - **Inputs**: `entries` array (defaults to `state.leaderboard.entries`); expects objects shaped like `createLeaderboardEntry`; ignores falsy slots.
  - **Outputs**: None returned; updates each entry's `rank` property in place.
  - **Side effects**: Mutates the provided entries; when called with the default, writes directly into shared leaderboard state.
  - **Shared state & call sites**: Touches `state.leaderboard.entries`; invoked after sorting in `src/app.js:203` and after CSV parsing in `src/app.js:863`.
  - **Dependencies**: No subordinate calls.
  - **Edge cases**: Skips holes/nulls but still leaves prior rank on those slots; does not adjust for tied scores beyond list order.
  - **Performance**: Linear pass over the array whenever leaderboard data changes; trivial cost compared with sorting/loading frequency.
  - **Units / spaces**: Ranks are simple 1-based integers.
  - **Determinism**: Deterministic for a fixed input order; repeating without changes is idempotent.
  - **Keep / change / delete**: Keep; could fold into `sortLeaderboardEntries` but shared reuse by CSV import makes the helper worthwhile.
  - **Confidence / assumptions**: High confidence; assumes callers already sorted entries and that sparse arrays are rare.
  - **Notes**: Reviewer summary: "looks good, no notes, likely no need to fold"; I concur and would only revisit consolidation if future refactors merge leaderboard sorting and ranking into a single pass, so keep monitoring but no action required now.
- `sortLeaderboardEntries`
  - **Purpose**: Keeps the leaderboard ordered so faster times float to the top, currently breaking ties alphabetically for display.
  - **Inputs**: None explicitly; reads `state.leaderboard.entries` which should contain objects with `score` numbers and `name` strings.
  - **Outputs**: None; entries end up sorted and re-ranked in place.
  - **Side effects**: Mutates `state.leaderboard.entries`, updates each entry’s `rank`, and drives highlight behavior after sorting.
  - **Shared state & call sites**: Touches `state.leaderboard.entries`/`rank`; invoked from `src/app.js:215` after adding a local score and `src/app.js:815` after loading remote scores.
  - **Dependencies**: Uses Array sort plus `recomputeLeaderboardRanks` to refresh rank numbers.
  - **Edge cases**: Skips over missing entries, pushes null/undefined records to the end, and resolves equal scores with a name comparison despite not honoring play date order; does not special-case DNFs or impossible scores.
  - **Performance**: Native Array sort over the current entries list; only runs on leaderboard updates, not every frame.
  - **Units / spaces**: Compares `score` values measured in milliseconds.
  - **Determinism**: Yes—same entry data yields the same order and ranks.
  - **Keep / change / delete**: Keep; could only be inlined alongside the rank refresh at each call site.
  - **Confidence / assumptions**: High confidence; assumes entries always provide numeric `score` and uppercase `name`.
  - **Notes**: Reviewer: "Alphabetical ordering on equal scores feels wrong; should favor newer runs so the recent score rises above." Response: Capture a precise play timestamp on each entry and update the comparator to sort by score then newest-first, keeping name as a final fallback so expectations and ranking stay aligned.
- `findLeaderboardEntryIndexById`
  - Purpose: Finds where a saved leaderboard entry sits in the current list so menus can highlight the right racer.
  - Inputs: id (stored entry identifier, usually created when adding to the leaderboard; must be provided).
  - Outputs: Returns the zero-based position in the leaderboard list, or -1 when the id is missing or not found.
  - Side effects: None; only reads shared data.
  - Shared state & call sites: Reads state.leaderboard.entries array sorted in src/app.js:199-205 and appended in src/app.js:212-215; defined in src/app.js:206-210.
  - Dependencies: Uses the built-in findIndex helper on arrays; no other modules.
  - Edge cases: Skips falsy ids and empty slots but does not detect duplicate ids or symbols that no longer exist.
  - Performance: Linear scan of the current entries list; called only when highlight lookup is needed.
  - Units / spaces: Works in array positions; no time or spatial units.
  - Determinism: Same id and state yield the same index; repeated calls do not change data.
  - Keep / change / delete: Keep; lightweight helper that could be folded into leaderboard lookup code if refactored.
  - Confidence / assumptions: High confidence, assuming entries retain their id values.
- `addLeaderboardEntry`
- `setMode`
- `ensureDom`
- `renderMainMenu`
- `renderLeaderboard`
- `renderSettings`
- `renderPauseMenu`
  - Purpose: Builds the pause overlay markup so the player sees the resume and quit choices whenever play is halted.
  - Inputs: `AppScreens.pauseMenu` template function must exist; `pauseMenuOptions` list of two menu entries (`resume`, `quit`); `state.pauseMenuIndex` zero-based position expected between 0 and options length minus one.
  - Outputs: Returns the pause menu HTML string with the options array and the currently highlighted index passed through.
  - Side effects: None; only reads globals.
  - Shared state touched and call sites: Reads `pauseMenuOptions` (src/app.js:14-17) and `state.pauseMenuIndex` (src/app.js:42-46); invoked inside `updateMenuLayer` when `state.mode === 'paused'` (src/app.js:391-409); index mutated by `changePauseMenuSelection` (src/app.js:533-537), `setMode` (src/app.js:220-235), and `init` (src/app.js:1127-1136).
  - Dependencies: Calls `AppScreens.pauseMenu` with the local `escapeHtml` helper for safe text output.
  - Edge cases: Falls back to an empty string when the pause screen template is missing; otherwise expects the options array to contain entries and does not guard against an out-of-range index (resulting in no item selected).
  - Performance: Maps over two static menu options; runs only when the menu layer redraws during pause transitions or navigation.
  - Units/spaces: Uses zero-based menu positions; no time or world coordinates involved.
  - Determinism: Same inputs and state produce the same markup; repeated calls do not alter data.
  - Keep / change / delete: Keep; already minimal wrapper that could merge into a broader screen renderer during a larger refactor.
  - Confidence / assumptions: High confidence, assuming the global screen renderer keeps returning deterministic markup.
- `renderVehicleSelect`
- `renderAttract`
- `renderRaceComplete`
- `startAttractPlayback`
- `stopAttractPlayback`
- `updateMenuLayer`
- `applyVehiclePreviewFrame`
- `setupVehiclePreviewAnimation`
- `updateVehiclePreviewAnimation`
- `clampIndex`
- `changeMainMenuSelection`
- `changePauseMenuSelection`
- `changeSettingsSelection`
- `changeVehicleSelection`
- `getVehicleOptionByKey`
- `applyVehicleSelection`
- `showVehicleSelect`
- `activateVehicleSelection`
- `adjustCurrentNameLetter`
- `lockCurrentNameLetter`
- `finalizeRaceCompleteEntry`
- `setRaceCompletePhase`
- `advanceRaceCompleteSequence`
- `updateRaceComplete`
- `goToAttract`
- `toggleSnowSetting`
- `applyDebugModeSetting`
- `setDebugEnabled`
- `toggleDebugSetting`
- `resetGameplayInputs`
- `startRace`
- `handleRaceFinish`
- `showLeaderboard`
- `showSettings`
- `resumeRace`
- `quitToMenu`
- `activateMainMenuSelection`
- `activatePauseMenuSelection`
- `activateSettingsSelection`
- `requestLeaderboard`
- `parseLeaderboardCsv`
- `handleMenuNavigation`
- `handlePauseNavigation`
- `handleSettingsNavigation`
- `handleMenuKeyDown`
- `handleLeaderboardKeyDown`
- `handleSettingsKeyDown`
- `handleVehicleSelectKeyDown`
- `handlePauseKeyDown`
- `handleRaceCompleteKeyDown`
- `handleAttractKeyDown`
- `handleKeyDown`
- `handleKeyUp`
- `step`
- `init`
- `isSnowEnabled`
- `isDebugEnabled`

### 3.2 UI Screen Templates (`src/ui/screens.js`)
- `ensureEscapeHtml`
- `mainMenuScreen`
- `pauseMenuScreen`
- `vehicleSelectScreen`
- `settingsMenuScreen`
- `leaderboardScreen`
- `attractScreen`
- `raceCompleteScreen`

### 3.3 Asset Loading & Bootstrapping (`src/bootstrap.js`)
- `loadManifestTextures`
- `loadAssets`
- `setupCallbacks`

### 3.4 Vehicle Control & Physics (`src/gameplay.js`)
- `trackLengthRef`
- `hasSegments`
- `wrapByLength`
- `wrapSegmentIndex`
- `ensureArray`
- `atlasFrameUv`
- `normalizeAnimClip`
- `createSpriteAnimationState`
- `currentAnimationClip`
- `clampFrameIndex`
- `switchSpriteAnimationClip`
- `updateSpriteUv`
- `advanceSpriteAnimation`
- `createSpriteMetaEntry`
- `createInitialMetrics`
- `getSpriteMeta`
- `defaultGetKindScale`
- `segmentAtS`
- `segmentAtIndex`
- `elevationAt`
- `groundProfileAt`
- `playerFloorHeightAt`
- `boostZonesOnSegment`
- `playerWithinBoostZone`
- `boostZonesForPlayer`
- `jumpZoneForPlayer`
- `applyBoostImpulse`
- `applyJumpZoneBoost`
- `playerHalfWN`
- `spawnDriftSmokeSprites`
- `spawnSparksSprites`
- `applyDriftSmokeMotion`
- `applySparksMotion`
- `carMeta`
- `carHalfWN`
- `currentPlayerForwardSpeed`
- `npcForwardSpeed`
- `ensureCarNearMissReset`
- `tryRegisterCarNearMiss`
- `computeCollisionPush`
- `configureImpactableSprite`
- `applyImpactPushToSprite`
- `updateImpactableSprite`
- `carHitboxHeight`
- `carHitboxTopY`
- `applyNpcCollisionPush`
- `playerBaseHeight`
- `npcLateralLimit`
- `slopeAngleDeg`
- `slopeLimitRatio`
- `slopeExceedsLimit`
- `cliffSectionExceedsLimit`
- `cliffInfoExceedsLimit`
- `segmentHasSteepCliff`
- `wrapDistance`
- `shortestSignedTrackDistance`
- `nearestSegmentCenter`
- `cliffSurfaceInfoAt`
- `cliffLateralSlopeAt`
- `getAdditiveTiltDeg`
- `updateCameraFromFieldOfView`
- `setFieldOfView`
- `cliffSteepnessMultiplier`
- `applyCliffPushForce`
- `doHop`
- `playerLateralLimit`
- `resolveSpriteInteractionsInSeg`
- `resolveCarCollisionsInSeg`
- `resolveSegmentCollisions`
- `resolveCollisions`
- `updateSpriteAnimations`
- `collectSegmentsCrossed`
- `updatePhysics`
- `clearSegmentCars`
- `spawnCars`
- `steerAvoidance`
- `tickCars`
- `spawnProps`
- `resetPlayerState`
- `respawnPlayerAt`
- `applyDefaultFieldOfView`
- `resetScene`
- `queueReset`
- `queueRespawn`
- `startRaceSession`
- `step`

### 3.5 Sprite Placement, RNG, & Effects (`src/gameplay.js`)
- `splitCsvLine`
- `parseCsvWithHeader`
- `parseNumberRange`
- `parseNumericRange`
- `parseSpritePool`
- `parsePlacementMode`
- `normalizeSeed`
- `createRng`
- `randomInRange`
- `computeAxisScaleWeight`
- `computeAxisAtlasBias`
- `computePlacementBias`
- `biasedRandom01`
- `sampleScaleValue`
- `sampleUniformIndex`
- `sampleBiasedIndex`
- `computeLaneStep`
- `dedupePositions`
- `computeLanePositions`
- `clampSegmentRange`
- `selectAsset`
- `determineInitialFrame`
- `buildSpriteMetaOverrides`
- `generateSpriteInstances`
- `createSpriteFromInstance`
- `loadSpriteCsv`
- `parseSpritePlacements`
- `ensureSpriteDataLoaded`
- `computeDriftSmokeInterval`
- `allocDriftSmokeSprite`
- `recycleDriftSmokeSprite`
- `computeSparksInterval`
- `allocSparksSprite`
- `recycleSparksSprite`
- `recycleTransientSprite`
- `keyActionFromFlag`
- `createKeyHandler`

### 3.6 Track & Environment Management (`src/world.js`)
- `resolveAssetUrl`
- `loadImage`
- `defaultTextureLoader`
- `loadTexturesWith`
- `resetCliffSeries`
- `randomSnowScreenColor`
- `roadWidthAt`
- `addSegment`
- `lastY`
- `addRoad`
- `buildTrackFromCSV`
- `buildCliffsFromCSV_Lite`
- `enforceCliffWrap`
- `pushZone`
- `findZone`
- `vSpanForSeg`
- `clampBoostLane`
- `clampRoadLane`
- `laneToCenterOffset`
- `laneToRoadRatio`
- `getZoneLaneBounds`
- `parseBoostZoneType`
- `parseBoostLaneValue`
- `segmentAtS`
- `elevationAt`
- `cliffParamsAt`
- `cliffSurfaceInfoAt`
- `floorElevationAt`
- `cliffLateralSlopeAt`

### 3.7 Rendering & Camera Systems (`src/render.js`)
- `areTexturesEnabled`
- `randomColorFor`
- `makeColor`
- `applyDeadzone`
- `smoothTowards`
- `atlasUvFromRowCol`
- `computePlayerAtlasSamples`
- `computePlayerSpriteSamples`
- `createPerfTracker`
- `makeFrameStats`
- `beginFrame`
- `endFrame`
- `wrapRenderer`
- `markSolidStart`
- `markSolidEnd`
- `isSolidActive`
- `countDrawCall`
- `registerDrawListSize`
- `registerStrip`
- `registerSprite`
- `registerSnowScreen`
- `registerSnowQuad`
- `registerBoostQuad`
- `registerPhysicsSteps`
- `registerSegment`
- `getLastFrameStats`
- `isSnowFeatureEnabled`
- `numericOr`
- `orderedRange`
- `rangeFromConfig`
- `computeSnowScreenBaseRadius`
- `mulberry32`
- `buildSnowField`
- `ensureSnowFieldPool`
- `snowFieldFor`
- `fogNear`
- `computeOverlayEnabled`
- `syncOverlayVisibility`
- `createPoint`
- `projectWorldPoint`
- `projectSegPoint`
- `padWithSpriteOverlap`
- `computeCliffLaneProgress`
- `fogArray`
- `getTrackLength`
- `projectPoint`
- `makeCliffLeftQuads`
- `makeCliffRightQuads`
- `fogFactorFromZ`
- `spriteFarScaleFromZ`
- `drawParallaxLayer`
- `renderHorizon`
- `drawRoadStrip`
- `drawBoostZonesOnStrip`
- `drawBillboard`
- `drawBillboardRotated`
- `segmentAtS`
- `elevationAt`
- `groundProfileAt`
- `boostZonesOnSegment`
- `zonesFor`
- `renderScene`
- `createCameraFrame`
- `applyCameraTilt`
- `buildWorldDrawList`
- `enqueuePlayer`
- `renderDrawList`
- `renderSnowScreen`
- `renderStrip`
- `renderPlayer`
- `computeDebugPanels`
- `worldToOverlay`
- `drawBoostCrossSection`
- `mapRatio`
- `fmtSeconds`
- `fmtCount`
- `fmtSpeed`
- `fmtFloat`
- `renderOverlay`
- `start`
- `tick`
- `draw`
- `startReset`
- `startRespawn`
- `attach`
- `frame`
- `loop`

### 3.8 WebGL Renderer (`src/gl/renderer.js`)
- `constructor`
- `_createShader`
- `_createProgram`
- `_makeWhiteTex`
- `loadTexture`
- `begin`
- `setRollPivot`
- `drawQuadTextured`
- `drawQuadSolid`
- `makeCircleTex`
- `end`
- `padQuad`
- `makeRotatedQuad`

### 3.9 Sprite Catalog (`src/sprite-catalog.js`)
- `freezeClip`
- `makeFrames`
- `makeAtlasFrameAssets`
- `cloneCatalog`
- `getTextureManifest`
- `getCatalogEntry`
- `getMetrics`

### 3.10 Math Utilities (`src/math.js`)
- `clamp`
- `clamp01`
- `lerp`
- `pctRem`
- `createEaseIn`
- `createEaseOut`
- `createEaseInOut`
- `easeLinear01`
- `easeInQuad01`
- `easeOutQuad01`
- `easeInOutQuad01`
- `easeInCub01`
- `easeOutCub01`
- `easeInOutCub01`
- `createCurveEase`
- `easeLinear`
- `easeInQuad`
- `easeOutQuad`
- `easeInCub`
- `easeOutCub`
- `getEase01`
- `computeCurvature`
- `tangentNormalFromSlope`

### 3.11 Testing Utilities (`test/glrenderer.resize.test.js`)
- `assert`
- `makeRenderer`
- `gl.viewport`
- `gl.clearColor`
- `gl.clear`
- `gl.uniform2f`
- `gl.uniform1i`
- `gl.uniform3f`

## 4. Cleanup Priorities Aligned to Our Goals

### 4.1 Make the Code Easier to Read
- Split giant files like `app.js`, `gameplay.js`, and `world.js` into smaller modules with clear names.
- Add short docs that explain what each module exports and how the pieces connect.
- Use the same naming style everywhere (for example, always `camelCase` for functions and consistent prefixes like `init` or `create`).
- Replace hidden globals with explicit imports and exports so we know where values come from.

### 4.2 Trim Repeated or Unused Code
- Move shared helpers such as HTML escaping or asset URL builders into one place.
- Remove menu states or debug toggles that no longer run.
- Consolidate repeated HTML or sprite templates into reusable builders.

### 4.3 Speed Up Runtime
- Profile the render loop to find slow steps, then batch sprite draws and cut down allocations.
- Cache expensive calculations (segment projections, easing curves, texture lookups) so we do them once per update.
- Limit DOM work by batching menu updates and making sure network requests (like leaderboards) run asynchronously.
- Watch for code that creates lots of short-lived objects and switch to in-place updates where possible.

### 4.4 Future Changes
- Add a persistence step that writes new leaderboard scores back into `data/leaderboard.csv` so every finished race stays tracked after reloads.
