# Outrun Codebase – Cleanup Roadmap (Pass 1 Overview)

## 1. Game Overview
- What it is: A browser racing game with menus, vehicle selection, races, scoreboards, and bonus items.
- Where it runs: In the browser, using WebGL helpers in `src/gl/` to draw the game and normal DOM code for menus.
- What it loads: Settings from `src/config.js`, track data from `tracks/`, sprite info from `src/sprite-catalog.js`, and texture info from `src/world.js`.

## 2. Main Building Blocks

### 2.1 Starting the Game
- `src/bootstrap.js` loads assets, sets up callbacks, and shares helpers across the rest of the code.
- `src/app.js` is the overall game manager. It swaps between menus, races, pause screens, and the scoreboard. It also tracks button presses and animation timing.

### 2.2 Settings and Static Data
- `src/config.js` stores constants such as physics values, track layout numbers, render sizes, and debug toggles.
- `tracks/` holds the CSV files that describe the track layout, hills, and curves.

### 2.3 Math and Helpers
- `src/math.js` is a grab bag of number helpers. It includes easing curves, random helpers, and small math utilities that many files use.

### 2.4 World and Assets
- `src/world.js` creates the in-game world. It builds track segments, sets up cliff data, manages boost zones, and keeps track of textures.

### 2.5 Racing Logic
- `src/gameplay.js` runs the race. It updates car physics, handles collisions, spawns traffic, keeps time, and calls into rendering.

### 2.6 Drawing the Game
- `src/render.js` draws everything on screen. It prepares road geometry, sprites, overlays, and any debug panels each frame.
- `src/gl/` contains the low-level WebGL code for shaders, buffers, and textured quads.

### 2.7 Sprites and Animation
- `src/sprite-catalog.js` defines every sprite sheet, animation frame, and scaling rule for vehicles, roadside props, and UI icons.

### 2.8 Menus and UI
- `src/ui/screens.js` generates the HTML for each menu screen, such as the main menu, pause screen, vehicle select, settings, scoreboard, attract mode, and race complete screens.

### 2.9 Input Handling
- Button handling lives partly in `app.js` (menus) and partly in `gameplay.js` (driving controls). Both listen for key events and update shared input state.

### 2.10 Other Files
- `docs/`, `tex/`, `video/` contain written docs and art references.
- `index.mod.html` is the main HTML shell for the game canvas and menus.
- `monolith-old.txt` is an older architecture reference.

## 3. Function Inventory by Category

### 3.1 Application & Menu Flow (`src/app.js`)
- `createInitialRaceCompleteState`
  - Purpose: Factory for a blank race-complete screen state so menus can start fresh when a race ends or restarts.
  - Inputs: None.
  - Outputs: Object with `active`, `timeMs`, `letters`, `confirmed`, `currentIndex`, `phase`, `timer`, `entryId`, `playerName`, `playerRank`.
  - Side effects: None (pure data builder).
  - Shared state & call sites: Assigned to `state.raceComplete` in `src/app.js:58`, `85`, `739`.
  - Dependencies: No calls.
  - Edge cases: Provides safe defaults (zero time, placeholder name); does not validate external inputs.
  - Performance: Constant-time object creation when menus reset or a race finishes.
  - Units / spaces: `timeMs` in milliseconds.
  - Determinism: Yes—always returns identical data.
  - Keep / change / delete: Keep; simplest alternative is inlining the literal where used.
  - Confidence / assumptions: High confidence; assumes `letters` of `'AAA'` is intended default.
  - Notes: Possible reductions: none spotted; placement in `src/app.js` matches usage via `resetRaceCompleteState`; consider renaming to shorter `inputNameState` for clarity.
- `resetRaceCompleteState`
  - Purpose: Resets the race-finish screen data back to a clean slate so the next race starts with blank initials and zeroed time.
  - Inputs: None.
  - Outputs: None; updates in-place.
  - Side effects: Replaces `state.raceComplete` with fresh defaults, wiping any prior letters, timers, or entry IDs.
  - Shared state & call sites: `state.raceComplete` reassigned; invoked at `src/app.js:232,724,1133`.
  - Dependencies: Calls `createInitialRaceCompleteState`.
  - Edge cases: Covers stale data by always cloning defaults; does not special-case DNF/DQ or preserve existing names.
  - Performance: Constant-time object replacement when leaving the race-complete screen, starting a race, or booting.
  - Units / spaces: Defaults include `timeMs` in milliseconds and name letters in uppercase strings.
  - Determinism: Yes—same empty state every call.
  - Keep / change / delete: Keep; simple helper prevents duplicated setup—alternative is to inline the factory call.
  - Confidence / assumptions: High confidence; assumes no other module mutates `state.raceComplete` directly.
  - Notes: Reviewer noted there were "no notes" and the helper already looks adequate; I concur and suggest only revisiting if future menu reset work reveals redundant copies or missed shared behavior.
- `now`
  - Purpose: Helper that grabs the current timestamp so menu flow can compare idle time without repeating the built-in Date.now call.
  - Inputs: None.
  - Outputs: Number of milliseconds since January 1, 1970 returned from Date.now.
  - Side effects: None; it only reads the system clock.
  - Shared state & call sites: Updates and reads state.lastInteractionAt in src/app.js:93, 1119, 1132 when tracking menu idleness.
  - Dependencies: JavaScript built-in Date.now.
  - Edge cases: Does not guard against someone changing the computer clock or supplying mock timers.
  - Performance: Single native call; negligible cost even when polled for idle checks.
  - Units / spaces: Milliseconds of real-world time.
  - Determinism: Returns whatever the system clock reports, so calls made moments apart differ.
  - Keep / change / delete: Change—either inline Date.now, or keep the helper but rename it getTimeNow and allow injecting a test clock to cut indirection.
  - Confidence / assumptions: High confidence; assumes there are no hidden callers outside this file.
  - Notes: You felt the helper was fine and suggested renaming it to getTimeNow; I still recommend inlining Date.now or accepting an injected clock so tests stay predictable.
- `markInteraction`
  - Purpose: Refreshes the menu idle timer whenever menus or settings detect user activity so attract mode does not trigger unexpectedly.
  - Inputs: None.
  - Outputs: None; the helper only updates the saved timestamp.
  - Side effects: Sets state.lastInteractionAt to the current clock reading.
  - Shared state & call sites: Touches state.lastInteractionAt; invoked in src/app.js:229, 648, 1046, 1067 before mode swaps, race-complete phase changes, and non-race key handling.
  - Dependencies: Calls now(), which wraps the browser clock.
  - Edge cases: No extra handling; assumes the shared state exists and does not guard against clock drift.
  - Performance: Constant-time assignment; runs whenever menu interactions happen.
  - Units / spaces: Timestamp stored in milliseconds since epoch.
  - Determinism: No; each call captures the live clock so repeated calls differ.
  - Keep / change / delete: Keep; central helper prevents repeating the timestamp write.
  - Confidence / assumptions: High confidence; assumes Date.now is available and state was initialized.
  - Notes: Previous helpers here all shape the attract-mode idle timer; reviewer noted we could inline to `Date.now()` or rename `now()` to `getTimeNow`, yet centralizing this clock write still makes the idle-timer maintenance easy if we tweak the attract flow.
- `escapeHtml`
  - Purpose: Converts any incoming menu label or score text into safe HTML so UI templates cannot inject tags or break layout.
  - Inputs: `text` (any value; coerced to string; no length guard but intended for short UI snippets).
  - Outputs: Escaped string with `&`, `<`, `>`, `"`, `'` replaced by HTML entities.
  - Side effects: None; leaves globals, files, and timers untouched.
  - Shared state & use: None touched; passed to screen renderers at `src/app.js:260,287,310,321,341,365`, consumed throughout `src/ui/screens.js:5-193`.
  - Dependencies: Built-in `String` conversion plus chained `replace` calls.
  - Edge cases: Handles `null`/`undefined` by returning `'null'`/`'undefined'`; does not trim, truncate, or detect already-escaped text.
  - Performance: Linear per character; only runs when menus build HTML so cost is minimal.
  - Units / spaces: Plain text; no time or coordinate units involved.
  - Determinism: Same input yields same escaped output; running it twice without changes gives the same string.
  - Keep / change / delete: Keep; simplest alternative is to rely on DOM text nodes via `textContent` instead of manual escaping.
  - Confidence / assumptions: High confidence; assumes menu strings stay reasonably short and mostly plain-language characters.
  - Notes: Reviewer confirmed this helper simply keeps player score initials constrained to safe characters like "ABC" so the menu never sees risky markup, and I agree the current implementation is sound while noting we could later simplify by routing menu strings through shared DOM text-node helpers if we consolidate UI rendering.
- `resolveAssetUrlSafe`
  - Purpose: Wraps the world's asset resolver so menu templates can turn relative preview filenames into usable URLs without crashing if the resolver is missing.
  - Inputs: `path` string; accepts falsy (`''`, `null`, `undefined`) and any other value, though only non-empty strings resolve meaningfully.
  - Outputs: Returns the resolved string from `World.resolveAssetUrl(path)` or the original `path`; falls back to `''` when the input is falsy.
  - Side effects: None—no writes to state, storage, or logs; only calls the global resolver when available.
  - Shared state & call sites: Reads global `World` (`src/app.js:105-114`); passed to `AppScreens.vehicleSelect` as `resolveAssetUrl` helper (`src/app.js:331-341`).
  - Dependencies: `World.resolveAssetUrl` when defined; otherwise none.
  - Edge cases: Handles missing/falsey paths, missing resolver, and exceptions thrown by the resolver; does not validate URL format or strip whitespace.
  - Performance: Constant time; called when building vehicle select screen renders.
  - Units / spaces: Operates on raw URL/path strings; no coordinate spaces.
  - Determinism: Deterministic for the same `World.resolveAssetUrl` implementation and input; returning input unchanged if resolver state changes between calls.
  - Keep / change / delete: Keep; simplest tweak would be to inline a null-safe resolver but helper keeps template call clean.
  - Confidence / assumptions: High confidence; assumes `World` global remains stable and resolver returns a string.
  - Notes: Possible reductions include inlining the null-check if we ever centralize asset helpers or renaming to `safeResolveAssetUrl` so its guard role is clearer. Reviewer summary: “Uses `escapeHtml` so filenames render despite odd characters?” Clarification: this helper never touches HTML escaping and instead just delegates to `World.resolveAssetUrl`, so unusual characters flow through unchanged unless the resolver rewrites them. Future update could link it with a path sanitizer if we discover malformed inputs.
- `normalizePreviewAtlas`
  - Purpose: Convert optional preview sprite sheet settings into a safe atlas description for the vehicle preview.
  - Inputs: `raw` object with `columns`, `rows`, `frameCount`, `frameRate`, `frameDuration`; expects positive numbers or empty.
  - Outputs: Object with positive `columns`, `rows`, `frameCount`, `frameDuration` seconds, or `null` when data is unusable.
  - Side effects: None; only reads the default frame duration constant.
  - Shared state & call sites: Used by `renderVehicleSelect` in `src/app.js:339`; does not mutate shared state.
  - Dependencies: Basic math helpers (`Number`, `Math`) and `DEFAULT_VEHICLE_PREVIEW_FRAME_DURATION`.
  - Edge cases: Fills missing counts from other fields, derives duration from frame rate, returns `null` on non-positive or absent data.
  - Performance: Constant-time arithmetic when building the menu model; no loops beyond a handful of checks.
  - Units / spaces: Frame duration measured in seconds; counts represent frame totals; independent of render frame rate.
  - Determinism: Yes; same input produces the same atlas and no persistent changes.
  - Keep / change / delete: Keep; consolidates validation that would otherwise live inside `renderVehicleSelect`.
  - Confidence / assumptions: High confidence; assumes preview atlas configs stay small and numeric.
  - Notes: Reviewer summarized this as the helper that lets `renderVehicleSelect` slice the preview atlas, then asked whether it should merge with the atlas animation handler used by player vehicles and animated billboards; keep it separate for now because the preview path needs unique defaults, null returns, and timing fallbacks, but queue a follow-up to lift the shared frame math if those pipelines ever align.
- `formatTimeMs`
  - Purpose: Converts a raw millisecond count into a friendly label for menus and scoreboards so players see human-readable times.
  - Inputs: `value` (number in milliseconds; accepts any finite number, clamps negatives to zero, ignores non-finite values).
  - Outputs: String like `'12,345 ms'` or `'--'` when the input is not a usable number.
  - Side effects: None; computes and returns a string without mutating data or logging.
  - Shared state & call sites: Used for leaderboard entries at `src/app.js:182` and race-complete label at `src/app.js:353`.
  - Dependencies: Built-ins `Number.isFinite`, `Math.round`, `Math.max`, `toLocaleString`.
  - Edge cases: Handles non-finite values by returning `'--'` and clamps negatives to zero; does not distinguish DNF/DQ or preserve fractional milliseconds.
  - Performance: Constant-time number formatting when leaderboard rows build or race results render.
  - Units / spaces: Treats input as milliseconds and formats a locale-aware millisecond string.
  - Determinism: Pure for a fixed locale—same input yields the same formatted string; running again has no extra effects.
  - Keep / change / delete: Keep; smallest alternative would be inlining the formatting string where used.
  - Confidence / assumptions: High confidence; assumes default locale formatting is acceptable for all displays.
  - Notes: Reviewer praised the explanation and restated that the helper simply turns raw milliseconds into something readable while asking if we duplicate this logic elsewhere, and my follow-up confirmed the formatter appears only in `src/app.js` today. Should another menu or HUD pathway need the same presentation, we can lift this helper into a shared time-formatting module so we do not drift on style.
- `createLeaderboardEntry`
  - Purpose: Builds a leaderboard row with cleaned initials, numeric time, formatted label, saved date, and empty rank.
  - Inputs: Name text trimmed to three uppercase letters, scoreMs finish time in milliseconds with non-numbers treated as 0, optional date string defaulting to blank.
  - Outputs: Object holding a unique id, cleaned name, raw score, formatted display string, provided date, and null rank.
  - Side effects: None; only makes and returns new data.
  - Shared state touched and where it’s used: No direct shared state; called at src/app.js:212 (local add) and src/app.js:850 (CSV import).
  - Dependencies: Uses formatTimeMs for the display string.
  - Edge cases handled or missed: Covers empty names and non-numeric scores; allows negative scores (shown as 0 ms) and ignores DNF/DQ notes or tie rules beyond later sorting.
  - Performance: Constant-time string and number cleanup when leaderboard entries are made.
  - Units/spaces: Treats scores as milliseconds and display text suffixed with “ms”.
  - Determinism: Fields repeat for the same inputs except for a new unique id each call.
  - Keep / change / delete: Keep; alternative is to inline the object build at the two use sites.
  - Confidence / assumptions: High confidence; assumes the board expects three-letter uppercase initials and millisecond scores.
  - Notes: Reviewer asked, “What actually updates the entry in the .csv file?”—right now nothing writes back, because entries only live in memory while `fetch('data/leaderboard.csv')` seeds the list; if persistence ever arrives we could fold this helper into a loader/saver module or attach a dedicated save routine, but until then the clearest update is to document that gap.
- `recomputeLeaderboardRanks`
  - Purpose: Walks the current leaderboard list and stamps each non-empty entry with its 1-based place so the menu can show accurate ranks after sorting or CSV import.
  - Inputs: `entries` array (defaults to `state.leaderboard.entries`); expects objects shaped like `createLeaderboardEntry`; ignores falsy slots.
  - Outputs: None returned; updates each entry's `rank` property in place.
  - Side effects: Mutates the provided entries; when called with the default, writes directly into shared leaderboard state.
  - Shared state & call sites: Touches `state.leaderboard.entries`; invoked after sorting in `src/app.js:203` and after CSV parsing in `src/app.js:863`.
  - Dependencies: No subordinate calls.
  - Edge cases: Skips holes/nulls but still leaves prior rank on those slots; does not adjust for tied scores beyond list order.
  - Performance: Linear pass over the array whenever leaderboard data changes; trivial cost compared with sorting/loading frequency.
  - Units / spaces: Ranks are simple 1-based integers.
  - Determinism: Deterministic for a fixed input order; repeating without changes is idempotent.
  - Keep / change / delete: Keep; could fold into `sortLeaderboardEntries` but shared reuse by CSV import makes the helper worthwhile.
  - Confidence / assumptions: High confidence; assumes callers already sorted entries and that sparse arrays are rare.
  - Notes: Reviewer summary: "looks good, no notes, likely no need to fold"; I concur and would only revisit consolidation if future refactors merge leaderboard sorting and ranking into a single pass, so keep monitoring but no action required now.
- `sortLeaderboardEntries`
  - Purpose: Keeps the leaderboard ordered so faster times float to the top, currently breaking ties alphabetically for display.
  - Inputs: None explicitly; reads `state.leaderboard.entries` which should contain objects with `score` numbers and `name` strings.
  - Outputs: None; entries end up sorted and re-ranked in place.
  - Side effects: Mutates `state.leaderboard.entries`, updates each entry’s `rank`, and drives highlight behavior after sorting.
  - Shared state & call sites: Touches `state.leaderboard.entries`/`rank`; invoked from `src/app.js:215` after adding a local score and `src/app.js:815` after loading remote scores.
  - Dependencies: Uses Array sort plus `recomputeLeaderboardRanks` to refresh rank numbers.
  - Edge cases: Skips over missing entries, pushes null/undefined records to the end, and resolves equal scores with a name comparison despite not honoring play date order; does not special-case DNFs or impossible scores.
  - Performance: Native Array sort over the current entries list; only runs on leaderboard updates, not every frame.
  - Units / spaces: Compares `score` values measured in milliseconds.
  - Determinism: Yes—same entry data yields the same order and ranks.
  - Keep / change / delete: Keep; could only be inlined alongside the rank refresh at each call site.
  - Confidence / assumptions: High confidence; assumes entries always provide numeric `score` and uppercase `name`.
  - Notes: Reviewer: "Alphabetical ordering on equal scores feels wrong; should favor newer runs so the recent score rises above." Response: Capture a precise play timestamp on each entry and update the comparator to sort by score then newest-first, keeping name as a final fallback so expectations and ranking stay aligned.
- `findLeaderboardEntryIndexById`
  - Purpose: Finds where a saved leaderboard entry sits in the current list so menus can highlight the right racer.
  - Inputs: id (stored entry identifier, usually created when adding to the leaderboard; must be provided).
  - Outputs: Returns the zero-based position in the leaderboard list, or -1 when the id is missing or not found.
  - Side effects: None; only reads shared data.
  - Shared state & call sites: Reads state.leaderboard.entries array sorted in src/app.js:199-205 and appended in src/app.js:212-215; defined in src/app.js:206-210.
  - Dependencies: Uses the built-in findIndex helper on arrays; no other modules.
  - Edge cases: Skips falsy ids and empty slots but does not detect duplicate ids or symbols that no longer exist.
  - Performance: Linear scan of the current entries list; called only when highlight lookup is needed.
  - Units / spaces: Works in array positions; no time or spatial units.
  - Determinism: Same id and state yield the same index; repeated calls do not change data.
  - Keep / change / delete: Keep; lightweight helper that could be folded into leaderboard lookup code if refactored.
  - Confidence / assumptions: High confidence, assuming entries retain their id values.
- `addLeaderboardEntry`
- setMode
  - Purpose: Switches the app between race, menu, attract, and other screens so the right panel is shown and menu focus resets.
  - Inputs: nextMode text label for the target screen; expects known modes such as menu, playing, paused, leaderboard, settings, vehicleSelect, raceComplete, attract; empty or same-as-current values are ignored.
  - Outputs: None returned; function ends after updating shared state and refreshing the menu panel.
  - Side effects: Updates state.mode, zeroes menu indexes when starting play, records the latest interaction time for non-play screens, clears race-complete data when leaving that view, and triggers a fresh menu render.
  - Shared state touched and where it’s used: state.mode plus menu index fields, state.lastInteractionAt (via markInteraction), state.raceComplete (via reset) and menu DOM references; callers at src/app.js:589, 683, 725, 746, 750, 755, 759, 763, 796, 900, 936, 960, 1037, 1054, 1136.
  - Dependencies: markInteraction to refresh the idle timer, resetRaceCompleteState for cleanup, updateMenuLayer to rebuild the visible menu.
  - Edge cases: Ignores falsy mode requests and duplicate mode switches; does not validate unknown mode strings or guard against raceComplete being null.
  - Performance: Constant-time state tweaks plus one menu redraw; only runs when some other action changes screens, not every frame.
  - Units/spaces: Idle timer uses milliseconds when markInteraction runs; all other updates are unitless toggles or zeroed counters.
  - Determinism: Given the same starting state and nextMode, the resulting state changes are predictable; repeated calls with the current mode exit immediately.
  - Keep / change / delete: Keep; central gateway for screen changes, simplest alternative would be splitting into separate per-mode helpers and duplicating logic.
  - Confidence / assumptions: High confidence; assumes updateMenuLayer keeps menus in sync and that callers pass the supported mode names.
  - Purpose: Records a just-finished run on the high-score board by packaging the player initials, time, and today’s date, then reorders the list so the new result appears in place immediately.
  - Inputs: `name` (player-entered initials; trimmed, uppercased, limited to three characters, defaults to `---`); `scoreMs` (finish time in milliseconds; non-finite values fall back to 0).
  - Outputs: Returns the newly minted entry object containing a unique `id` symbol, normalized `name`, numeric `score`, formatted `displayValue`, ISO date stamp, and updated `rank` once sorted.
  - Side effects: Appends to `state.leaderboard.entries` and `.localEntries`, re-sorts the leaderboard (which mutates ranks), stamps the current date, and points `state.leaderboard.highlightId` at the new entry for UI emphasis.
  - Shared state & call sites: Touches `state.leaderboard.entries`, `.localEntries`, and `.highlightId` defined in `src/app.js:55-57`; invoked from `src/app.js:638` when a race completion is finalized.
  - Dependencies: Calls `createLeaderboardEntry` for normalization/formatting, `sortLeaderboardEntries` to reorder ranks, and uses `new Date().toISOString()` for the daily stamp.
  - Edge cases: Handles blank names and invalid times via defaults; does not prevent duplicate submissions, oversized leaderboards, or special cases like DNFs/ties beyond alphabetical ordering.
  - Performance: Triggers an array push plus an `Array.sort` (O(n log n)); runs only upon recording a new local result, not every frame.
  - Units / spaces: Works with times measured in milliseconds and stores dates as `YYYY-MM-DD` strings; positions correspond to leaderboard rank order.
  - Determinism: Non-deterministic because it stamps the current date and creates a fresh `Symbol` id; calling twice with the same input produces distinct entries.
  - Keep / change / delete: Keep; consider renaming to `recordLocalLeaderboardEntry` to clarify that it mutates local state.
  - Confidence / assumptions: High confidence; assumes `state.leaderboard` exists with initialized `entries` and `localEntries` arrays and that sorting stays consistent.
- `setMode`
- `ensureDom`
  - Purpose: Verifies the menu layer elements exist on the page and saves quick references so later menu updates do not crash.
  - Inputs: Document (current web page; must contain an element with id appMenuLayer); state.dom.menuLayer and state.dom.menuPanel (may be empty on first run).
  - Outputs: Returns nothing; fills state.dom.menuLayer and state.dom.menuPanel with the found elements.
  - Side effects: Throws errors if elements are missing; writes the cached elements into shared state.
  - Shared state touched and where it’s used: Updates state.dom.menuLayer/menuPanel defined at src/app.js:237-248; invoked at src/app.js:392 and src/app.js:1128 before menu rendering and app init.
  - Dependencies: Uses the browser’s built-in element lookup helpers.
  - Edge cases handled or missed: Stops early when elements already saved; throws if elements are absent; does not handle the elements being replaced later.
  - Performance: Two element searches the first time it runs; afterwards the early return avoids extra work.
  - Units / spaces: Works with web page elements only; no numeric units involved.
  - Determinism: Given the same page structure it will always cache the same nodes; reruns do not change anything once stored.
  - Keep / change / delete: Keep; simple guard that could be merged into menu setup if caching is refactored.
  - Confidence / assumptions: High confidence; assumes the menu markup is present before init runs.
- `renderMainMenu`
  - Purpose: Builds the main menu markup by delegating to the shared AppScreens template with the game title, tagline, and current option highlight so the menu panel can be redrawn in one call.【F:src/app.js†L251-L261】
  - Inputs: Reads AppScreens.mainMenu (UI renderer; must be truthy), mainMenuOptions (static list of "Start Race", "Leaderboard", "Settings" entries), and state.mainMenuIndex (current highlight; expected 0–options.length-1).【F:src/app.js†L8-L12】【F:src/app.js†L251-L259】
  - Outputs: Returns the HTML/string produced by AppScreens.mainMenu, which receives title, subtitle, options, and selectedIndex fields.【F:src/app.js†L251-L261】
  - Side effects: None; pure read of state and globals, no DOM writes or state mutation.【F:src/app.js†L251-L261】
  - Shared state & call sites: Reads state.mainMenuIndex initialized in state object and is invoked from updateMenuLayer when state.mode === 'menu'.【F:src/app.js†L42-L65】【F:src/app.js†L401-L404】
  - Dependencies: Calls AppScreens.mainMenu and reuses escapeHtml helper passed as renderer utilities.【F:src/app.js†L251-L261】
  - Edge cases: Returns an empty string when AppScreens.mainMenu is absent, but does not clamp out-of-range selectedIndex or null options.【F:src/app.js†L251-L259】
  - Performance: Constant-time work allocating one object; only runs when updateMenuLayer refreshes the menu (mode changes or interactions).【F:src/app.js†L251-L261】【F:src/app.js†L391-L418】
  - Units / spaces: Works with array indices for menu options; no timing or spatial units involved.【F:src/app.js†L251-L259】
  - Determinism: Given the same state and AppScreens.mainMenu implementation it returns the same markup; no randomness or timers.【F:src/app.js†L251-L261】
  - Keep / change / delete: Keep; thin wrapper keeps updateMenuLayer tidy and could be merged there only if menus are restructured.【F:src/app.js†L251-L261】【F:src/app.js†L401-L404】
  - Confidence / assumptions: High confidence; assumes AppScreens.mainMenu synchronously returns a renderable string.【F:src/app.js†L251-L261】
- `renderLeaderboard`
  - Purpose: Builds the leaderboard screen markup so players can see the top race times and any highlighted recent run.
  - Inputs: No arguments; reads `state.leaderboard.loading`, `error`, `entries`, and `highlightId` (highlight id may be null).
  - Outputs: Returns an HTML string via `AppScreens.leaderboard`, feeding it an array of up to ten `{ rank, name, score, isHighlight }` rows.
  - Side effects: None; it only derives data for rendering.
  - Shared state & call sites: Reads the leaderboard slice of `state`; called by `updateMenuLayer` when `state.mode === 'leaderboard'` (`src/app.js:404`).
  - Dependencies: Delegates to `AppScreens.leaderboard` and passes the local `escapeHtml` helper for safe text output.
  - Edge cases: Falls back to an empty string if the template is missing, keeps blank placeholder rows for null entries, but still ignores DNFs, ties beyond ordering, or runs past the top ten.
  - Performance: Copies and maps at most ten entries per render; only invoked when the menu swaps into leaderboard mode.
  - Units / spaces: Displays `entry.displayValue` strings already formatted in milliseconds and flags highlights with booleans.
  - Determinism: Yes—given the same leaderboard state it produces the same HTML.
  - Keep / change / delete: Keep; simplest tweak would be to share the top-ten limit as a named constant if reuse expands.
  - Confidence / assumptions: High confidence; assumes upstream code keeps `displayValue` current and entries sorted.
- `renderSettings`
  - Purpose: Builds the settings menu text so players see the snow toggle and the back option.
  - Inputs: None directly; reads snowEnabled (expected boolean) and settingsMenuIndex (expected 0–1) from shared state when called.
  - Outputs: Menu text returned by AppScreens.settingsMenu, or an empty string if that screen builder is missing.
  - Side effects: None; it only reads shared values.
  - Shared state touched and where it’s used: Reads state.settings.snowEnabled and state.settingsMenuIndex; invoked by updateMenuLayer at src/app.js:406.
  - Dependencies: Uses AppScreens.settingsMenu and the local escapeHtml function to format labels.
  - Edge cases handled or missed: Skips safely when AppScreens.settingsMenu is absent; does not guard against the settings object being missing or new menu options being added elsewhere.
  - Performance: Constant-time creation of two menu entries; runs only when the menu layer refreshes.
  - Units / spaces: No numeric units; all values are plain menu labels.
  - Determinism: Same state values return the same markup; repeated calls do not change any data.
  - Keep / change / delete: Keep; separation keeps each menu renderer focused, simplest alternative would be merging into a generic renderMenu function.
  - Confidence / assumptions: High confidence; assumes the state always includes the snow flag and menu index.
- `renderPauseMenu`
  - Purpose: Builds the pause overlay markup so the player sees the resume and quit choices whenever play is halted.
  - Inputs: `AppScreens.pauseMenu` template function must exist; `pauseMenuOptions` list of two menu entries (`resume`, `quit`); `state.pauseMenuIndex` zero-based position expected between 0 and options length minus one.
  - Outputs: Returns the pause menu HTML string with the options array and the currently highlighted index passed through.
  - Side effects: None; only reads globals.
  - Shared state touched and call sites: Reads `pauseMenuOptions` (src/app.js:14-17) and `state.pauseMenuIndex` (src/app.js:42-46); invoked inside `updateMenuLayer` when `state.mode === 'paused'` (src/app.js:391-409); index mutated by `changePauseMenuSelection` (src/app.js:533-537), `setMode` (src/app.js:220-235), and `init` (src/app.js:1127-1136).
  - Dependencies: Calls `AppScreens.pauseMenu` with the local `escapeHtml` helper for safe text output.
  - Edge cases: Falls back to an empty string when the pause screen template is missing; otherwise expects the options array to contain entries and does not guard against an out-of-range index (resulting in no item selected).
  - Performance: Maps over two static menu options; runs only when the menu layer redraws during pause transitions or navigation.
  - Units/spaces: Uses zero-based menu positions; no time or world coordinates involved.
  - Determinism: Same inputs and state produce the same markup; repeated calls do not alter data.
  - Keep / change / delete: Keep; already minimal wrapper that could merge into a broader screen renderer during a larger refactor.
  - Confidence / assumptions: High confidence, assuming the global screen renderer keeps returning deterministic markup.
-`renderVehicleSelect`
  - Purpose: Builds the vehicle selection screen model so the menu shows the current carchoice with its name, description, and preview art.
  - Inputs: Reads state.vehicleSelectIndex (any integer, wrapped to the option list) andvehicleOptions entries (array that may be empty).
  - Outputs: HTML string from AppScreens.vehicleSelect with fields title, vehicleLabel,vehicleDescription, optionIndex, optionCount, previewSrc, previewAtlas.
  - Side effects: None; only reads data and calls the renderer.
  - Shared state & call sites: Reads state.vehicleSelectIndex; invoked by updateMenuLayerwhen mode equals "vehicleSelect" at src/app.js:410.
  - Dependencies: AppScreens.vehicleSelect, clampIndex, normalizePreviewAtlas,resolveAssetUrlSafe, escapeHtml.
  - Edge cases: Returns an empty string if the template is missing, wraps negative oroversized indexes, falls back to the first option or blanks when the list is empty, butdoes not handle DNF/DQ flags or malformed preview data beyond nulling it out.
  - Performance: Constant work per call; runs when the menu layer rerenders after mode orselection changes.
  - Units / spaces: optionIndex is zero-based, optionCount is the total options, previewAtlasframe duration is measured in seconds for the sprite.
  - Determinism: Same state and options yield the same HTML and no persistent changes.
  - Keep / change / delete: Keep; simplest alternative is inlining the AppScreens call insideupdateMenuLayer.
  - Confidence / assumptions: High confidence; assumes AppScreens.vehicleSelect returns astring and the vehicle option list stays small.
- `renderAttract`
  - Purpose: Builds the attract-mode panel so the menu layer can show a looping promo video when the player idles.【F:src/app.js†L345-L347】【F:src/app.js†L391-L432】
  - Inputs: No parameters; depends on `AppScreens.attract` existing in the global template bundle.【F:src/app.js†L345-L347】
  - Outputs: Returns the markup from `AppScreens.attract`, populated with `{ videoSrc: 'video/attract-loop.mp4' }`.【F:src/app.js†L345-L347】
  - Side effects: None; simply forwards data to the template and leaves DOM/state untouched.【F:src/app.js†L345-L347】
  - Shared state touched and where it’s used: Touches no shared state; invoked by `updateMenuLayer` whenever `state.mode` switches to `'attract'`.【F:src/app.js†L391-L432】
  - Dependencies: Calls `AppScreens.attract` and relies on `updateMenuLayer` for DOM insertion.【F:src/app.js†L345-L347】【F:src/app.js†L391-L432】
  - Edge cases handled or missed: Falls back to an empty string if the template is missing; does not verify that the referenced video asset loads successfully.【F:src/app.js†L345-L347】
  - Performance: Constant-time string construction; runs only during attract-mode renders.【F:src/app.js†L345-L347】【F:src/app.js†L391-L432】
  - Units / spaces: Works solely with a relative media path; no numeric units.【F:src/app.js†L345-L347】
  - Determinism: Given the same template, returns the same markup and causes no persistent changes.【F:src/app.js†L345-L347】
  - Keep / change / delete: Keep; small wrapper keeps attract rendering logic isolated from `updateMenuLayer`.【F:src/app.js†L345-L347】【F:src/app.js†L391-L432】
  - Confidence / assumptions: High confidence; assumes the template synchronously returns HTML that `updateMenuLayer` will inject.【F:src/app.js†L345-L347】【F:src/app.js†L391-L432】

- `renderRaceComplete`
  - Purpose: Produces the race-complete overlay showing run stats, initials entry state, and reveal phases after a finish.【F:src/app.js†L350-L367】
  - Inputs: No parameters; reads `state.raceComplete` (active flag, phase, letters, confirmations, index, rank) and formats `timeMs` via `formatTimeMs` (non-finite values show as `--`).【F:src/app.js†L42-L65】【F:src/app.js†L166-L170】【F:src/app.js†L350-L364】
  - Outputs: Returns the `AppScreens.raceComplete` markup with `{ active, phase, timeLabel, letters, confirmed, currentIndex, playerRank }`.【F:src/app.js†L350-L367】
  - Side effects: None; performs pure reads and delegates to the template.【F:src/app.js†L350-L367】
  - Shared state touched and where it’s used: Reads the race-complete slice and is called by `updateMenuLayer` when the mode is `'raceComplete'`.【F:src/app.js†L42-L65】【F:src/app.js†L350-L367】【F:src/app.js†L391-L414】
  - Dependencies: Uses `AppScreens.raceComplete`, the local `escapeHtml` helper, and `formatTimeMs` for display formatting.【F:src/app.js†L166-L170】【F:src/app.js†L350-L367】
  - Edge cases handled or missed: Gracefully handles invalid times through `formatTimeMs`, but assumes `letters`/`confirmed` arrays remain aligned and populated elsewhere.【F:src/app.js†L166-L170】【F:src/app.js†L350-L364】
  - Performance: Constant-time object assembly; invoked only when redrawing the race-complete UI.【F:src/app.js†L350-L367】【F:src/app.js†L391-L414】
  - Units / spaces: Displays milliseconds as formatted strings; no spatial units.【F:src/app.js†L166-L170】【F:src/app.js†L350-L364】
  - Determinism: Same state yields identical markup and no side effects.【F:src/app.js†L350-L367】
  - Keep / change / delete: Keep; isolates template wiring from the menu update loop.【F:src/app.js†L350-L367】【F:src/app.js†L391-L414】
  - Confidence / assumptions: High confidence; assumes upstream code maintains `state.raceComplete` consistency.【F:src/app.js†L42-L65】【F:src/app.js†L350-L367】

- `startAttractPlayback`
  - Purpose: Configures and starts the attract-mode `<video>` element whenever the attract screen loads.【F:src/app.js†L369-L377】
  - Inputs: `video` — DOM video element; ignored when falsy.【F:src/app.js†L369-L377】
  - Outputs: No return; kicks off asynchronous playback on the element.【F:src/app.js†L369-L377】
  - Side effects: Sets `loop`, `muted`, and `playsInline` on the video, then calls `play()` while suppressing autoplay promise rejections.【F:src/app.js†L369-L377】
  - Shared state touched and where it’s used: Does not touch `state`; `updateMenuLayer` passes in the queried element when mode switches to attract.【F:src/app.js†L391-L432】
  - Dependencies: Relies on browser media APIs and the surrounding DOM lookup in `updateMenuLayer`.【F:src/app.js†L369-L377】【F:src/app.js†L391-L427】
  - Edge cases handled or missed: Safely no-ops without an element and mutes by default, but cannot force playback when browsers require interaction despite muting.【F:src/app.js†L369-L377】
  - Performance: Constant-time attribute writes; runs only during attract setup.【F:src/app.js†L369-L377】【F:src/app.js†L391-L427】
  - Units / spaces: Works with media playback state; no numeric units.【F:src/app.js†L369-L377】
  - Determinism: Given the same element it always applies the same configuration, though actual playback depends on browser policy.【F:src/app.js†L369-L377】
  - Keep / change / delete: Keep; keeps media setup separate from DOM querying logic.【F:src/app.js†L369-L377】【F:src/app.js†L391-L427】
  - Confidence / assumptions: High confidence; assumes callers pass an `HTMLVideoElement` and muted autoplay is permitted.【F:src/app.js†L369-L377】

- `stopAttractPlayback`
  - Purpose: Pauses and rewinds the cached attract video when exiting attract mode so it restarts cleanly next time.【F:src/app.js†L380-L388】
  - Inputs: None; reads `state.dom.attractVideo` for the stored element reference.【F:src/app.js†L42-L65】【F:src/app.js†L380-L388】
  - Outputs: No return value.【F:src/app.js†L380-L388】
  - Side effects: Calls `pause()` inside a `try/catch` and resets `currentTime` to `0`, tolerating DOM exceptions from detached media elements.【F:src/app.js†L380-L388】
  - Shared state touched and where it’s used: Reads and relies on `state.dom.attractVideo`; `updateMenuLayer` invokes it on every non-attract redraw before clearing the cached reference.【F:src/app.js†L42-L65】【F:src/app.js†L391-L432】
  - Dependencies: Requires the DOM reference tracked by `updateMenuLayer`; no other helpers.【F:src/app.js†L380-L388】【F:src/app.js†L391-L432】
  - Edge cases handled or missed: Gracefully handles missing elements and ignores pause errors; does not await asynchronous pause completion (not needed for UI).【F:src/app.js†L380-L388】
  - Performance: Constant-time cleanup; executed only when leaving attract mode.【F:src/app.js†L380-L388】【F:src/app.js†L391-L432】
  - Units / spaces: Media time in seconds when rewinding to 0; no spatial units.【F:src/app.js†L380-L388】
  - Determinism: Always resets playback state when an element exists; repeated calls keep the video at the start frame.【F:src/app.js†L380-L388】
  - Keep / change / delete: Keep; complements `startAttractPlayback` to avoid stale playback state.【F:src/app.js†L380-L388】【F:src/app.js†L391-L432】
  - Confidence / assumptions: High confidence; assumes only one attract video is tracked via `state.dom`.【F:src/app.js†L42-L65】【F:src/app.js†L380-L388】

- `updateMenuLayer`
  - Purpose: Rebuilds the menu overlay—toggling visibility, rendering the screen for the current mode, and wiring preview/attract media after every UI state change.【F:src/app.js†L391-L432】
  - Inputs: No parameters; reads `state.mode` and cached DOM references (`state.dom.menuLayer`, `state.dom.menuPanel`), calling `ensureDom` to populate them lazily.【F:src/app.js†L220-L249】【F:src/app.js†L391-L432】
  - Outputs: No return; writes HTML into `menuPanel.innerHTML` and updates CSS classes/data attributes on the menu wrapper.【F:src/app.js†L391-L432】
  - Side effects: Mutates DOM classes, datasets, and `state.dom.attractVideo`, and triggers preview/attract helpers to manage media playback.【F:src/app.js†L391-L432】
  - Shared state touched and where it’s used: Reads/writes `state.dom` and depends on `state.mode`; invoked after every mode or selection mutation (`setMode`, `change*Selection`, `changeVehicleSelection`, race-complete letter handlers, `setRaceCompletePhase`, `toggleSnowSetting`, `toggleDebugSetting`, and leaderboard fetch updates).【F:src/app.js†L42-L65】【F:src/app.js†L220-L235】【F:src/app.js†L527-L709】【F:src/app.js†L604-L649】【F:src/app.js†L686-L709】【F:src/app.js†L800-L828】
  - Dependencies: Calls `ensureDom`, screen renderers (`renderMainMenu`, `renderLeaderboard`, `renderSettings`, `renderPauseMenu`, `renderVehicleSelect`, `renderAttract`, `renderRaceComplete`), `setupVehiclePreviewAnimation`, `startAttractPlayback`, and `stopAttractPlayback`.【F:src/app.js†L220-L432】
  - Edge cases handled or missed: Throws if required DOM nodes are missing via `ensureDom`; relies on each renderer to guard absent templates; always resets `innerHTML` (no diffing).【F:src/app.js†L220-L432】
  - Performance: Performs full DOM replacement per call and media queries; triggered on discrete events rather than every frame, so costs stay manageable.【F:src/app.js†L220-L432】【F:src/app.js†L800-L828】
  - Units / spaces: Operates entirely in DOM space; no numeric world units.【F:src/app.js†L391-L432】
  - Determinism: With the same state and templates it produces identical markup and side effects.【F:src/app.js†L220-L432】
  - Keep / change / delete: Keep; central coordination point for menu rendering that could only be split after modularizing UI layers.【F:src/app.js†L220-L432】
  - Confidence / assumptions: High confidence; assumes `ensureDom` succeeds and renderers remain synchronous.【F:src/app.js†L220-L432】

- `applyVehiclePreviewFrame`
  - Purpose: Computes atlas UV offsets for the vehicle preview sprite and updates the element’s background position for the current frame.【F:src/app.js†L434-L443】
  - Inputs: `preview` descriptor containing `{ element, columns, rows, frameCount, frameIndex }`; no-ops on falsy objects or missing elements.【F:src/app.js†L434-L443】
  - Outputs: No return; writes `backgroundPosition` on the element.【F:src/app.js†L434-L443】
  - Side effects: Mutates the preview element’s inline styles to display the selected atlas cell.【F:src/app.js†L434-L443】
  - Shared state touched and where it’s used: Does not touch `state`; called by preview setup and per-frame advance routines that manage `state.dom.vehiclePreview`.【F:src/app.js†L492-L518】
  - Dependencies: Works with the descriptor produced by `setupVehiclePreviewAnimation` and simple arithmetic only.【F:src/app.js†L434-L493】
  - Edge cases handled or missed: Wraps indices safely, handles single-frame sprites by setting 0% offsets, but assumes the element has a mutable `style`.【F:src/app.js†L434-L443】
  - Performance: Constant-time math; invoked once on setup and whenever the animation advances.【F:src/app.js†L434-L518】
  - Units / spaces: Expresses UVs as CSS percentages across atlas columns/rows.【F:src/app.js†L434-L443】
  - Determinism: Same descriptor and frame index produce the same CSS coordinates.【F:src/app.js†L434-L443】
  - Keep / change / delete: Keep; keeps atlas math separate from higher-level animation logic.【F:src/app.js†L434-L518】
  - Confidence / assumptions: High confidence; assumes DOM mutations succeed while the element is connected.【F:src/app.js†L434-L443】

- `setupVehiclePreviewAnimation`
  - Purpose: Locates the vehicle preview element, normalizes atlas metadata, and seeds animation state in `state.dom.vehiclePreview` after rendering the vehicle select screen.【F:src/app.js†L446-L493】
  - Inputs: No parameters; reads `state.mode`, `state.dom.menuPanel`, and element data attributes (`data-columns`, `data-rows`, `data-frame-count`, `data-frame-duration`).【F:src/app.js†L42-L65】【F:src/app.js†L446-L472】
  - Outputs: Stores a descriptor `{ element, columns, rows, frameCount, frameDuration, frameIndex, accumulator }` in `state.dom.vehiclePreview`, or clears it when preview data is missing.【F:src/app.js†L42-L65】【F:src/app.js†L446-L493】
  - Side effects: Adjusts preview element CSS (`backgroundSize`, `backgroundRepeat`, `backgroundPosition`) and updates shared DOM state.【F:src/app.js†L42-L65】【F:src/app.js†L446-L493】
  - Shared state touched and where it’s used: Writes `state.dom.vehiclePreview`; `updateMenuLayer` invokes it after injecting vehicle select markup.【F:src/app.js†L42-L65】【F:src/app.js†L420-L493】
  - Dependencies: Uses dataset parsing, the global default `DEFAULT_VEHICLE_PREVIEW_FRAME_DURATION`, and `applyVehiclePreviewFrame` to paint the first frame.【F:src/app.js†L40-L493】
  - Edge cases handled or missed: Handles missing panel, absent preview element, invalid numbers, and static sprites by clearing state and resetting background; assumes background images are available externally.【F:src/app.js†L446-L493】
  - Performance: Runs query selectors and simple math per menu refresh; only triggered when the vehicle select UI is rendered.【F:src/app.js†L446-L493】
  - Units / spaces: Columns/rows describe atlas grid counts; frame duration measured in seconds (defaults to 1/24).【F:src/app.js†L40-L493】
  - Determinism: Same DOM attributes yield identical descriptors and CSS adjustments.【F:src/app.js†L446-L493】
  - Keep / change / delete: Keep; encapsulates DOM parsing and state seeding separate from animation ticking.【F:src/app.js†L420-L493】
  - Confidence / assumptions: High confidence; assumes preview markup supplies the documented data attributes when present.【F:src/app.js†L446-L493】

- `updateVehiclePreviewAnimation`
  - Purpose: Advances the vehicle preview sprite animation over time while the vehicle select screen is active.【F:src/app.js†L496-L518】
  - Inputs: `dt` — elapsed seconds from the renderer loop (renderer clamps to ≤0.25 s).【F:src/render.js†L2103-L2127】【F:src/app.js†L496-L518】
  - Outputs: No return; updates the descriptor’s `frameIndex`/`accumulator` and refreshes the element via `applyVehiclePreviewFrame`.【F:src/app.js†L496-L518】
  - Side effects: Mutates `state.dom.vehiclePreview` and its element styles; clears the descriptor when the element disappears or the mode changes.【F:src/app.js†L42-L65】【F:src/app.js†L496-L518】
  - Shared state touched and where it’s used: Reads and writes `state.dom.vehiclePreview`; called each frame by `step`, with early exits outside vehicle select.【F:src/app.js†L42-L65】【F:src/app.js†L496-L518】【F:src/app.js†L1106-L1124】
  - Dependencies: Requires the descriptor built by `setupVehiclePreviewAnimation`, the default duration constant, and `applyVehiclePreviewFrame`.【F:src/app.js†L40-L518】
  - Edge cases handled or missed: Handles missing preview, disconnected elements, and non-positive frame durations; assumes atlas metadata remains valid while active.【F:src/app.js†L496-L518】
  - Performance: Constant-time math per frame; active only during vehicle selection so workload is minimal.【F:src/app.js†L496-L518】【F:src/app.js†L1106-L1124】
  - Units / spaces: `dt` and frame durations in seconds; frame indices wrap modulo the sprite count.【F:src/render.js†L2103-L2127】【F:src/app.js†L496-L518】
  - Determinism: Deterministic progression for a given descriptor and `dt` sequence.【F:src/app.js†L496-L518】
  - Keep / change / delete: Keep; separates animation ticking from DOM setup for clarity and potential reuse.【F:src/app.js†L496-L518】【F:src/app.js†L420-L518】
  - Confidence / assumptions: High confidence; assumes `dt` originates from the renderer loop and the descriptor stays in sync with the DOM element.【F:src/render.js†L2103-L2127】【F:src/app.js†L496-L518】

- `clampIndex`
  - Purpose: Wraps an index into the valid `0…total-1` range so menu selections cycle correctly in both directions.【F:src/app.js†L521-L525】
  - Inputs: `index` (integer, may be negative/out of range) and `total` (expected positive integer; returns 0 when `total <= 0`).【F:src/app.js†L521-L525】
  - Outputs: Returns the wrapped index computed via modular arithmetic.【F:src/app.js†L521-L525】
  - Side effects: None; pure calculation.【F:src/app.js†L521-L525】
  - Shared state touched and where it’s used: Touches no state; reused by renderers and selection helpers for vehicle, settings, pause, and main menus.【F:src/app.js†L328-L599】
  - Dependencies: Pure helper; no external modules.【F:src/app.js†L521-L525】
  - Edge cases handled or missed: Returns 0 when `total <= 0`; assumes callers pass numeric totals (true for current usage).【F:src/app.js†L521-L548】
  - Performance: Constant-time arithmetic.【F:src/app.js†L521-L525】
  - Units / spaces: Operates on abstract index counts; no spatial units.【F:src/app.js†L521-L525】
  - Determinism: Deterministic for any given inputs.【F:src/app.js†L521-L525】
  - Keep / change / delete: Keep; centralizes wrap logic shared across menu flows.【F:src/app.js†L328-L599】
  - Confidence / assumptions: High confidence; assumes menus provide non-zero totals when active.【F:src/app.js†L521-L599】
- `changeMainMenuSelection`
  - Purpose: Moves the highlighted option in the main menu and redraws the panel accordingly.【F:src/app.js†L527-L531】
  - Inputs: `delta` — signed step (typically ±1) provided by navigation handlers.【F:src/app.js†L527-L531】【F:src/app.js†L867-L889】
  - Outputs: No return; updates `state.mainMenuIndex` and triggers a render.【F:src/app.js†L527-L531】
  - Side effects: Mutates `state.mainMenuIndex` and calls `updateMenuLayer`.【F:src/app.js†L42-L65】【F:src/app.js†L527-L531】
  - Shared state touched and where it’s used: Writes the menu index; invoked by `handleMenuNavigation`, which is wired to keyboard events in `handleMenuKeyDown`.【F:src/app.js†L42-L65】【F:src/app.js†L867-L895】
  - Dependencies: Uses `mainMenuOptions.length`, `clampIndex`, and `updateMenuLayer`.【F:src/app.js†L8-L12】【F:src/app.js†L521-L531】
  - Edge cases handled or missed: Wraps around automatically; does not guard against an empty options list (currently static and non-empty).【F:src/app.js†L8-L12】【F:src/app.js†L527-L531】
  - Performance: Constant-time; runs on each menu navigation key press.【F:src/app.js†L527-L531】【F:src/app.js†L867-L889】
  - Units / spaces: Integer indices only.【F:src/app.js†L527-L531】
  - Determinism: Same starting index and delta yield the same wrapped result.【F:src/app.js†L527-L531】
  - Keep / change / delete: Keep; encapsulates navigation updates separate from event handling.【F:src/app.js†L527-L531】【F:src/app.js†L867-L895】
  - Confidence / assumptions: High confidence; assumes keyboard handlers provide ±1 deltas and the options array remains stable.【F:src/app.js†L8-L12】【F:src/app.js†L867-L895】

- `changePauseMenuSelection`
  - Purpose: Rotates the pause menu highlight between “Resume” and “Quit to Menu.”【F:src/app.js†L533-L537】
  - Inputs: `delta` — signed step from pause navigation handlers.【F:src/app.js†L533-L537】【F:src/app.js†L871-L993】
  - Outputs: No return.【F:src/app.js†L533-L537】
  - Side effects: Updates `state.pauseMenuIndex` and calls `updateMenuLayer`.【F:src/app.js†L42-L65】【F:src/app.js†L533-L537】
  - Shared state touched and where it’s used: Writes the pause index; invoked via `handlePauseNavigation` from `handlePauseKeyDown`.【F:src/app.js†L42-L65】【F:src/app.js†L871-L993】
  - Dependencies: Relies on `pauseMenuOptions`, `clampIndex`, and `updateMenuLayer`.【F:src/app.js†L14-L17】【F:src/app.js†L521-L537】
  - Edge cases handled or missed: Wraps across the two static entries; does not expect an empty list.【F:src/app.js†L14-L17】【F:src/app.js†L533-L537】
  - Performance: Constant-time per navigation input.【F:src/app.js†L533-L537】
  - Units / spaces: Integer indices.【F:src/app.js†L533-L537】
  - Determinism: Deterministic wrap behavior.【F:src/app.js†L533-L537】
  - Keep / change / delete: Keep; mirrors other selection helpers for consistency.【F:src/app.js†L533-L537】【F:src/app.js†L871-L993】
  - Confidence / assumptions: High confidence; assumes pause menu remains two options deep.【F:src/app.js†L14-L17】【F:src/app.js†L871-L993】

- `changeSettingsSelection`
  - Purpose: Toggles the highlighted entry within the settings menu (snow toggle vs. back).【F:src/app.js†L539-L543】
  - Inputs: `delta` — signed navigation step from settings handlers.【F:src/app.js†L539-L543】【F:src/app.js†L875-L936】
  - Outputs: No return.【F:src/app.js†L539-L543】
  - Side effects: Mutates `state.settingsMenuIndex` and refreshes the menu.【F:src/app.js†L42-L65】【F:src/app.js†L539-L543】
  - Shared state touched and where it’s used: Writes the settings index; called by `handleSettingsNavigation` and indirectly by `handleSettingsKeyDown`.【F:src/app.js†L42-L65】【F:src/app.js†L875-L936】
  - Dependencies: Uses `settingsMenuKeys`, `clampIndex`, and `updateMenuLayer`.【F:src/app.js†L38-L38】【F:src/app.js†L521-L543】
  - Edge cases handled or missed: Wraps between the two defined entries; if more keys were added it would still wrap but labels must stay synchronized manually.【F:src/app.js†L38-L38】【F:src/app.js†L539-L543】
  - Performance: Constant-time per key press.【F:src/app.js†L539-L543】
  - Units / spaces: Integer indices.【F:src/app.js†L539-L543】
  - Determinism: Deterministic wrap logic.【F:src/app.js†L539-L543】
  - Keep / change / delete: Keep; aligns with other menu helpers.【F:src/app.js†L539-L543】【F:src/app.js†L875-L936】
  - Confidence / assumptions: High confidence; assumes settings menu keys stay in sync with template options.【F:src/app.js†L38-L38】【F:src/app.js†L539-L543】

- `changeVehicleSelection`
  - Purpose: Steps the selected vehicle highlight and rerenders the selection screen.【F:src/app.js†L545-L549】
  - Inputs: `delta` — signed step from left/right vehicle navigation.【F:src/app.js†L545-L549】【F:src/app.js†L943-L957】
  - Outputs: No return.【F:src/app.js†L545-L549】
  - Side effects: Updates `state.vehicleSelectIndex` (when vehicles exist) and calls `updateMenuLayer`.【F:src/app.js†L42-L65】【F:src/app.js†L545-L549】
  - Shared state touched and where it’s used: Writes the vehicle selection index; invoked by `handleVehicleSelectKeyDown` on arrow keys.【F:src/app.js†L42-L65】【F:src/app.js†L943-L969】
  - Dependencies: Uses `vehicleOptions.length`, `clampIndex`, and `updateMenuLayer`, returning early when no vehicles are available.【F:src/app.js†L19-L36】【F:src/app.js†L521-L549】
  - Edge cases handled or missed: No-ops when the list is empty; does not skip null entries beyond what `clampIndex` provides.【F:src/app.js†L19-L36】【F:src/app.js†L545-L549】
  - Performance: Constant-time; triggered on navigation input only.【F:src/app.js†L545-L549】【F:src/app.js†L943-L957】
  - Units / spaces: Integer indices into the vehicle array.【F:src/app.js†L545-L549】
  - Determinism: Same delta and list state lead to the same wrapped result.【F:src/app.js†L545-L549】
  - Keep / change / delete: Keep; small helper keeps the key handler focused on input flow.【F:src/app.js†L545-L549】【F:src/app.js†L943-L969】
  - Confidence / assumptions: High confidence; assumes the vehicle list stays short and static during selection.【F:src/app.js†L19-L36】【F:src/app.js†L545-L549】

- `getVehicleOptionByKey`
  - Purpose: Looks up a vehicle configuration by its key so selection logic can retrieve the full option payload.【F:src/app.js†L552-L555】
  - Inputs: `key` — string identifier; returns `null` for falsy keys.【F:src/app.js†L552-L555】
  - Outputs: Matching vehicle option object or `null`.【F:src/app.js†L552-L555】
  - Side effects: None; pure search over `vehicleOptions`.【F:src/app.js†L552-L555】
  - Shared state touched and where it’s used: Reads the module-level `vehicleOptions`; consumed by `applyVehicleSelection`.【F:src/app.js†L19-L36】【F:src/app.js†L557-L575】
  - Dependencies: None beyond the array in scope.【F:src/app.js†L552-L555】
  - Edge cases handled or missed: Ignores falsy keys and tolerates `null` entries; linear scan could become expensive if the options list grows significantly (currently tiny).【F:src/app.js†L19-L36】【F:src/app.js†L552-L555】
  - Performance: O(n) over the vehicle list; presently negligible with two entries.【F:src/app.js†L19-L36】【F:src/app.js†L552-L555】
  - Units / spaces: Works with string identifiers; no spatial units.【F:src/app.js†L552-L555】
  - Determinism: Returns the first matching entry consistently.【F:src/app.js†L552-L555】
  - Keep / change / delete: Keep; adequate for the small dataset (could shift to a keyed map if vehicles expand).【F:src/app.js†L19-L36】【F:src/app.js†L552-L555】
  - Confidence / assumptions: High confidence; assumes keys remain unique.【F:src/app.js†L19-L36】【F:src/app.js†L552-L555】

- `applyVehicleSelection`
  - Purpose: Persists the player’s vehicle choice and swaps the gameplay texture to match that selection.【F:src/app.js†L557-L575】
  - Inputs: `vehicleKey` — target option key; falls back to the first option if lookup fails.【F:src/app.js†L557-L575】
  - Outputs: No return.【F:src/app.js†L557-L575】
  - Side effects: Updates `state.selectedVehicleKey`, syncs `state.vehicleSelectIndex`, and sets `World.assets.textures.playerVehicle` to the chosen atlas or fallback texture.【F:src/app.js†L19-L65】【F:src/app.js†L557-L575】
  - Shared state touched and where it’s used: Mutates selection state and rendering textures; invoked from `startRace` and from `init` to align defaults.【F:src/app.js†L19-L65】【F:src/app.js†L723-L734】【F:src/app.js†L1134-L1138】
  - Dependencies: Uses `getVehicleOptionByKey`, `clampIndex`, and the `World.assets.textures` map to update the active sprite sheet.【F:src/app.js†L552-L575】
  - Edge cases handled or missed: Falls back to the first option if lookup fails and only reassigns textures when an atlas or fallback is available; logs nothing if both are missing.【F:src/app.js†L557-L575】
  - Performance: Linear search to find the option plus constant assignments; called infrequently on selection or startup.【F:src/app.js†L557-L575】【F:src/app.js†L723-L734】
  - Units / spaces: Works with texture keys and array indices; no spatial units.【F:src/app.js†L557-L575】
  - Determinism: Same key and texture set lead to the same state mutations.【F:src/app.js†L557-L575】
  - Keep / change / delete: Keep; centralizes selection + texture wiring logic reused by race start and bootstrapping.【F:src/app.js†L557-L575】【F:src/app.js†L723-L734】【F:src/app.js†L1134-L1138】
  - Confidence / assumptions: High confidence; assumes textures have been loaded into `World.assets` before invocation.【F:src/app.js†L557-L575】

- `showVehicleSelect`
  - Purpose: Enters the vehicle selection screen or starts a race immediately when no vehicles are defined.【F:src/app.js†L577-L589】
  - Inputs: None; reads `vehicleOptions`, `state.selectedVehicleKey`, and `state.vehicleSelectIndex`.【F:src/app.js†L19-L65】【F:src/app.js†L577-L589】
  - Outputs: No return.【F:src/app.js†L577-L589】
  - Side effects: Calls `startRace()` if no vehicles exist; otherwise updates `state.vehicleSelectIndex` and switches mode to `'vehicleSelect'`.【F:src/app.js†L220-L235】【F:src/app.js†L577-L589】
  - Shared state touched and where it’s used: Mutates selection index and mode; triggered from `activateMainMenuSelection` when the “Start Race” menu option is confirmed.【F:src/app.js†L42-L65】【F:src/app.js†L769-L778】
  - Dependencies: Uses `vehicleOptions.findIndex`, `clampIndex`, `startRace`, and `setMode`.【F:src/app.js†L220-L589】
  - Edge cases handled or missed: Auto-starts when the list is empty and clamps indices even if previous state was out of range; does not guard against duplicate vehicle keys.【F:src/app.js†L577-L589】
  - Performance: Constant-time operations over the tiny options array; runs on menu activation only.【F:src/app.js†L577-L589】【F:src/app.js†L769-L778】
  - Units / spaces: Integer indices and mode strings.【F:src/app.js†L577-L589】
  - Determinism: Same state triggers the same start or mode switch.【F:src/app.js†L577-L589】
  - Keep / change / delete: Keep; encapsulates race-start entry logic separate from the menu activation handler.【F:src/app.js†L577-L589】【F:src/app.js†L769-L778】
  - Confidence / assumptions: High confidence; assumes `startRace` can safely run before asynchronous gameplay setup finishes.【F:src/app.js†L577-L734】

- `activateVehicleSelection`
  - Purpose: Confirms the highlighted vehicle and begins the race with that selection (or defaults when no vehicles exist).【F:src/app.js†L592-L602】
  - Inputs: None; reads `vehicleOptions` and `state.vehicleSelectIndex`.【F:src/app.js†L19-L65】【F:src/app.js†L592-L602】
  - Outputs: No return.【F:src/app.js†L592-L602】
  - Side effects: Calls `startRace` with the selected vehicle key, or falls back to `startRace()` when the list is empty.【F:src/app.js†L592-L602】
  - Shared state touched and where it’s used: Reads selection state; invoked by `handleVehicleSelectKeyDown` when confirm keys are pressed.【F:src/app.js†L42-L65】【F:src/app.js†L943-L957】
  - Dependencies: Uses `clampIndex`, the vehicle options array, and `startRace`.【F:src/app.js†L521-L602】
  - Edge cases handled or missed: Skips action if the clamped option is falsy; relies on `startRace` to handle downstream failures.【F:src/app.js†L592-L602】
  - Performance: Constant-time selection; executed only on confirmation input.【F:src/app.js†L592-L602】【F:src/app.js†L943-L957】
  - Units / spaces: Integer indices and vehicle keys.【F:src/app.js†L592-L602】
  - Determinism: Same highlighted vehicle yields the same start call.【F:src/app.js†L592-L602】
  - Keep / change / delete: Keep; keeps keyboard handler concise and delegates to shared race-start logic.【F:src/app.js†L592-L602】【F:src/app.js†L943-L957】
  - Confidence / assumptions: High confidence; assumes `startRace` handles asynchronous scene reset and game start robustly.【F:src/app.js†L592-L734】
- `adjustCurrentNameLetter`
  - Purpose: Rotates the currently editable leaderboard initial upward or downward during name entry.【F:src/app.js†L604-L617】
  - Inputs: `delta` — signed step (±1) applied to the alphabet index.【F:src/app.js†L604-L617】【F:src/app.js†L1010-L1019】
  - Outputs: No return.【F:src/app.js†L604-L617】
  - Side effects: Updates `state.raceComplete.letters` and `playerName`, then rerenders the menu when in the entry phase.【F:src/app.js†L42-L65】【F:src/app.js†L604-L617】
  - Shared state touched and where it’s used: Mutates the race-complete slice; invoked from `handleRaceCompleteKeyDown` on up/down input during the entry phase.【F:src/app.js†L42-L65】【F:src/app.js†L995-L1019】
  - Dependencies: Uses `NAME_ALPHABET` for character lookup and `updateMenuLayer` to refresh the UI.【F:src/app.js†L67-L67】【F:src/app.js†L604-L617】
  - Edge cases handled or missed: Ensures race-complete is active, in entry phase, index in range, and letter not already confirmed; wraps alphabet changes via modulo but cannot edit variable-length names (fixed three letters).【F:src/app.js†L604-L617】
  - Performance: Constant-time string manipulation per key press.【F:src/app.js†L604-L617】【F:src/app.js†L995-L1019】
  - Units / spaces: Alphabet positions 0–25 only.【F:src/app.js†L604-L617】
  - Determinism: Same delta and state yield identical letter updates.【F:src/app.js†L604-L617】
  - Keep / change / delete: Keep; isolates letter rotation logic from event handlers.【F:src/app.js†L604-L617】【F:src/app.js†L995-L1019】
  - Confidence / assumptions: High confidence; assumes `NAME_ALPHABET` stays uppercase A–Z and letters array length matches the entry length.【F:src/app.js†L67-L67】【F:src/app.js†L604-L617】

- `lockCurrentNameLetter`
  - Purpose: Confirms the active initial and either advances editing to the next slot or finalizes the leaderboard entry.【F:src/app.js†L620-L633】
  - Inputs: None; reads `state.raceComplete.currentIndex` and arrays.【F:src/app.js†L620-L633】
  - Outputs: No return.【F:src/app.js†L620-L633】
  - Side effects: Marks the letter as confirmed, updates `playerName`, moves focus to the next letter, and triggers a UI refresh; calls `finalizeRaceCompleteEntry` when the last slot is confirmed.【F:src/app.js†L620-L633】
  - Shared state touched and where it’s used: Mutates the race-complete slice; invoked by `handleRaceCompleteKeyDown` when the player presses the confirm key during entry.【F:src/app.js†L42-L65】【F:src/app.js†L995-L1033】
  - Dependencies: Uses `finalizeRaceCompleteEntry` and `updateMenuLayer`.【F:src/app.js†L620-L633】
  - Edge cases handled or missed: Validates active entry phase and bounds; does not reset confirmed letters if the player cancels (handled by broader flow).【F:src/app.js†L620-L633】
  - Performance: Constant-time array updates; runs once per confirmation input.【F:src/app.js†L620-L633】【F:src/app.js†L995-L1033】
  - Units / spaces: Works with indices into the three-letter array.【F:src/app.js†L620-L633】
  - Determinism: Deterministic for a given state and index.【F:src/app.js†L620-L633】
  - Keep / change / delete: Keep; encapsulates entry confirmation logic away from key handling.【F:src/app.js†L620-L633】【F:src/app.js†L995-L1033】
  - Confidence / assumptions: High confidence; assumes exactly three-letter initials and that `finalizeRaceCompleteEntry` handles persistence.【F:src/app.js†L620-L642】

- `finalizeRaceCompleteEntry`
  - Purpose: Commits the entered initials and time to the leaderboard, records the new entry id/rank, and advances the reveal sequence.【F:src/app.js†L635-L642】
  - Inputs: None; reads `state.raceComplete` and calls `addLeaderboardEntry`.【F:src/app.js†L211-L217】【F:src/app.js†L635-L642】
  - Outputs: No return.【F:src/app.js†L635-L642】
  - Side effects: Updates `playerName`, stores `entryId`/`playerRank`, and switches phase to `'revealPlayer'`.【F:src/app.js†L635-L642】
  - Shared state touched and where it’s used: Mutates the race-complete slice; called only by `lockCurrentNameLetter` when the last letter is confirmed.【F:src/app.js†L631-L642】
  - Dependencies: Uses `addLeaderboardEntry` (which appends and sorts the leaderboard) and `setRaceCompletePhase`.【F:src/app.js†L211-L217】【F:src/app.js†L635-L649】
  - Edge cases handled or missed: Rebuilds the player name from letters before saving; assumes the leaderboard addition succeeds and returns an entry with `id` and `rank`.【F:src/app.js†L635-L642】
  - Performance: Constant work plus leaderboard insertion handled inside `addLeaderboardEntry`; runs once per race completion.【F:src/app.js†L211-L217】【F:src/app.js†L635-L642】
  - Units / spaces: Works with milliseconds for the score (`rc.timeMs`).【F:src/app.js†L635-L642】
  - Determinism: Same letters and time create the same leaderboard entry (aside from unique symbol ids).【F:src/app.js†L211-L217】【F:src/app.js†L635-L642】
  - Keep / change / delete: Keep; cleanly separates persistence from input handling.【F:src/app.js†L631-L642】
  - Confidence / assumptions: High confidence; assumes leaderboard arrays remain mutable and accessible.【F:src/app.js†L211-L217】【F:src/app.js†L635-L642】

- `setRaceCompletePhase`
  - Purpose: Updates the race-complete state machine, resetting the phase timer and refreshing the UI for the next reveal step.【F:src/app.js†L644-L649】
  - Inputs: `phase` — string identifier (`'entry'`, `'revealPlayer'`, `'revealTop'`, `'complete'`, etc.).【F:src/app.js†L644-L649】
  - Outputs: No return.【F:src/app.js†L644-L649】
  - Side effects: Mutates `state.raceComplete.phase` and `timer`, marks the app as recently interacted, and calls `updateMenuLayer`.【F:src/app.js†L42-L65】【F:src/app.js†L92-L94】【F:src/app.js†L644-L649】
  - Shared state touched and where it’s used: Adjusts the race-complete slice; invoked from `finalizeRaceCompleteEntry`, `advanceRaceCompleteSequence`, and `updateRaceComplete`.【F:src/app.js†L635-L677】
  - Dependencies: Uses `markInteraction` and `updateMenuLayer`.【F:src/app.js†L92-L94】【F:src/app.js†L644-L649】
  - Edge cases handled or missed: Does not validate the incoming phase; assumes callers provide a valid string and that resetting the timer to 0 is enough for transitions.【F:src/app.js†L644-L649】
  - Performance: Constant-time; invoked a few times per race completion.【F:src/app.js†L644-L649】
  - Units / spaces: Timer measured in seconds accumulated elsewhere.【F:src/app.js†L644-L677】
  - Determinism: Deterministic assignment for a given phase input.【F:src/app.js†L644-L649】
  - Keep / change / delete: Keep; single point of truth for phase transitions and timer resets.【F:src/app.js†L644-L649】
  - Confidence / assumptions: High confidence; assumes repeated calls stay inexpensive and `updateMenuLayer` handles the redraw cost.【F:src/app.js†L644-L649】

- `advanceRaceCompleteSequence`
  - Purpose: Steps the post-race reveal sequence forward or exits to attract mode when complete.【F:src/app.js†L652-L658】
  - Inputs: None; reads `state.raceComplete.phase`.【F:src/app.js†L652-L658】
  - Outputs: No return.【F:src/app.js†L652-L658】
  - Side effects: Calls `setRaceCompletePhase` for transitions or `goToAttract` once the `'complete'` phase is reached.【F:src/app.js†L652-L658】
  - Shared state touched and where it’s used: Indirectly mutates phase via `setRaceCompletePhase`; triggered by `handleRaceCompleteKeyDown` when the player confirms after entries are locked.【F:src/app.js†L652-L658】【F:src/app.js†L995-L1033】
  - Dependencies: Uses `setRaceCompletePhase` and `goToAttract`.【F:src/app.js†L644-L684】
  - Edge cases handled or missed: Handles the known sequence (`revealPlayer` → `revealTop` → `complete`); other phases are ignored and produce no change.【F:src/app.js†L652-L658】
  - Performance: Constant-time branching.【F:src/app.js†L652-L658】
  - Units / spaces: Operates on string states only.【F:src/app.js†L652-L658】
  - Determinism: Deterministic transitions for a given current phase.【F:src/app.js†L652-L658】
  - Keep / change / delete: Keep; keeps phase logic out of the key handler.【F:src/app.js†L652-L658】【F:src/app.js†L995-L1033】
  - Confidence / assumptions: High confidence; assumes only the documented phases reach this helper.【F:src/app.js†L652-L658】

- `updateRaceComplete`
  - Purpose: Runs the timed progression for post-race reveals, advancing phases after fixed delays and eventually returning to attract mode.【F:src/app.js†L663-L677】
  - Inputs: `dt` — seconds since the previous step (renderer loop clamps to ≤0.25 s).【F:src/render.js†L2103-L2127】【F:src/app.js†L663-L677】
  - Outputs: No return.【F:src/app.js†L663-L677】
  - Side effects: Increments `state.raceComplete.timer`, triggers `setRaceCompletePhase` when thresholds (3 s, 2.5 s) pass, or calls `goToAttract` when the sequence ends.【F:src/app.js†L663-L684】
  - Shared state touched and where it’s used: Mutates the race-complete timer/phase; called each frame by `step` while mode is `'raceComplete'`.【F:src/app.js†L42-L65】【F:src/app.js†L663-L677】【F:src/app.js†L1106-L1124】
  - Dependencies: Relies on `setRaceCompletePhase` and `goToAttract`.【F:src/app.js†L663-L684】
  - Edge cases handled or missed: Guards against inactive states and only runs for reveal/complete phases; timer continues accumulating until phase changes reset it.【F:src/app.js†L663-L677】
  - Performance: Constant work per frame; active only during the short post-race sequence.【F:src/app.js†L663-L677】【F:src/app.js†L1106-L1124】
  - Units / spaces: Time measured in seconds; no spatial units.【F:src/app.js†L663-L677】
  - Determinism: Deterministic progression given consistent `dt` inputs.【F:src/app.js†L663-L677】
  - Keep / change / delete: Keep; encapsulates timer thresholds separate from the render loop.【F:src/app.js†L663-L677】【F:src/app.js†L1106-L1124】
  - Confidence / assumptions: High confidence; assumes `dt` originates from the renderer loop and phases start with `timer = 0`.【F:src/render.js†L2103-L2127】【F:src/app.js†L644-L677】

- `goToAttract`
  - Purpose: Switches the application into attract mode so the idle video can play.【F:src/app.js†L682-L684】
  - Inputs: None.【F:src/app.js†L682-L684】
  - Outputs: No return.【F:src/app.js†L682-L684】
  - Side effects: Calls `setMode('attract')`, which updates `state.mode` and triggers a menu redraw.【F:src/app.js†L220-L235】【F:src/app.js†L682-L684】
  - Shared state touched and where it’s used: Indirectly mutates mode state; invoked from race-complete flow, idle timeout logic, and attract key handler to centralize the transition.【F:src/app.js†L659-L1121】
  - Dependencies: Uses `setMode`; no other helpers.【F:src/app.js†L220-L235】【F:src/app.js†L682-L684】
  - Edge cases handled or missed: Relies on `setMode` to ignore redundant transitions and reset race-complete state as needed.【F:src/app.js†L220-L235】【F:src/app.js†L682-L684】
  - Performance: Constant-time mode switch.【F:src/app.js†L682-L684】
  - Units / spaces: Operates on mode strings only.【F:src/app.js†L682-L684】
  - Determinism: Deterministic state change given the same prior mode.【F:src/app.js†L682-L684】
  - Keep / change / delete: Keep; clarifies intent at call sites and centralizes the attract transition.【F:src/app.js†L659-L1121】
  - Confidence / assumptions: High confidence; assumes `setMode` handles any cleanup required when leaving other modes.【F:src/app.js†L220-L235】【F:src/app.js†L682-L684】
- `toggleSnowSetting`
  - Purpose: Flips the snow visual-effect toggle and refreshes the settings menu display.【F:src/app.js†L686-L689】
  - Inputs: None; reads `state.settings.snowEnabled`.【F:src/app.js†L42-L65】【F:src/app.js†L686-L689】
  - Outputs: No return.【F:src/app.js†L686-L689】
  - Side effects: Inverts the boolean flag and calls `updateMenuLayer` so the menu reflects the new value.【F:src/app.js†L686-L689】
  - Shared state touched and where it’s used: Mutates the settings slice; invoked by the settings menu activation handler and arrow key handler when the snow option is focused.【F:src/app.js†L791-L936】
  - Dependencies: Relies on `updateMenuLayer`; gameplay systems read the flag through `App.isSnowEnabled()`.【F:src/app.js†L686-L689】【F:src/app.js†L1140-L1146】
  - Edge cases handled or missed: Simply toggles the flag; persistence across sessions is not implemented.【F:src/app.js†L686-L689】
  - Performance: Constant-time flip executed on menu interaction only.【F:src/app.js†L686-L689】【F:src/app.js†L791-L936】
  - Units / spaces: Boolean flag only.【F:src/app.js†L686-L689】
  - Determinism: Deterministic toggle for each invocation.【F:src/app.js†L686-L689】
  - Keep / change / delete: Keep; minimal helper keeps UI logic tidy.【F:src/app.js†L686-L689】【F:src/app.js†L791-L936】
  - Confidence / assumptions: High confidence; assumes snow-enabled state is consumed elsewhere as a simple boolean.【F:src/app.js†L686-L689】【F:src/app.js†L1140-L1146】

- `applyDebugModeSetting`
  - Purpose: Pushes the debug-mode toggle from settings into the shared `Config.debug.mode` flag used by rendering diagnostics.【F:src/app.js†L691-L699】
  - Inputs: None; reads `state.settings.debugEnabled` and the global `Config.debug` object.【F:src/app.js†L2-L5】【F:src/app.js†L42-L65】【F:src/app.js†L691-L699】
  - Outputs: No return.【F:src/app.js†L691-L699】
  - Side effects: Mutates `Config.debug.mode`, catching and logging any assignment failures.【F:src/app.js†L691-L699】
  - Shared state touched and where it’s used: Reads settings state and writes to `Config.debug`, which other modules consult for debug rendering behavior.【F:src/app.js†L2-L5】【F:src/app.js†L691-L699】
  - Dependencies: Depends on the global `Config` object and console logging for error reporting.【F:src/app.js†L2-L5】【F:src/app.js†L691-L699】
  - Edge cases handled or missed: Verifies `Config.debug` is an object before writing and swallows exceptions; does not persist the flag beyond runtime.【F:src/app.js†L691-L699】
  - Performance: Constant-time property assignment; called when debug toggles change or during init.【F:src/app.js†L691-L699】【F:src/app.js†L704-L705】【F:src/app.js†L1134-L1138】
  - Units / spaces: Uses string modes `'fill'` or `'off'`.【F:src/app.js†L691-L699】
  - Determinism: Same boolean setting yields the same mode string.【F:src/app.js†L691-L699】
  - Keep / change / delete: Keep; isolates Config wiring from UI logic.【F:src/app.js†L691-L699】【F:src/app.js†L704-L705】
  - Confidence / assumptions: High confidence; assumes `Config.debug` exists and other systems read `Config.debug.mode`.【F:src/app.js†L2-L5】【F:src/app.js†L691-L699】

- `setDebugEnabled`
  - Purpose: Updates the settings boolean for debug visuals and applies it to `Config.debug.mode`.【F:src/app.js†L702-L705】
  - Inputs: `enabled` — truthy to enable debug mode, falsy to disable.【F:src/app.js†L702-L705】
  - Outputs: No return.【F:src/app.js†L702-L705】
  - Side effects: Sets `state.settings.debugEnabled` and calls `applyDebugModeSetting`.【F:src/app.js†L42-L65】【F:src/app.js†L702-L705】
  - Shared state touched and where it’s used: Mutates the settings slice; consumed by `toggleDebugSetting` and initialization code to keep UI and Config in sync.【F:src/app.js†L702-L709】【F:src/app.js†L1134-L1138】
  - Dependencies: Calls `applyDebugModeSetting`.【F:src/app.js†L702-L705】
  - Edge cases handled or missed: Coerces the input to boolean; no persistence beyond memory.【F:src/app.js†L702-L705】
  - Performance: Constant-time.【F:src/app.js†L702-L705】
  - Units / spaces: Boolean flag only.【F:src/app.js†L702-L705】
  - Determinism: Deterministic assignment for given input.【F:src/app.js†L702-L705】
  - Keep / change / delete: Keep; single point for updating the debug flag and side effects.【F:src/app.js†L702-L705】
  - Confidence / assumptions: High confidence; assumes `applyDebugModeSetting` handles Config integration safely.【F:src/app.js†L691-L705】

- `toggleDebugSetting`
  - Purpose: Inverts the debug-mode setting and refreshes the settings menu to reflect the new state.【F:src/app.js†L707-L709】
  - Inputs: None; reads `state.settings.debugEnabled`.【F:src/app.js†L42-L65】【F:src/app.js†L707-L709】
  - Outputs: No return.【F:src/app.js†L707-L709】
  - Side effects: Calls `setDebugEnabled` with the negated flag and triggers `updateMenuLayer`.【F:src/app.js†L707-L709】
  - Shared state touched and where it’s used: Mutates settings indirectly; invoked via keyboard shortcut `KeyB` and the settings menu when the debug option exists (currently only keyboard shortcut).【F:src/app.js†L707-L709】【F:src/app.js†L1042-L1050】
  - Dependencies: Uses `setDebugEnabled` and `updateMenuLayer`.【F:src/app.js†L702-L709】
  - Edge cases handled or missed: None beyond boolean flip; debug option is hidden from the settings menu UI today, so only the shortcut toggles it.【F:src/app.js†L707-L709】【F:src/app.js†L1042-L1050】
  - Performance: Constant-time.【F:src/app.js†L707-L709】
  - Units / spaces: Boolean flag only.【F:src/app.js†L707-L709】
  - Determinism: Deterministic toggle.【F:src/app.js†L707-L709】
  - Keep / change / delete: Keep; provides a dedicated helper for both shortcut and potential UI toggle reuse.【F:src/app.js†L707-L709】【F:src/app.js†L1042-L1050】
  - Confidence / assumptions: High confidence; assumes the shortcut should always update the menu when not playing.【F:src/app.js†L707-L709】【F:src/app.js†L1042-L1050】

- `resetGameplayInputs`
  - Purpose: Clears gameplay input flags so no movement keys remain stuck when switching modes or finishing a race.【F:src/app.js†L712-L719】
  - Inputs: None; uses `Gameplay.state.input` when available.【F:src/app.js†L2-L5】【F:src/app.js†L712-L719】
  - Outputs: No return.【F:src/app.js†L712-L719】
  - Side effects: Sets `left`, `right`, `up`, `down`, and `hop` flags to `false` if the gameplay input object exists.【F:src/app.js†L712-L719】
  - Shared state touched and where it’s used: Mutates the gameplay module’s input state; called before starting a race, when pausing/quitting, and upon race finish to avoid lingering input.【F:src/app.js†L712-L765】【F:src/app.js†L1052-L1057】
  - Dependencies: Requires the global `Gameplay` object to expose `state.input`.【F:src/app.js†L2-L5】【F:src/app.js†L712-L719】
  - Edge cases handled or missed: Gracefully no-ops when gameplay state/input is missing; does not clear analog values beyond the tracked booleans.【F:src/app.js†L712-L719】
  - Performance: Constant-time assignments; called on mode transitions rather than per frame.【F:src/app.js†L712-L765】
  - Units / spaces: Boolean input flags only.【F:src/app.js†L712-L719】
  - Determinism: Repeated calls set the same fields to `false`.【F:src/app.js†L712-L719】
  - Keep / change / delete: Keep; centralizes input reset logic used across multiple flows.【F:src/app.js†L712-L765】【F:src/app.js†L1052-L1057】
  - Confidence / assumptions: High confidence; assumes gameplay module exposes mutable input flags.【F:src/app.js†L2-L5】【F:src/app.js†L712-L719】

- `startRace`
  - Purpose: Applies the chosen vehicle, resets race-complete state, and hands control to gameplay to begin a new race session.【F:src/app.js†L722-L734】
  - Inputs: `vehicleKey` — optional vehicle identifier (defaults to `state.selectedVehicleKey`).【F:src/app.js†L722-L734】
  - Outputs: No return; kicks off asynchronous gameplay setup.【F:src/app.js†L722-L734】
  - Side effects: Calls `applyVehicleSelection`, resets the race-complete state, switches mode to `'playing'`, clears gameplay inputs, and invokes `Gameplay.resetScene` followed by `Gameplay.startRaceSession({ laps: 1 })`, logging errors on failure.【F:src/app.js†L84-L734】
  - Shared state touched and where it’s used: Mutates selection, race-complete, and mode state; used by vehicle selection confirmation and fallback flows to start gameplay.【F:src/app.js†L557-L734】【F:src/app.js†L577-L602】
  - Dependencies: Relies on `applyVehicleSelection`, `resetRaceCompleteState`, `setMode`, `resetGameplayInputs`, and optional gameplay hooks (`resetScene`, `startRaceSession`).【F:src/app.js†L84-L734】
  - Edge cases handled or missed: Works even when `Gameplay.resetScene` is absent (Promise resolves undefined); logs errors if scene reset fails; assumes one-lap races for now.【F:src/app.js†L722-L734】
  - Performance: Bounded by gameplay scene reset/start; this function mostly orchestrates calls and runs only when starting a race.【F:src/app.js†L722-L734】
  - Units / spaces: Uses lap count (integer) for race session; no other units.【F:src/app.js†L722-L734】
  - Determinism: Deterministic sequencing given the same state, though gameplay reset/start may involve asynchronous behavior.【F:src/app.js†L722-L734】
  - Keep / change / delete: Keep; central orchestration point for launching races.【F:src/app.js†L722-L734】
  - Confidence / assumptions: High confidence; assumes gameplay module fulfills `resetScene` and `startRaceSession` contracts and handles their own errors after logging.【F:src/app.js†L722-L734】
- `handleRaceFinish`
  - Purpose: Transitions the app from gameplay into the race-complete flow by clearing controls, capturing the finish time, and priming name-entry state for the leaderboard screen.【F:src/app.js†L736-L746】
  - Inputs: `timeMs` — reported finish duration in milliseconds; accepts any number (non-finite or negative values are coerced to `0`).【F:src/app.js†L738-L742】
  - Outputs: Returns `undefined`; populates `state.raceComplete` with a fresh descriptor for UI rendering and onboarding to the completion sequence.【F:src/app.js†L739-L746】
  - Side effects: Resets gameplay input flags, rebuilds the race-complete state object, clears any highlighted leaderboard entry, and switches UI mode to `'raceComplete'`.【F:src/app.js†L737-L746】
  - Shared state touched and where it’s used: Mutates `state.raceComplete` and `state.leaderboard.highlightId`, which feed the race-complete and leaderboard renderers; invoked exclusively from the gameplay callback wired in `setupCallbacks()` when a race ends.【F:src/app.js†L739-L746】【F:src/bootstrap.js†L38-L54】
  - Dependencies: Calls `resetGameplayInputs`, `createInitialRaceCompleteState`, and `setMode` to prep UI and inputs.【F:src/app.js†L737-L746】
  - Edge cases handled or missed: Handles NaN/∞/negative times by clamping to zero but has no explicit branch for DNFs/DQs or manual retries.【F:src/app.js†L738-L742】
  - Performance: Constant-time state updates; no loops or I/O, so negligible overhead when a race finishes.【F:src/app.js†L736-L746】
  - Units / spaces: Interprets `timeMs` in milliseconds and stores the formatted result for later UI conversion.【F:src/app.js†L738-L745】
  - Determinism: Deterministic given the same `timeMs` and existing state; repeated calls overwrite the race-complete snapshot with the same derived values.【F:src/app.js†L736-L746】
  - Keep / change / delete: Keep; it is the single integration point from gameplay completion into the UI pipeline.【F:src/app.js†L736-L746】【F:src/bootstrap.js†L50-L54】
  - Confidence / assumptions: High confidence; assumes `createInitialRaceCompleteState` returns the canonical template used throughout the race-complete workflow.【F:src/app.js†L739-L745】

- `showLeaderboard`
  - Purpose: Brings the UI to the leaderboard screen and triggers a fetch if cached data is absent.【F:src/app.js†L749-L752】
  - Inputs: None; relies on current app state for context.【F:src/app.js†L749-L752】
  - Outputs: Returns `undefined`; relies on side effects for mode switching and data loading.【F:src/app.js†L749-L752】
  - Side effects: Sets the mode to `'leaderboard'` and kicks off `requestLeaderboard()` which may update loading/error flags and entries asynchronously.【F:src/app.js†L749-L828】
  - Shared state touched and where it’s used: Alters `state.mode`, feeding menu rendering logic; invoked when the main-menu option for the leaderboard is activated.【F:src/app.js†L749-L752】【F:src/app.js†L769-L778】
  - Dependencies: Calls `setMode` and `requestLeaderboard`.【F:src/app.js†L749-L752】
  - Edge cases handled or missed: Relies on `requestLeaderboard` to avoid duplicate fetches; does not guard against missing network access itself.【F:src/app.js†L749-L828】
  - Performance: Constant-time aside from the asynchronous fetch performed by `requestLeaderboard`.【F:src/app.js†L749-L828】
  - Units / spaces: Operates purely on UI mode flags; no special units involved.【F:src/app.js†L749-L752】
  - Determinism: Deterministic—same state leads to the same mode change and fetch attempt; eventual results depend on network data.【F:src/app.js†L749-L828】
  - Keep / change / delete: Keep; central helper for multiple entry points to the leaderboard.【F:src/app.js†L749-L778】
  - Confidence / assumptions: High confidence; assumes `requestLeaderboard` gracefully handles already-loaded state.【F:src/app.js†L800-L828】

- `showSettings`
  - Purpose: Switches the app into the settings menu without any additional setup.【F:src/app.js†L754-L756】
  - Inputs: None.【F:src/app.js†L754-L756】
  - Outputs: Returns `undefined`; relies on mode change for downstream behavior.【F:src/app.js†L754-L756】
  - Side effects: Updates `state.mode` to `'settings'`, triggering menu rerendering.【F:src/app.js†L754-L756】【F:src/app.js†L391-L417】
  - Shared state touched and where it’s used: Adjusts the mode consumed by `updateMenuLayer`; primarily invoked from the main menu option handler.【F:src/app.js†L754-L778】
  - Dependencies: Calls `setMode`.【F:src/app.js†L754-L756】
  - Edge cases handled or missed: No safeguards; assumes settings are always available.【F:src/app.js†L754-L756】
  - Performance: Constant-time mode assignment.【F:src/app.js†L754-L756】
  - Units / spaces: Uses the `'settings'` mode string only.【F:src/app.js†L754-L756】
  - Determinism: Deterministic for the same current state.【F:src/app.js†L754-L756】
  - Keep / change / delete: Keep; provides a single semantic entry point for settings navigation.【F:src/app.js†L754-L778】
  - Confidence / assumptions: High confidence; assumes `setMode` manages any cleanup like resetting indices when applicable.【F:src/app.js†L220-L235】

- `resumeRace`
  - Purpose: Leaves pause-or-menu states and returns the game to active play.【F:src/app.js†L758-L760】
  - Inputs: None.【F:src/app.js†L758-L760】
  - Outputs: Returns `undefined`; relies on mode swap for gameplay resumption.【F:src/app.js†L758-L760】
  - Side effects: Sets `state.mode` to `'playing'`, which suppresses menu rendering and resumes gameplay stepping.【F:src/app.js†L758-L760】【F:src/app.js†L391-L418】【F:src/app.js†L1106-L1116】
  - Shared state touched and where it’s used: Mode change influences `updateMenuLayer` and the main loop; invoked from pause menu selection, pause hotkey handling, and escape handling in the pause menu.【F:src/app.js†L781-L990】【F:src/app.js†L1052-L1063】
  - Dependencies: Calls `setMode`.【F:src/app.js†L758-L760】
  - Edge cases handled or missed: Does not reinitialize gameplay state; assumes gameplay can resume immediately.【F:src/app.js†L758-L760】
  - Performance: Constant-time.【F:src/app.js†L758-L760】
  - Units / spaces: Operates on mode flags only.【F:src/app.js†L758-L760】
  - Determinism: Deterministic; identical state yields identical mode transition.【F:src/app.js†L758-L760】
  - Keep / change / delete: Keep; central resume hook shared by UI and keyboard controls.【F:src/app.js†L781-L990】【F:src/app.js†L1052-L1063】
  - Confidence / assumptions: High confidence; assumes `setMode('playing')` handles resetting menu indices as needed.【F:src/app.js†L220-L228】

- `quitToMenu`
  - Purpose: Exits gameplay back to the main menu while ensuring controls and scene reset hooks run.【F:src/app.js†L762-L767】
  - Inputs: None.【F:src/app.js†L762-L767】
  - Outputs: Returns `undefined`; orchestrates side effects for quitting.【F:src/app.js†L762-L767】
  - Side effects: Sets mode to `'menu'`, clears gameplay inputs, and invokes `Gameplay.resetScene()` if available, logging failures.【F:src/app.js†L762-L767】
  - Shared state touched and where it’s used: Alters mode and indirectly triggers menu rendering; called from the pause menu option handler.【F:src/app.js†L762-L789】
  - Dependencies: Calls `setMode`, `resetGameplayInputs`, and optionally `Gameplay.resetScene`.【F:src/app.js†L762-L767】
  - Edge cases handled or missed: Safely handles missing `Gameplay.resetScene`; does not wait for reset completion before returning to menu.【F:src/app.js†L765-L767】
  - Performance: Constant-time aside from the asynchronous scene reset.【F:src/app.js†L762-L767】
  - Units / spaces: Mode strings only.【F:src/app.js†L762-L767】
  - Determinism: Deterministic control flow; asynchronous reset outcome may vary but is logged on error.【F:src/app.js†L762-L767】
  - Keep / change / delete: Keep; consolidates quit behavior for reuse across inputs.【F:src/app.js†L781-L789】
  - Confidence / assumptions: High confidence; assumes gameplay module tolerates repeated `resetScene` calls.【F:src/app.js†L765-L767】

- `activateMainMenuSelection`
  - Purpose: Executes the action tied to the currently highlighted main-menu option.【F:src/app.js†L769-L779】
  - Inputs: None; reads `state.mainMenuIndex` to determine the active option.【F:src/app.js†L769-L776】
  - Outputs: Returns `undefined`; defers to other helpers for observable outcomes.【F:src/app.js†L769-L779】
  - Side effects: Depending on selection, may trigger vehicle selection, leaderboard, or settings flows via dedicated helpers.【F:src/app.js†L772-L778】
  - Shared state touched and where it’s used: Relies on `state.mainMenuIndex` set elsewhere; primarily called from the main menu key handler on confirm.【F:src/app.js†L769-L778】【F:src/app.js†L879-L895】
  - Dependencies: Calls `showVehicleSelect`, `showLeaderboard`, or `showSettings` based on the option key.【F:src/app.js†L772-L778】
  - Edge cases handled or missed: Gracefully exits if the index is out of range (`!option`); no feedback for unsupported keys.【F:src/app.js†L769-L778】
  - Performance: Constant-time branching.【F:src/app.js†L769-L779】
  - Units / spaces: Uses option keys (`'start'`, `'leaderboard'`, `'settings'`) only.【F:src/app.js†L772-L778】
  - Determinism: Deterministic for a given menu index and options array.【F:src/app.js†L769-L779】
  - Keep / change / delete: Keep; keeps menu behavior centralized rather than scattering conditionals across input handlers.【F:src/app.js†L769-L895】
  - Confidence / assumptions: High confidence; assumes menu options array stays in sync with rendered menu order.【F:src/app.js†L251-L260】【F:src/app.js†L769-L778】

- `activatePauseMenuSelection`
  - Purpose: Executes the selected pause-menu action (resume or quit).【F:src/app.js†L781-L788】
  - Inputs: None; consumes `state.pauseMenuIndex`.【F:src/app.js†L781-L787】
  - Outputs: Returns `undefined`; relies on downstream helpers for observable behavior.【F:src/app.js†L781-L788】
  - Side effects: Calls `resumeRace` or `quitToMenu`, affecting mode and gameplay state.【F:src/app.js†L784-L788】
  - Shared state touched and where it’s used: Reads `state.pauseMenuIndex`; invoked by pause key handling and menu confirmation.【F:src/app.js†L781-L988】【F:src/app.js†L1052-L1062】
  - Dependencies: Calls `resumeRace` or `quitToMenu`.【F:src/app.js†L784-L788】
  - Edge cases handled or missed: Safely no-ops if index is invalid; no handling for additional pause options.【F:src/app.js†L781-L788】
  - Performance: Constant-time.【F:src/app.js†L781-L788】
  - Units / spaces: Works with option keys `'resume'` and `'quit'`.【F:src/app.js†L784-L787】
  - Determinism: Deterministic for a given index state.【F:src/app.js†L781-L788】
  - Keep / change / delete: Keep; isolates pause-menu behaviors for reuse by multiple input paths.【F:src/app.js†L781-L988】【F:src/app.js†L1052-L1062】
  - Confidence / assumptions: High confidence; assumes pause options remain limited to resume/quit until expanded.【F:src/app.js†L314-L322】【F:src/app.js†L781-L788】

- `activateSettingsSelection`
  - Purpose: Applies the settings menu action currently highlighted (toggle snow or leave the menu).【F:src/app.js†L791-L797】
  - Inputs: None; checks `settingsMenuKeys[state.settingsMenuIndex]`.【F:src/app.js†L791-L796】
  - Outputs: Returns `undefined`; relies on invoked helpers for visible outcomes.【F:src/app.js†L791-L797】
  - Side effects: Toggles snow rendering or returns to the main menu depending on selection.【F:src/app.js†L793-L797】
  - Shared state touched and where it’s used: Reads `state.settingsMenuIndex` and writes via `toggleSnowSetting`/`setMode`; triggered from settings key handling.【F:src/app.js†L791-L937】
  - Dependencies: Calls `toggleSnowSetting` or `setMode('menu')`.【F:src/app.js†L793-L797】
  - Edge cases handled or missed: Ignores unknown keys; only two options supported.【F:src/app.js†L791-L797】
  - Performance: Constant-time.【F:src/app.js†L791-L797】
  - Units / spaces: Works with `'snow'` and `'back'` keys only.【F:src/app.js†L793-L796】
  - Determinism: Deterministic for a given selection state.【F:src/app.js†L791-L797】
  - Keep / change / delete: Keep; centralizes side effects for the sparse settings menu.【F:src/app.js†L291-L311】【F:src/app.js†L791-L937】
  - Confidence / assumptions: High confidence; assumes `settingsMenuKeys` mirrors the rendered options order.【F:src/app.js†L291-L311】【F:src/app.js†L791-L797】

- `requestLeaderboard`
  - Purpose: Lazily loads remote leaderboard data, merges it with local entries, and updates loading state for the menu.【F:src/app.js†L800-L828】
  - Inputs: None; acts on `state.leaderboard` internals.【F:src/app.js†L800-L828】
  - Outputs: Returns `undefined`; populates `state.leaderboard.entries`, flags, and highlight metadata asynchronously.【F:src/app.js†L804-L828】
  - Side effects: Sets loading/error flags, triggers UI refreshes, fetches CSV data, parses entries, sorts them, and logs failures.【F:src/app.js†L804-L828】
  - Shared state touched and where it’s used: Mutates `state.leaderboard` fields that feed leaderboard rendering; invoked during initialization and when the leaderboard screen opens.【F:src/app.js†L264-L288】【F:src/app.js†L749-L828】【F:src/app.js†L1127-L1138】
  - Dependencies: Calls `updateMenuLayer`, `fetch`, `parseLeaderboardCsv`, and `sortLeaderboardEntries` (plus Promise chaining).【F:src/app.js†L804-L828】
  - Edge cases handled or missed: Skips fetch if already loading or entries exist; handles HTTP errors and missing/empty CSV, but doesn’t retry or debounce rapid toggling.【F:src/app.js†L800-L828】
  - Performance: Network-bound; otherwise linear in the number of CSV rows for parsing and sorting (delegated).【F:src/app.js†L804-L828】
  - Units / spaces: Treats scores as numeric points and timestamps as CSV strings; no special spatial units.【F:src/app.js†L813-L828】
  - Determinism: Deterministic for identical CSV input; external fetch results introduce variability.【F:src/app.js†L804-L828】
  - Keep / change / delete: Keep; encapsulates leaderboard loading concerns and guards against redundant fetches.【F:src/app.js†L800-L828】
  - Confidence / assumptions: High confidence; assumes CSV schema contains `name`, `points`, and `date` headers or defaults can be applied.【F:src/app.js†L831-L854】

- `parseLeaderboardCsv`
  - Purpose: Converts CSV leaderboard text into normalized entry objects sorted by score (then name) with ranks assigned.【F:src/app.js†L831-L864】
  - Inputs: `text` — raw CSV string; accepts empty/whitespace and gracefully handles missing data.【F:src/app.js†L831-L849】
  - Outputs: Returns an array of leaderboard entries with computed ranks.【F:src/app.js†L842-L864】
  - Side effects: None beyond local computations.【F:src/app.js†L831-L864】
  - Shared state touched and where it’s used: Pure helper invoked during leaderboard fetch to populate `state.leaderboard.entries`.【F:src/app.js†L813-L864】
  - Dependencies: Uses `createLeaderboardEntry` and `recomputeLeaderboardRanks` to build and annotate entries.【F:src/app.js†L850-L864】
  - Edge cases handled or missed: Ignores blank lines, tolerates missing headers by falling back to positional columns, clamps non-numeric scores to zero, but assumes comma separators and no quoted values.【F:src/app.js†L831-L864】
  - Performance: O(n log n) due to sorting after a single pass over rows.【F:src/app.js†L843-L863】
  - Units / spaces: Treats scores as numeric points and ranks as integers; no spatial units.【F:src/app.js†L842-L864】
  - Determinism: Deterministic for a given CSV input; stable tie-breaking via `localeCompare` on names.【F:src/app.js†L857-L863】
  - Keep / change / delete: Keep; isolates CSV parsing logic from network handling.【F:src/app.js†L813-L864】
  - Confidence / assumptions: High confidence; assumes CSV is simple (no embedded commas/quotes).【F:src/app.js†L833-L858】

- `handleMenuNavigation`
  - Purpose: Adjusts the main-menu selection index in response to navigation input.【F:src/app.js†L867-L869】
  - Inputs: `delta` — signed step applied to the menu index.【F:src/app.js†L867-L869】
  - Outputs: Returns `undefined`; delegates to `changeMainMenuSelection`.【F:src/app.js†L867-L869】
  - Side effects: Indirectly changes `state.mainMenuIndex` via the helper.【F:src/app.js†L867-L869】
  - Shared state touched and where it’s used: Ultimately mutates the menu index consumed by rendering; triggered from arrow-key handling.【F:src/app.js†L867-L889】
  - Dependencies: Calls `changeMainMenuSelection`.【F:src/app.js†L867-L869】
  - Edge cases handled or missed: Relies on helper for wraparound/clamping; no direct guards here.【F:src/app.js†L867-L869】
  - Performance: Constant-time.【F:src/app.js†L867-L869】
  - Units / spaces: Treats `delta` as integer step count.【F:src/app.js†L867-L869】
  - Determinism: Deterministic given the same starting state and delta.【F:src/app.js†L867-L869】
  - Keep / change / delete: Keep; preserves separation between navigation intent and index mutation logic.【F:src/app.js†L867-L889】
  - Confidence / assumptions: High confidence; assumes `changeMainMenuSelection` enforces bounds.【F:src/app.js†L867-L869】

- `handlePauseNavigation`
  - Purpose: Moves the pause-menu cursor according to user input.【F:src/app.js†L871-L873】
  - Inputs: `delta` — signed index offset.【F:src/app.js†L871-L873】
  - Outputs: Returns `undefined`; defers to `changePauseMenuSelection`.【F:src/app.js†L871-L873】
  - Side effects: Adjusts `state.pauseMenuIndex` via the helper.【F:src/app.js†L871-L873】
  - Shared state touched and where it’s used: Indirectly updates pause selection consumed by rendering and activation handlers.【F:src/app.js†L871-L986】
  - Dependencies: Calls `changePauseMenuSelection`.【F:src/app.js†L871-L873】
  - Edge cases handled or missed: Leaves wrap/limit behavior to the helper.【F:src/app.js†L871-L873】
  - Performance: Constant-time.【F:src/app.js†L871-L873】
  - Units / spaces: Delta step count only.【F:src/app.js†L871-L873】
  - Determinism: Deterministic per starting index and delta.【F:src/app.js†L871-L873】
  - Keep / change / delete: Keep; mirrors other menu navigation helpers for consistency.【F:src/app.js†L871-L986】
  - Confidence / assumptions: High confidence; assumes helper enforces limits.【F:src/app.js†L871-L873】

- `handleSettingsNavigation`
  - Purpose: Changes the highlighted option within the settings menu.【F:src/app.js†L875-L877】
  - Inputs: `delta` — signed navigation increment.【F:src/app.js†L875-L877】
  - Outputs: Returns `undefined`; passes control to `changeSettingsSelection`.【F:src/app.js†L875-L877】
  - Side effects: Indirectly mutates `state.settingsMenuIndex`.【F:src/app.js†L875-L877】
  - Shared state touched and where it’s used: Affects settings menu rendering and activation; invoked from arrow-key handling.【F:src/app.js†L875-L934】
  - Dependencies: Calls `changeSettingsSelection`.【F:src/app.js†L875-L877】
  - Edge cases handled or missed: Delegates wrapping/bounds to helper.【F:src/app.js†L875-L877】
  - Performance: Constant-time.【F:src/app.js†L875-L877】
  - Units / spaces: Integer step count only.【F:src/app.js†L875-L877】
  - Determinism: Deterministic for same inputs.【F:src/app.js†L875-L877】
  - Keep / change / delete: Keep; maintains symmetry with other navigation helpers.【F:src/app.js†L875-L934】
  - Confidence / assumptions: High confidence; assumes helper covers bounds.【F:src/app.js†L875-L877】

- `handleMenuKeyDown`
  - Purpose: Handles keyboard input on the main menu, supporting navigation and selection.【F:src/app.js†L879-L895】
  - Inputs: `e` — keyboard event; expects `code` property for arrow/space/enter keys.【F:src/app.js†L879-L895】
  - Outputs: Returns `true` when an input is consumed; otherwise `false`.【F:src/app.js†L879-L895】
  - Side effects: Updates menu selection, triggers activation, and prevents default browser behavior for handled keys.【F:src/app.js†L881-L894】
  - Shared state touched and where it’s used: Mutates selection via navigation helper; invoked from the global keydown dispatcher when in menu mode.【F:src/app.js†L879-L895】【F:src/app.js†L1075-L1089】
  - Dependencies: Calls `handleMenuNavigation` and `activateMainMenuSelection`.【F:src/app.js†L881-L892】
  - Edge cases handled or missed: Blocks arrow keys even if they don’t change selection; ignores other keys without side effects.【F:src/app.js†L879-L895】
  - Performance: Constant-time.【F:src/app.js†L879-L895】
  - Units / spaces: Works with keyboard `code` strings only.【F:src/app.js†L879-L895】
  - Determinism: Deterministic for a given event and menu state.【F:src/app.js†L879-L895】
  - Keep / change / delete: Keep; encapsulates menu key handling separate from global dispatch.【F:src/app.js†L879-L895】【F:src/app.js†L1075-L1089】
  - Confidence / assumptions: High confidence; assumes `preventDefault` is sufficient to stop browser scrolling.【F:src/app.js†L881-L894】

- `handleLeaderboardKeyDown`
  - Purpose: Processes inputs on the leaderboard screen, allowing dismissal and disabling navigation keys.【F:src/app.js†L898-L909】
  - Inputs: `e` — keyboard event focused on `code` for space/enter/escape/arrows.【F:src/app.js†L898-L907】
  - Outputs: Returns `true` when handled; otherwise `false`.【F:src/app.js†L898-L909】
  - Side effects: Returns to the main menu on confirmation keys and prevents default browser behavior for all targeted keys.【F:src/app.js†L898-L907】
  - Shared state touched and where it’s used: Delegates to `setMode('menu')`; invoked from the global keydown router in leaderboard mode.【F:src/app.js†L898-L907】【F:src/app.js†L1078-L1089】
  - Dependencies: Calls `setMode`.【F:src/app.js†L900-L907】
  - Edge cases handled or missed: Consumes arrow keys even though they have no effect; offers no paging or scrolling.【F:src/app.js†L904-L907】
  - Performance: Constant-time.【F:src/app.js†L898-L907】
  - Units / spaces: Keyboard codes only.【F:src/app.js†L898-L907】
  - Determinism: Deterministic for same event and state.【F:src/app.js†L898-L909】
  - Keep / change / delete: Keep; minimal but sufficient event handling for the static leaderboard view.【F:src/app.js†L898-L907】【F:src/app.js†L1078-L1089】
  - Confidence / assumptions: High confidence; assumes leaving the screen should always return to the main menu.【F:src/app.js†L900-L907】

- `handleSettingsKeyDown`
  - Purpose: Handles keyboard interaction on the settings menu, covering navigation, toggles, and exit.【F:src/app.js†L911-L940】
  - Inputs: `e` — keyboard event leveraging arrow, space, enter, and escape codes.【F:src/app.js†L911-L939】
  - Outputs: Returns `true` when the event is handled; otherwise `false`.【F:src/app.js†L911-L940】
  - Side effects: Adjusts selection, toggles snow setting, activates entries, and prevents default browser behavior.【F:src/app.js†L913-L938】
  - Shared state touched and where it’s used: Reads/writes settings indices and toggles; invoked from global keydown when in settings mode.【F:src/app.js†L911-L938】【F:src/app.js†L1078-L1089】
  - Dependencies: Calls `handleSettingsNavigation`, `toggleSnowSetting`, `activateSettingsSelection`, and `setMode`.【F:src/app.js†L913-L937】
  - Edge cases handled or missed: Consumes left/right even when not on a toggleable option; doesn’t support analog adjustments or additional options.【F:src/app.js†L923-L928】
  - Performance: Constant-time.【F:src/app.js†L911-L938】
  - Units / spaces: Works purely with keyboard codes and mode strings.【F:src/app.js†L911-L937】
  - Determinism: Deterministic for identical events and state.【F:src/app.js†L911-L940】
  - Keep / change / delete: Keep; concentrates all settings key handling logic for clarity.【F:src/app.js†L911-L938】【F:src/app.js†L1078-L1089】
  - Confidence / assumptions: High confidence; assumes only the snow toggle responds to left/right inputs.【F:src/app.js†L923-L928】

- `handleVehicleSelectKeyDown`
  - Purpose: Manages keyboard input on the vehicle selection screen, including cycling options and confirming choices.【F:src/app.js†L943-L968】
  - Inputs: `e` — keyboard event for arrow, space, enter, and escape codes.【F:src/app.js†L943-L967】
  - Outputs: Returns `true` when the key is handled; otherwise `false`.【F:src/app.js†L943-L968】
  - Side effects: Changes selected vehicle, triggers activation, and prevents default behavior for navigation keys.【F:src/app.js†L945-L966】
  - Shared state touched and where it’s used: Mutates selection indices and may kick off race start; invoked by the global keydown router when in vehicle-select mode.【F:src/app.js†L943-L966】【F:src/app.js†L1076-L1089】
  - Dependencies: Calls `changeVehicleSelection`, `activateVehicleSelection`, and `setMode`.【F:src/app.js†L945-L960】
  - Edge cases handled or missed: Blocks vertical arrows despite no vertical menu; relies on helper for bounds; no mouse/gamepad handling here.【F:src/app.js†L964-L966】
  - Performance: Constant-time.【F:src/app.js†L943-L966】
  - Units / spaces: Works with keyboard codes and option indices.【F:src/app.js†L943-L966】
  - Determinism: Deterministic for the same input and selection state.【F:src/app.js†L943-L968】
  - Keep / change / delete: Keep; contains all keyboard interactions for vehicle selection.【F:src/app.js†L943-L966】【F:src/app.js†L1076-L1089】
  - Confidence / assumptions: High confidence; assumes vehicle list is non-empty and helpers wrap safely.【F:src/app.js†L325-L342】【F:src/app.js†L943-L966】

- `handlePauseKeyDown`
  - Purpose: Responds to keyboard input while the pause menu is visible, covering navigation, confirmation, and quick resume.【F:src/app.js†L971-L993】
  - Inputs: `e` — keyboard event for arrow, space, enter, and escape codes.【F:src/app.js†L971-L991】
  - Outputs: Returns `true` when the event is consumed; otherwise `false`.【F:src/app.js†L971-L993】
  - Side effects: Moves the pause selection, activates items, resumes play via escape, and prevents browser defaults.【F:src/app.js†L973-L990】
  - Shared state touched and where it’s used: Mutates pause selection via helper and interacts with resume/quit flows; dispatched from the global keydown handler while paused.【F:src/app.js†L971-L990】【F:src/app.js†L1084-L1089】
  - Dependencies: Calls `handlePauseNavigation`, `activatePauseMenuSelection`, and `resumeRace`.【F:src/app.js†L973-L989】
  - Edge cases handled or missed: Escape always resumes even if already on resume; no direct support for extra menu options.【F:src/app.js†L987-L990】
  - Performance: Constant-time.【F:src/app.js†L971-L990】
  - Units / spaces: Keyboard codes and option indices only.【F:src/app.js†L971-L990】
  - Determinism: Deterministic for the same event/state.【F:src/app.js†L971-L993】
  - Keep / change / delete: Keep; required to make the pause overlay interactive.【F:src/app.js†L971-L990】【F:src/app.js†L1084-L1089】
  - Confidence / assumptions: High confidence; assumes pause options remain resume/quit and escape should always resume.【F:src/app.js†L314-L322】【F:src/app.js†L987-L990】

- `handleRaceCompleteKeyDown`
  - Purpose: Drives the race-complete input flow, handling name entry, advancing the celebration, and exiting to attract mode.【F:src/app.js†L995-L1034】
  - Inputs: `e` — keyboard event using escape, space, enter, and arrow codes.【F:src/app.js†L995-L1033】
  - Outputs: Returns `true` when handled; otherwise `false`.【F:src/app.js†L995-L1034】
  - Side effects: Routes to attract mode, edits the active name letter, locks characters, or advances the post-race sequence; prevents default behavior on handled keys.【F:src/app.js†L998-L1032】
  - Shared state touched and where it’s used: Reads and mutates `state.raceComplete`; dispatched from the global keydown router in race-complete mode.【F:src/app.js†L995-L1032】【F:src/app.js†L1086-L1089】
  - Dependencies: Calls `goToAttract`, `adjustCurrentNameLetter`, `lockCurrentNameLetter`, and `advanceRaceCompleteSequence`.【F:src/app.js†L998-L1032】
  - Edge cases handled or missed: Allows escape to abort even before saving; only supports three-letter cycling with arrows; no validation for duplicate letters.【F:src/app.js†L1002-L1032】
  - Performance: Constant-time operations per key press.【F:src/app.js†L995-L1032】
  - Units / spaces: Works with keyboard codes and name-letter indices.【F:src/app.js†L995-L1032】
  - Determinism: Deterministic for same state and inputs.【F:src/app.js†L995-L1034】
  - Keep / change / delete: Keep; consolidates the multi-phase race completion controls.【F:src/app.js†L995-L1032】【F:src/app.js†L1086-L1089】
  - Confidence / assumptions: High confidence; assumes race-complete state machine uses `active`/`phase` as documented.【F:src/app.js†L995-L1032】

- `handleAttractKeyDown`
  - Purpose: Lets any key press during attract mode return players to the main menu.【F:src/app.js†L1036-L1040】
  - Inputs: `e` — keyboard event; any key is treated the same.【F:src/app.js†L1036-L1039】
  - Outputs: Always returns `true` after handling.【F:src/app.js†L1036-L1040】
  - Side effects: Switches the app mode to `'menu'` and prevents browser defaults.【F:src/app.js†L1036-L1039】
  - Shared state touched and where it’s used: Updates mode for rendering; invoked from the global keydown dispatcher in attract mode.【F:src/app.js†L1036-L1039】【F:src/app.js†L1088-L1089】
  - Dependencies: Calls `setMode`.【F:src/app.js†L1036-L1039】
  - Edge cases handled or missed: No differentiation by key; ignores potential video playback state aside from mode change.【F:src/app.js†L1036-L1039】
  - Performance: Constant-time.【F:src/app.js†L1036-L1039】
  - Units / spaces: Mode string only.【F:src/app.js†L1036-L1039】
  - Determinism: Deterministic for any event.【F:src/app.js†L1036-L1040】
  - Keep / change / delete: Keep; ensures quick exit from attract loop on input.【F:src/app.js†L1036-L1039】【F:src/app.js†L1088-L1089】
  - Confidence / assumptions: High confidence; assumes any attract-mode key should re-enter the menu.【F:src/app.js†L1036-L1039】

- `handleKeyDown`
  - Purpose: Acts as the global keyboard dispatcher, handling debug toggles, pause shortcut, gameplay forwarding, and routing to mode-specific handlers.【F:src/app.js†L1042-L1095】
  - Inputs: `e` — keyboard event for all gameplay and menu interactions.【F:src/app.js†L1042-L1094】
  - Outputs: Returns `undefined`; may stop propagation by preventing default on handled keys.【F:src/app.js†L1042-L1094】
  - Side effects: Toggles debug mode, manages pause state, marks user interaction timestamps, delegates to gameplay handlers, and prevents default behavior for navigation keys when unhandled.【F:src/app.js†L1043-L1094】
  - Shared state touched and where it’s used: Mutates debug setting, mode, and interaction timestamp; registered with DOM via bootstrap to process all keydown events.【F:src/app.js†L1042-L1094】【F:src/bootstrap.js†L67-L75】
  - Dependencies: Calls `toggleDebugSetting`, `markInteraction`, `setMode`, `resetGameplayInputs`, `resumeRace`, various mode-specific handlers, and `Gameplay.keydownHandler`.【F:src/app.js†L1043-L1094】
  - Edge cases handled or missed: Treats `KeyP` specially during gameplay/pause but ignores it elsewhere; prevents arrow/space defaults even when no handler consumed the key.【F:src/app.js†L1043-L1094】
  - Performance: Constant-time dispatch with minimal branching; executed on every keydown.【F:src/app.js†L1042-L1094】
  - Units / spaces: Uses milliseconds indirectly via `markInteraction` (updates timestamp) and relies on keyboard `code` strings.【F:src/app.js†L1042-L1094】
  - Determinism: Deterministic for a given state and key event.【F:src/app.js†L1042-L1095】
  - Keep / change / delete: Keep; required as the top-level event handler bound by bootstrap.【F:src/app.js†L1042-L1094】【F:src/bootstrap.js†L67-L75】
  - Confidence / assumptions: High confidence; assumes gameplay exposes compatible `keydownHandler`.【F:src/app.js†L1070-L1094】

- `handleKeyUp`
  - Purpose: Forwards keyup events to gameplay while suppressing the pause shortcut release.【F:src/app.js†L1097-L1104】
  - Inputs: `e` — keyboard event; only processed in `'playing'` mode.【F:src/app.js†L1097-L1103】
  - Outputs: Returns `undefined`.【F:src/app.js†L1097-L1104】
  - Side effects: Calls into `Gameplay.keyupHandler` for active gameplay keys.【F:src/app.js†L1097-L1103】
  - Shared state touched and where it’s used: Depends on `state.mode`; registered globally by bootstrap alongside `handleKeyDown`.【F:src/app.js†L1097-L1103】【F:src/bootstrap.js†L70-L75】
  - Dependencies: Calls `Gameplay.keyupHandler`.【F:src/app.js†L1097-L1103】
  - Edge cases handled or missed: Ignores `KeyP` release to avoid unpausing; other modes swallow keyup entirely, so menu interactions rely solely on keydown.【F:src/app.js†L1097-L1103】
  - Performance: Constant-time.【F:src/app.js†L1097-L1103】
  - Units / spaces: Keyboard codes only.【F:src/app.js†L1097-L1103】
  - Determinism: Deterministic for the same mode and event.【F:src/app.js†L1097-L1104】
  - Keep / change / delete: Keep; necessary for gameplay control parity with the bootstrap fallback.【F:src/app.js†L1097-L1103】【F:src/bootstrap.js†L70-L75】
  - Confidence / assumptions: High confidence; assumes gameplay consumes keyup events appropriately.【F:src/app.js†L1097-L1103】

- `step`
  - Purpose: Runs the per-frame update loop, delegating to gameplay, race-complete animations, vehicle previews, and idle-attract timeout logic.【F:src/app.js†L1106-L1125】
  - Inputs: `dt` — frame delta time in seconds (as provided by `Renderer.frame`).【F:src/app.js†L1106-L1119】【F:src/bootstrap.js†L77-L83】
  - Outputs: Returns `undefined`; orchestrates side effects each frame.【F:src/app.js†L1106-L1125】
  - Side effects: Calls gameplay stepping, race-complete updater, vehicle preview animation, and transitions to attract mode when idle.【F:src/app.js†L1106-L1122】
  - Shared state touched and where it’s used: Reads/updates `state.mode`, `state.raceComplete`, and `state.lastInteractionAt`; invoked every frame via bootstrap’s render loop.【F:src/app.js†L1106-L1122】【F:src/bootstrap.js†L77-L83】
  - Dependencies: Calls `Gameplay.step`, `updateRaceComplete`, `updateVehiclePreviewAnimation`, `now`, and `goToAttract`.【F:src/app.js†L1106-L1122】
  - Edge cases handled or missed: Suppresses idle timeout while the player is actively finalizing race results; does not clamp `dt` spikes.【F:src/app.js†L1110-L1122】
  - Performance: Linear in work delegated to gameplay and animation helpers; executed once per frame.【F:src/app.js†L1106-L1122】
  - Units / spaces: Uses seconds for `dt` and milliseconds for idle timeout comparisons via `now()`.【F:src/app.js†L1106-L1121】
  - Determinism: Deterministic given the same state, elapsed time, and helper determinism (except any randomness inside delegates).【F:src/app.js†L1106-L1122】
  - Keep / change / delete: Keep; it is the application’s frame driver registered with the renderer.【F:src/app.js†L1106-L1122】【F:src/bootstrap.js†L77-L83】
  - Confidence / assumptions: High confidence; assumes helpers handle their own timing nuances (e.g., `updateRaceComplete`).【F:src/app.js†L1106-L1122】

- `init`
  - Purpose: Performs one-time application bootstrap: wiring DOM references, resetting state, applying selections, and loading the leaderboard.【F:src/app.js†L1127-L1138】
  - Inputs: None.【F:src/app.js†L1127-L1138】
  - Outputs: Returns `undefined`; establishes initial app state.【F:src/app.js†L1127-L1138】
  - Side effects: Ensures DOM nodes exist, resets menu indices and race-complete state, applies saved vehicle/debug settings, sets mode to menu, and triggers leaderboard loading.【F:src/app.js†L1127-L1138】
  - Shared state touched and where it’s used: Initializes fields read throughout the app; invoked from bootstrap after assets are wired.【F:src/app.js†L1127-L1138】【F:src/bootstrap.js†L57-L63】
  - Dependencies: Calls `ensureDom`, `resetRaceCompleteState`, `applyVehicleSelection`, `applyDebugModeSetting`, `setMode`, and `requestLeaderboard`.【F:src/app.js†L1127-L1138】
  - Edge cases handled or missed: Throws if required DOM elements are absent; assumes asset/manifests already loaded before invocation.【F:src/app.js†L237-L249】【F:src/app.js†L1127-L1138】
  - Performance: One-time setup with constant work aside from leaderboard fetch kicked off afterward.【F:src/app.js†L1127-L1138】
  - Units / spaces: Initializes timestamps in milliseconds via `now()`; other values are indices and booleans.【F:src/app.js†L1129-L1137】
  - Determinism: Deterministic given the same persisted state and helper behavior.【F:src/app.js†L1127-L1138】
  - Keep / change / delete: Keep; canonical entry point for app startup.【F:src/app.js†L1127-L1138】【F:src/bootstrap.js†L57-L63】
  - Confidence / assumptions: High confidence; assumes helper functions succeed (vehicle selection, debug application).【F:src/app.js†L1127-L1138】

- `isSnowEnabled`
  - Purpose: Exposes whether snow effects should be active based on app settings.【F:src/app.js†L1140-L1142】
  - Inputs: None.【F:src/app.js†L1140-L1142】
  - Outputs: Returns a boolean indicating the snow toggle state.【F:src/app.js†L1140-L1142】
  - Side effects: None; pure getter.【F:src/app.js†L1140-L1142】
  - Shared state touched and where it’s used: Reads `state.settings.snowEnabled`; queried by the renderer when deciding whether to spawn snow particles.【F:src/app.js†L1140-L1142】【F:src/render.js†L416-L426】
  - Dependencies: None beyond accessing `state`.【F:src/app.js†L1140-L1142】
  - Edge cases handled or missed: Coerces to boolean; no persistence handling here.【F:src/app.js†L1140-L1142】
  - Performance: Constant-time.【F:src/app.js†L1140-L1142】
  - Units / spaces: Boolean flag only.【F:src/app.js†L1140-L1142】
  - Determinism: Deterministic for a given state.【F:src/app.js†L1140-L1142】
  - Keep / change / delete: Keep; provides stable contract for render systems checking snow feature availability.【F:src/app.js†L1140-L1142】【F:src/render.js†L416-L426】
  - Confidence / assumptions: High confidence; assumes settings state is kept in sync with UI toggles.【F:src/app.js†L793-L797】【F:src/app.js†L1140-L1142】

- `isDebugEnabled`
  - Purpose: Reports whether debug overlays should be visible based on settings.【F:src/app.js†L1144-L1146】
  - Inputs: None.【F:src/app.js†L1144-L1146】
  - Outputs: Returns a boolean reflecting the debug toggle.【F:src/app.js†L1144-L1146】
  - Side effects: None; pure getter.【F:src/app.js†L1144-L1146】
  - Shared state touched and where it’s used: Reads `state.settings.debugEnabled`; renderer queries it to decide whether to show overlays.【F:src/app.js†L1144-L1146】【F:src/render.js†L554-L577】
  - Dependencies: None beyond state access.【F:src/app.js†L1144-L1146】
  - Edge cases handled or missed: Coerces to boolean; assumes state exists.【F:src/app.js†L1144-L1146】
  - Performance: Constant-time.【F:src/app.js†L1144-L1146】
  - Units / spaces: Boolean flag only.【F:src/app.js†L1144-L1146】
  - Determinism: Deterministic for a given state.【F:src/app.js†L1144-L1146】
  - Keep / change / delete: Keep; necessary for render overlay toggling without exposing entire state object.【F:src/app.js†L1144-L1146】【F:src/render.js†L554-L577】
  - Confidence / assumptions: High confidence; assumes debug setting is maintained by menu/debug shortcut flows.【F:src/app.js†L699-L709】【F:src/app.js†L1043-L1057】【F:src/app.js†L1144-L1146】

### 3.2 UI Screen Templates (`src/ui/screens.js`)
- `ensureEscapeHtml`
  - Purpose: Supplies a safe HTML-escaping helper, defaulting to a simple string conversion when none is provided.【F:src/ui/screens.js†L4-L6】
  - Inputs: `helpers` — optional object that may contain an `escapeHtml` function; any other shape falls back to a default converter.【F:src/ui/screens.js†L4-L6】
  - Outputs: Returns an escape function used by screen templates to sanitize text.【F:src/ui/screens.js†L4-L6】
  - Side effects: None; pure helper.【F:src/ui/screens.js†L4-L6】
  - Shared state touched and where it’s used: Independent function leveraged by every screen factory when preparing strings.【F:src/ui/screens.js†L8-L296】
  - Dependencies: None beyond optional helper injection.【F:src/ui/screens.js†L4-L6】
  - Edge cases handled or missed: Falls back gracefully when helpers are null/undefined; does not escape HTML beyond simple string coercion if no helper provided.【F:src/ui/screens.js†L4-L6】
  - Performance: Constant-time; returned function performance depends on provided helper.【F:src/ui/screens.js†L4-L6】
  - Units / spaces: Works with text strings only.【F:src/ui/screens.js†L4-L6】
  - Determinism: Deterministic for a given helper input.【F:src/ui/screens.js†L4-L6】
  - Keep / change / delete: Keep; centralizes escape helper fallback for all templates.【F:src/ui/screens.js†L4-L6】【F:src/ui/screens.js†L8-L296】
  - Confidence / assumptions: High confidence; assumes callers provide well-behaved escape functions when needed.【F:src/ui/screens.js†L4-L6】

- `mainMenuScreen`
  - Purpose: Renders the main menu HTML structure using provided titles and options, highlighting the selected entry.【F:src/ui/screens.js†L8-L37】
  - Inputs: `ctx` (`title`, `subtitle`, `options`, `selectedIndex`) and optional `helpers` (escape function).【F:src/ui/screens.js†L8-L26】
  - Outputs: Returns an HTML string for the main menu, including list items and hints.【F:src/ui/screens.js†L16-L36】
  - Side effects: None; pure template generator.【F:src/ui/screens.js†L8-L36】
  - Shared state touched and where it’s used: Consumed by `renderMainMenu()` to populate the menu layer in menu mode.【F:src/ui/screens.js†L8-L36】【F:src/app.js†L251-L260】【F:src/app.js†L391-L405】
  - Dependencies: Uses `ensureEscapeHtml` for sanitization.【F:src/ui/screens.js†L10-L24】
  - Edge cases handled or missed: Defaults missing strings to empty values and tolerates absent options, resulting in an empty list; does not localize hints.【F:src/ui/screens.js†L16-L35】
  - Performance: Iterates once over options to build list items.【F:src/ui/screens.js†L16-L27】
  - Units / spaces: Pure HTML markup; uses `is-selected` CSS class to denote selection.【F:src/ui/screens.js†L20-L25】
  - Determinism: Deterministic for the same context data.【F:src/ui/screens.js†L8-L36】
  - Keep / change / delete: Keep; core template used whenever the main menu is shown.【F:src/ui/screens.js†L8-L36】【F:src/app.js†L251-L260】
  - Confidence / assumptions: High confidence; assumes options array items contain `key`/`label` strings.【F:src/ui/screens.js†L16-L25】

- `pauseMenuScreen`
  - Purpose: Generates HTML for the pause menu, displaying available pause actions and the current selection.【F:src/ui/screens.js†L39-L63】
  - Inputs: `ctx` (`options`, `selectedIndex`) plus optional `helpers` with escape function.【F:src/ui/screens.js†L39-L53】
  - Outputs: Returns an HTML string with a title, option list, and control hint.【F:src/ui/screens.js†L43-L61】
  - Side effects: None; pure template.【F:src/ui/screens.js†L39-L61】
  - Shared state touched and where it’s used: Rendered by `renderPauseMenu()` when the app enters pause mode.【F:src/ui/screens.js†L39-L61】【F:src/app.js†L314-L322】【F:src/app.js†L391-L409】
  - Dependencies: Uses `ensureEscapeHtml`.【F:src/ui/screens.js†L41-L52】
  - Edge cases handled or missed: Gracefully handles empty options list (renders nothing inside `<ul>`); hint text is hard-coded.【F:src/ui/screens.js†L43-L61】
  - Performance: Linear over provided options.【F:src/ui/screens.js†L43-L54】
  - Units / spaces: HTML markup only with `is-selected` class toggles.【F:src/ui/screens.js†L47-L52】
  - Determinism: Deterministic for identical inputs.【F:src/ui/screens.js†L39-L63】
  - Keep / change / delete: Keep; required to render the pause overlay.【F:src/ui/screens.js†L39-L61】【F:src/app.js†L314-L322】
  - Confidence / assumptions: High confidence; assumes options include `key` and `label` values.【F:src/ui/screens.js†L43-L52】

- `vehicleSelectScreen`
  - Purpose: Builds the vehicle selection UI markup, including preview metadata for animations and contextual labels.【F:src/ui/screens.js†L65-L175】
  - Inputs: `ctx` fields (`title`, `vehicleLabel`, `vehicleDescription`, `optionIndex`, `optionCount`, `previewSrc`, `previewAtlas`) and optional `helpers` (`escapeHtml`, `resolveAssetUrl`).【F:src/ui/screens.js†L65-L112】
  - Outputs: Returns an HTML string with vehicle details, preview container, navigation hints, and counter text.【F:src/ui/screens.js†L99-L175】
  - Side effects: None; pure templating.【F:src/ui/screens.js†L65-L175】
  - Shared state touched and where it’s used: Consumed by `renderVehicleSelect()` to display selection UI when picking a car.【F:src/ui/screens.js†L65-L175】【F:src/app.js†L325-L342】【F:src/app.js†L391-L411】
  - Dependencies: Relies on `ensureEscapeHtml` and optional asset resolver helper for preview URLs.【F:src/ui/screens.js†L75-L118】
  - Edge cases handled or missed: Safely handles missing preview data, clamps option index/count, and only marks previews as animated when atlas metadata is complete; does not validate atlas integrity beyond numeric checks.【F:src/ui/screens.js†L80-L175】
  - Performance: Constant-time string assembly with a few arithmetic operations; no loops beyond small attribute list.【F:src/ui/screens.js†L98-L165】
  - Units / spaces: Uses counts for option indices, frame duration in seconds, and CSS custom properties for columns/rows; coordinates remain in CSS space.【F:src/ui/screens.js†L90-L160】
  - Determinism: Deterministic for the same context data.【F:src/ui/screens.js†L65-L175】
  - Keep / change / delete: Keep; encapsulates complex preview markup separate from logic.【F:src/ui/screens.js†L65-L175】【F:src/app.js†L325-L342】
  - Confidence / assumptions: High confidence; assumes atlas metadata follows expected structure when provided.【F:src/ui/screens.js†L81-L110】
- `settingsMenuScreen`
  - Purpose: Generates the Settings menu HTML, listing each configurable option and highlighting the current selection so the UI can be rendered without manual DOM manipulation.【F:src/ui/screens.js†L147-L175】
  - Inputs: `ctx` — expects `{ options, selectedIndex }` where `options` is an array of menu option objects (falls back to `[]`) and `selectedIndex` is the zero-based highlighted entry; `helpers` — optional object supplying `escapeHtml` for sanitization.【F:src/ui/screens.js†L147-L165】
  - Outputs: Returns an HTML string containing the Settings menu wrapper, option list, and control hint.【F:src/ui/screens.js†L168-L174】
  - Side effects: None; pure string builder.【F:src/ui/screens.js†L147-L174】
  - Shared state touched and where it’s used: None; invoked by `renderSettings()` when the app is in the settings mode to populate the overlay.【F:src/app.js†L291-L311】
  - Dependencies: Uses `ensureEscapeHtml` to obtain a safe text encoder before interpolating labels and values.【F:src/ui/screens.js†L149-L157】
  - Edge cases handled or missed: Safely handles missing options, blank keys, or values by defaulting to empty strings and omitting value spans; does not guard against duplicate option keys or non-string labels.【F:src/ui/screens.js†L151-L166】
  - Performance: Iterates once over the provided options to assemble list items; runs on demand when the settings screen renders.【F:src/ui/screens.js†L151-L166】
  - Units / spaces: Outputs semantic HTML using CSS classes for layout; no numeric unit conversions occur.【F:src/ui/screens.js†L168-L173】
  - Determinism: Deterministic given the same `ctx` and helper inputs, since it only formats provided data.【F:src/ui/screens.js†L147-L174】
  - Keep / change / delete: Keep; consolidates settings menu markup instead of duplicating template code elsewhere.
  - Confidence / assumptions: High confidence; assumes callers pass option objects with `key`, `label`, and optional `value` fields.

- `leaderboardScreen`
  - Purpose: Renders the leaderboard screen with loading/error/empty states so the UI communicates progress and results.【F:src/ui/screens.js†L177-L214】
  - Inputs: `ctx` — expects `{ loading, error, entries }` where `entries` is an array of objects with `rank`, `name`, `score`, and optional `isHighlight`; `helpers` — optional `escapeHtml` provider.【F:src/ui/screens.js†L177-L205】
  - Outputs: Returns an HTML string with a leaderboard title, message or list, and navigation hint.【F:src/ui/screens.js†L207-L213】
  - Side effects: None; purely formats strings.【F:src/ui/screens.js†L177-L213】
  - Shared state touched and where it’s used: None; consumed by `renderLeaderboard()` to fill the menu panel during leaderboard mode.【F:src/app.js†L281-L288】
  - Dependencies: Relies on `ensureEscapeHtml` to sanitize interpolated fields before embedding them in the markup.【F:src/ui/screens.js†L179-L203】
  - Edge cases handled or missed: Provides fallback messages for loading, fetch errors, and empty datasets; highlights entries via `isHighlight`; does not paginate long leaderboards.【F:src/ui/screens.js†L181-L205】
  - Performance: Maps over the supplied entry list once; invoked when the leaderboard is displayed.【F:src/ui/screens.js†L188-L205】
  - Units / spaces: Outputs HTML structure and CSS classes only; no numeric unit conversions.【F:src/ui/screens.js†L207-L213】
  - Determinism: Deterministic for a given input context and helper functions.【F:src/ui/screens.js†L177-L213】
  - Keep / change / delete: Keep; centralizes leaderboard templating rather than scattering markup across the app.
  - Confidence / assumptions: High confidence; assumes entries provide stringifiable ranks, names, and scores.

- `attractScreen`
  - Purpose: Produces the attract-mode video container so the game can loop a promotional clip when idle.【F:src/ui/screens.js†L216-L229】
  - Inputs: `ctx` — optional object with `videoSrc`, defaulting to the bundled attract-loop MP4.【F:src/ui/screens.js†L216-L224】
  - Outputs: Returns HTML for a full-screen video element with the configured source.【F:src/ui/screens.js†L222-L227】
  - Side effects: None; returns a string only.【F:src/ui/screens.js†L216-L228】
  - Shared state touched and where it’s used: None; rendered by `renderAttract()` when the application enters attract mode.【F:src/app.js†L346-L347】
  - Dependencies: No helper dependencies beyond template literals.【F:src/ui/screens.js†L216-L228】
  - Edge cases handled or missed: Omits the `<source>` tag when `videoSrc` is falsy; assumes MP4 encoding and does not expose playback controls.【F:src/ui/screens.js†L216-L226】
  - Performance: Constant work—only string interpolation; called when entering attract mode.【F:src/ui/screens.js†L216-L228】
  - Units / spaces: Generates HTML with CSS classes for layout; no numeric units handled.【F:src/ui/screens.js†L222-L227】
  - Determinism: Deterministic given the same `videoSrc` input.【F:src/ui/screens.js†L216-L228】
  - Keep / change / delete: Keep; isolates attract-mode markup from the controller logic.
  - Confidence / assumptions: High confidence; assumes the provided video path is valid and autoplay is acceptable.

- `raceCompleteScreen`
  - Purpose: Builds the race-complete UI, covering the preparation, name-entry, and results phases so players understand post-race flow.【F:src/ui/screens.js†L231-L296】
  - Inputs: `ctx` — object with `active`, `phase`, `timeLabel`, `letters`, `confirmed`, `currentIndex`, and `playerRank`; `helpers` — optional `escapeHtml` provider.【F:src/ui/screens.js†L231-L288】
  - Outputs: Returns HTML for the active race-complete screen, including prompts, timers, and rank readouts.【F:src/ui/screens.js†L244-L294】
  - Side effects: None; string generation only.【F:src/ui/screens.js†L231-L296】
  - Shared state touched and where it’s used: None; invoked by `renderRaceComplete()` whenever the app is in the race-complete mode to display status.【F:src/app.js†L351-L359】
  - Dependencies: Uses `ensureEscapeHtml` to sanitize user-entered letters and labels.【F:src/ui/screens.js†L241-L288】
  - Edge cases handled or missed: Displays a waiting message while inactive, highlights the current name-entry slot, and copes with missing rank/time strings; does not enforce character limits beyond the provided `letters` array.【F:src/ui/screens.js†L243-L287】
  - Performance: Maps over the `letters` array once per render; otherwise constant time and used only when the race-complete overlay is visible.【F:src/ui/screens.js†L252-L268】
  - Units / spaces: Renders HTML markup and CSS classes; no numeric units beyond textual rank/time labels.【F:src/ui/screens.js†L244-L294】
  - Determinism: Deterministic for a given context and helper set.【F:src/ui/screens.js†L231-L296】
  - Keep / change / delete: Keep; encapsulates nuanced race completion states without complicating controller logic.
  - Confidence / assumptions: High confidence; assumes controller supplies consistent `phase` strings and letter arrays.

### 3.3 Asset Loading & Bootstrapping (`src/bootstrap.js`)
- `loadManifestTextures`
  - Purpose: Asynchronously loads every texture listed in a manifest and registers it with the renderer so later systems can reference GPU resources by key.【F:src/bootstrap.js†L18-L27】
  - Inputs: `manifest` — object mapping texture keys to relative URLs; accepts `null`/`undefined` by treating them as an empty manifest.【F:src/bootstrap.js†L18-L24】
  - Outputs: Returns a promise that resolves once all textures are queued and stored; no direct return data on completion.【F:src/bootstrap.js†L18-L27】
  - Side effects: Populates `World.assets.textures` with loaded WebGL textures, enabling lookups by other modules.【F:src/bootstrap.js†L24-L27】
  - Shared state touched and where it’s used: Writes into `World.assets.textures`, which sprite metadata resolvers use to fetch materials when spawning sprites.【F:src/gameplay.js†L388-L399】
  - Dependencies: Uses `World.resolveAssetUrl` for path resolution when available and `glr.loadTexture` to fetch GPU-ready textures in parallel via `Promise.all`.【F:src/bootstrap.js†L21-L26】
  - Edge cases handled or missed: Skips work when the manifest is empty; does not retry or catch failed texture loads, so rejections propagate to callers.【F:src/bootstrap.js†L19-L27】
  - Performance: Issues concurrent loads for every manifest entry; invoked during startup so cost scales with manifest size.【F:src/bootstrap.js†L19-L27】
  - Units / spaces: Handles URL strings and WebGL texture objects; no numeric unit translation.【F:src/bootstrap.js†L21-L26】
  - Determinism: Deterministic for identical manifests and asset servers, though outcomes depend on network availability.
  - Keep / change / delete: Keep; isolates manifest loading logic and parallelization from higher-level bootstrap code.
  - Confidence / assumptions: High confidence; assumes manifests map to valid URLs and `glr.loadTexture` rejects on failure.

- `loadAssets`
  - Purpose: Coordinates startup asset loading by processing the core manifest and any sprite-catalog textures so rendering has everything it needs before the game starts.【F:src/bootstrap.js†L30-L35】
  - Inputs: None; reads manifests from global `World.assets` and optional `SpriteCatalog`.【F:src/bootstrap.js†L31-L34】
  - Outputs: Returns a promise that resolves after all manifest textures finish loading.【F:src/bootstrap.js†L30-L35】
  - Side effects: Triggers `loadManifestTextures`, thereby filling `World.assets.textures` for use by gameplay and rendering systems.【F:src/bootstrap.js†L31-L35】
  - Shared state touched and where it’s used: Ensures textures referenced by sprite metadata (e.g., vehicle and signage materials) are present before scene reset occurs.【F:src/gameplay.js†L388-L399】【F:src/bootstrap.js†L57-L65】
  - Dependencies: Calls `loadManifestTextures` twice—once for the world manifest and again for any sprite-catalog-defined textures.【F:src/bootstrap.js†L31-L34】
  - Edge cases handled or missed: Safely skips sprite-catalog loading when the API is unavailable; does not debounce duplicate keys across manifests.【F:src/bootstrap.js†L31-L35】
  - Performance: Sequentially awaits each manifest load; runs only during bootstrap.【F:src/bootstrap.js†L30-L35】
  - Units / spaces: Deals with manifest objects and promises only.【F:src/bootstrap.js†L30-L35】
  - Determinism: Deterministic given the same manifests and network conditions.
  - Keep / change / delete: Keep; provides a single entry point for boot-time asset fetching.
  - Confidence / assumptions: High confidence; assumes manifests remain relatively small and `SpriteCatalog` exposes `getTextureManifest` when present.

- `setupCallbacks`
  - Purpose: Hooks gameplay lifecycle callbacks into renderer and app handlers so UI elements respond to resets, respawns, and race finishes automatically.【F:src/bootstrap.js†L38-L55】
  - Inputs: None; operates on global `Gameplay`, `Renderer`, and optional `App` objects.【F:src/bootstrap.js†L38-L55】
  - Outputs: None; configures callbacks in place.【F:src/bootstrap.js†L38-L55】
  - Side effects: Assigns functions to `Gameplay.state.callbacks` entries that trigger renderer matte transitions, scene resets, and app race-finish handlers.【F:src/bootstrap.js†L39-L53】
  - Shared state touched and where it’s used: Sets callback hooks consumed when gameplay queues resets, respawns, or race completion events during the simulation loop.【F:src/gameplay.js†L2757-L2771】【F:src/gameplay.js†L2323-L2325】
  - Dependencies: Calls renderer matte helpers, `Gameplay.resetScene`, and optional `App.handleRaceFinish` when those callbacks fire.【F:src/bootstrap.js†L39-L53】
  - Edge cases handled or missed: Guards against missing respawn payloads and absent app handlers; does not reapply callbacks if `Gameplay.state.callbacks` is replaced later.【F:src/bootstrap.js†L42-L53】
  - Performance: Constant-time assignments executed once at startup.【F:src/bootstrap.js†L38-L55】
  - Units / spaces: Deals with callback references and time values passed in milliseconds for race finishes.【F:src/bootstrap.js†L50-L53】
  - Determinism: Deterministic, though effects depend on runtime gameplay events triggering the callbacks.【F:src/bootstrap.js†L38-L55】
  - Keep / change / delete: Keep; cleanly centralizes wiring between gameplay events and presentation layers.
  - Confidence / assumptions: High confidence; assumes `Gameplay.state.callbacks` remains mutable and renderer/app functions exist when needed.

### 3.4 Vehicle Control & Physics (`src/gameplay.js`)
- `trackLengthRef`
  - Purpose: Provides the current total track length so wrap calculations can stay in sync with dynamic track data.【F:src/gameplay.js†L73-L76】
  - Inputs: None; reads `World.data.trackLength` from the captured `data` object.【F:src/gameplay.js†L58-L76】
  - Outputs: Returns the track length in world-distance units (or `0` if unset).【F:src/gameplay.js†L74-L76】
  - Side effects: None; read-only accessor.【F:src/gameplay.js†L74-L76】
  - Shared state touched and where it’s used: Supplies length values to wrap helpers when spawning sprites and advancing effects, ensuring positions stay within track bounds.【F:src/gameplay.js†L841-L845】【F:src/gameplay.js†L1225-L1233】
  - Dependencies: Relies on the `data` object populated by the world builder; no function calls.【F:src/gameplay.js†L58-L76】
  - Edge cases handled or missed: Returns `0` when `trackLength` is falsy, which can disable wrapping logic but may hide configuration mistakes.【F:src/gameplay.js†L74-L76】
  - Performance: Constant-time property access; called frequently whenever `s` positions need wrapping.【F:src/gameplay.js†L74-L1233】
  - Units / spaces: Track length shares the same `s` coordinate space as segment positions (meters along the road).【F:src/gameplay.js†L74-L842】
  - Determinism: Deterministic for a given `World.data` state.【F:src/gameplay.js†L74-L76】
  - Keep / change / delete: Keep; lightweight accessor avoids hard-coding property lookups throughout the module.
  - Confidence / assumptions: High confidence; assumes `World.data.trackLength` is maintained by track-building routines.

- `hasSegments`
  - Purpose: Quickly reports whether the track has any segments so systems can bail out before doing segment-dependent work.【F:src/gameplay.js†L73-L78】
  - Inputs: None; inspects the captured `segments` array.【F:src/gameplay.js†L73-L78】
  - Outputs: Boolean indicating whether at least one segment exists.【F:src/gameplay.js†L77-L78】
  - Side effects: None.【F:src/gameplay.js†L77-L78】
  - Shared state touched and where it’s used: Governs early exits throughout gameplay—for example, wrapping segment indices and spawning drift effects both guard on `hasSegments()` before proceeding.【F:src/gameplay.js†L85-L90】【F:src/gameplay.js†L1213-L1236】
  - Dependencies: None beyond the `segments` closure array.【F:src/gameplay.js†L73-L78】
  - Edge cases handled or missed: Returns `false` during bootstrap before track data loads; does not validate segment integrity when count > 0.【F:src/gameplay.js†L73-L78】
  - Performance: Constant; called frequently in per-frame code paths.【F:src/gameplay.js†L77-L1236】
  - Units / spaces: N/A—boolean flag only.【F:src/gameplay.js†L77-L78】
  - Determinism: Deterministic for a given `segments` array state.【F:src/gameplay.js†L73-L78】
  - Keep / change / delete: Keep; tiny helper improves readability of guard clauses.
  - Confidence / assumptions: High confidence; assumes `segments` accurately reflects the loaded track.

- `wrapByLength`
  - Purpose: Wraps a longitudinal `s` value into the `[0, length)` track range so repeated laps stay numerically bounded.【F:src/gameplay.js†L79-L83】
  - Inputs: `value` — distance or coordinate to wrap; `length` — positive track length controlling the wrap window (no wrapping when `length <= 0`).【F:src/gameplay.js†L79-L83】
  - Outputs: Wrapped numeric position, preserving negative offsets by adding `length` when needed.【F:src/gameplay.js†L79-L83】
  - Side effects: None.【F:src/gameplay.js†L79-L83】
  - Shared state touched and where it’s used: Underpins segment lookups such as `segmentAtS`, ensuring player sampling stays inside the track loop.【F:src/gameplay.js†L1121-L1123】
  - Dependencies: None.【F:src/gameplay.js†L79-L83】
  - Edge cases handled or missed: Treats non-positive `length` as a no-op, which prevents NaNs but leaves callers responsible for zero-length tracks.【F:src/gameplay.js†L79-L83】
  - Performance: Constant arithmetic; often executed per frame for physics and spawning.【F:src/gameplay.js†L79-L1231】
  - Units / spaces: Works in the same `s` distance units as the rest of the track system.【F:src/gameplay.js†L79-L1123】
  - Determinism: Deterministic for numeric inputs.【F:src/gameplay.js†L79-L83】
  - Keep / change / delete: Keep; concise helper avoids duplicating modular arithmetic around the codebase.
  - Confidence / assumptions: High confidence; assumes callers pass finite numbers.

- `wrapSegmentIndex`
  - Purpose: Normalizes a segment index so lookups stay within bounds even when callers traverse past the ends of the segment array.【F:src/gameplay.js†L85-L90】
  - Inputs: `idx` — integer (or float) index to wrap into the valid `[0, segments.length)` range.【F:src/gameplay.js†L85-L90】
  - Outputs: Returns a wrapped non-negative integer index; passes through the original value when no segments are loaded.【F:src/gameplay.js†L85-L90】
  - Side effects: None.【F:src/gameplay.js†L85-L90】
  - Shared state touched and where it’s used: Enables `segmentAtIndex` and sprite placement logic to traverse the looped track safely.【F:src/gameplay.js†L1127-L1129】【F:src/gameplay.js†L2116-L2124】
  - Dependencies: Depends on the captured `segments` array and `hasSegments()` guard.【F:src/gameplay.js†L73-L90】
  - Edge cases handled or missed: Wraps negative indices by adding the segment count; when `segments.length` is zero it simply returns the input, leaving upstream code to handle emptiness.【F:src/gameplay.js†L85-L90】
  - Performance: Constant; frequently executed while generating sprite instances or iterating the track.【F:src/gameplay.js†L85-L2119】
  - Units / spaces: Operates on index positions only.【F:src/gameplay.js†L85-L1129】
  - Determinism: Deterministic for given inputs and segment count.【F:src/gameplay.js†L85-L90】
  - Keep / change / delete: Keep; prevents repeated modulus boilerplate in callers.
  - Confidence / assumptions: High confidence; assumes `segments.length` fits within standard number precision.

- `ensureArray`
  - Purpose: Guarantees that an object owns an array under the requested key, creating one when absent, so callers can push into it without guards.【F:src/gameplay.js†L92-L96】
  - Inputs: `obj` — target object (can be falsy); `key` — property name to ensure as an array.【F:src/gameplay.js†L92-L96】
  - Outputs: Returns the existing or newly created array; falls back to an empty array when `obj` is falsy.【F:src/gameplay.js†L92-L96】
  - Side effects: Initializes `obj[key]` to `[]` when missing, mutating the supplied object.【F:src/gameplay.js†L92-L96】
  - Shared state touched and where it’s used: Populates per-segment sprite and car collections during gameplay and spawning routines.【F:src/gameplay.js†L863-L865】【F:src/gameplay.js†L1213-L1236】
  - Dependencies: None.【F:src/gameplay.js†L92-L96】
  - Edge cases handled or missed: Safely handles falsy objects by returning a new array, though callers must recognize that pushes into the returned array won't persist when `obj` is null.【F:src/gameplay.js†L92-L96】
  - Performance: Constant-time check; invoked frequently while managing per-segment entities.【F:src/gameplay.js†L92-L1236】
  - Units / spaces: N/A—creates arrays only.【F:src/gameplay.js†L92-L96】
  - Determinism: Deterministic for the same object and key.【F:src/gameplay.js†L92-L96】
  - Keep / change / delete: Keep; reduces repetitive `if (!obj[key]) obj[key] = []` patterns.
  - Confidence / assumptions: High confidence; assumes callers respect the returned array semantics.

- `atlasFrameUv`
  - Purpose: Converts a frame index within a sprite atlas into normalized UV coordinates for rendering.【F:src/gameplay.js†L98-L112】
  - Inputs: `frameIndex` — desired frame number; `columns` — number of columns in the atlas; `totalFrames` — total frames available (clamped to ≥1).【F:src/gameplay.js†L98-L111】
  - Outputs: Returns an object with the four UV corners (`u1`…`v4`) covering the frame tile.【F:src/gameplay.js†L108-L111】
  - Side effects: None.【F:src/gameplay.js†L98-L111】
  - Shared state touched and where it’s used: Supplies UVs when updating sprite frames and when fallback atlas metadata computes frame coordinates.【F:src/gameplay.js†L198-L205】【F:src/gameplay.js†L356-L363】
  - Dependencies: Pure math helper; no external calls beyond `Math` functions.【F:src/gameplay.js†L98-L111】
  - Edge cases handled or missed: Clamps frame indices into the valid range and enforces at least one column/row; does not handle atlases with irregular layouts or padding.【F:src/gameplay.js†L98-L111】
  - Performance: Constant arithmetic invoked per frame update for animated sprites.【F:src/gameplay.js†L98-L205】
  - Units / spaces: UV coordinates in normalized [0,1] texture space.【F:src/gameplay.js†L108-L111】
  - Determinism: Deterministic for identical numeric inputs.【F:src/gameplay.js†L98-L111】
  - Keep / change / delete: Keep; encapsulates atlas math that would otherwise be error-prone when repeated.
  - Confidence / assumptions: High confidence; assumes uniform grids without per-frame offsets.

- `normalizeAnimClip`
  - Purpose: Sanitizes raw animation clip definitions into a canonical shape with validated frame lists and playback mode.【F:src/gameplay.js†L114-L124】
  - Inputs: `rawClip` — potentially sparse clip object; `fallbackFrame` — numeric frame to insert when no frames exist; `useFallback` — boolean controlling fallback insertion.【F:src/gameplay.js†L114-L123】
  - Outputs: Returns `{ frames, playback }` where frames is a filtered array of finite numbers and playback is one of `loop`, `pingpong`, `once`, or `none`.【F:src/gameplay.js†L114-L123】
  - Side effects: None.【F:src/gameplay.js†L114-L123】
  - Shared state touched and where it’s used: Feeds into `createSpriteAnimationState` so sprite instances can initialize consistent animation state.【F:src/gameplay.js†L126-L140】
  - Dependencies: Uses local `Number.isFinite` filtering and lowercase string comparisons; no external modules.【F:src/gameplay.js†L114-L123】
  - Edge cases handled or missed: Filters out non-numeric frames and provides a fallback when desired; treats unrecognized playback strings as `none` but does not deduplicate frames.【F:src/gameplay.js†L114-L123】
  - Performance: Clones the frame array once; invoked during sprite instantiation, not per frame.【F:src/gameplay.js†L117-L140】
  - Units / spaces: Works with animation frame indices; no time units until playback occurs.【F:src/gameplay.js†L114-L123】
  - Determinism: Deterministic for the same input clip and fallback options.【F:src/gameplay.js†L114-L123】
  - Keep / change / delete: Keep; centralizes clip sanitization logic that would otherwise be duplicated wherever clips are loaded.
  - Confidence / assumptions: High confidence; assumes clips, when provided, already follow general structure (e.g., `frames` array).

- `createSpriteAnimationState`
  - Purpose: Combines base and interaction clips into a runtime animation state object that tracks frame progression, playback rules, and defaults.【F:src/gameplay.js†L126-L150】
  - Inputs: `baseClipRaw`, `interactClipRaw` — clip definitions; `frameDuration` — seconds per frame (defaults to 1/60 when invalid); `fallbackFrame` — frame to use when clips are empty.【F:src/gameplay.js†L126-L148】
  - Outputs: Returns an animation state object with clip references, frame indices, timers, and flags, or `null` when no usable frames exist.【F:src/gameplay.js†L131-L149】
  - Side effects: None; constructs a new object.【F:src/gameplay.js†L126-L149】
  - Shared state touched and where it’s used: Used when instantiating sprites so each sprite tracks its own playback state.【F:src/gameplay.js†L848-L855】
  - Dependencies: Calls `normalizeAnimClip` for each clip before assembling the state.【F:src/gameplay.js†L127-L130】
  - Edge cases handled or missed: Returns `null` when both clips lack frames, ensures fallback frames populate static animations, and configures playback flags based on clip modes; does not validate that fallback frames exist within atlas ranges.【F:src/gameplay.js†L126-L149】
  - Performance: Constant work per sprite instantiation.【F:src/gameplay.js†L126-L149】
  - Units / spaces: Uses frame indices and seconds for duration/accumulator values.【F:src/gameplay.js†L138-L147】
  - Determinism: Deterministic for given clip inputs.【F:src/gameplay.js†L126-L149】
  - Keep / change / delete: Keep; encapsulates animation state initialization logic for reuse.
  - Confidence / assumptions: High confidence; assumes clips are relatively small arrays.

- `currentAnimationClip`
  - Purpose: Returns the clip currently designated as active so frame advancement code knows which frame list to use.【F:src/gameplay.js†L153-L157】
  - Inputs: `anim` — animation state object with `active` and `clips` fields.【F:src/gameplay.js†L153-L157】
  - Outputs: The active clip object or `null` when unavailable.【F:src/gameplay.js†L153-L157】
  - Side effects: None.【F:src/gameplay.js†L153-L157】
  - Shared state touched and where it’s used: Consulted by `advanceSpriteAnimation` on every frame tick before updating frame indices.【F:src/gameplay.js†L207-L214】
  - Dependencies: None beyond reading the `anim` object.【F:src/gameplay.js†L153-L157】
  - Edge cases handled or missed: Falls back to the base clip when the active mode is not `interact` or the interaction clip is missing; returns `null` when the state object is malformed.【F:src/gameplay.js†L153-L157】
  - Performance: Constant; executed per sprite per frame.【F:src/gameplay.js†L207-L214】
  - Units / spaces: N/A—returns clip objects only.【F:src/gameplay.js†L153-L157】
  - Determinism: Deterministic for identical animation state input.【F:src/gameplay.js†L153-L157】
  - Keep / change / delete: Keep; isolates clip-selection logic for clarity.
  - Confidence / assumptions: High confidence; assumes animation states follow the structure produced by `createSpriteAnimationState`.

- `clampFrameIndex`
  - Purpose: Constrains a frame index to the valid range for a clip, preventing out-of-bounds access when switching or advancing animations.【F:src/gameplay.js†L159-L166】
  - Inputs: `idx` — desired frame index; `length` — number of frames available.【F:src/gameplay.js†L159-L165】
  - Outputs: Returns a non-negative integer within `[0, length - 1]`, or `0` when inputs are invalid.【F:src/gameplay.js†L159-L165】
  - Side effects: None.【F:src/gameplay.js†L159-L165】
  - Shared state touched and where it’s used: Used by clip switching and playback updates to keep `frameIndex` and `currentFrame` in bounds.【F:src/gameplay.js†L168-L195】【F:src/gameplay.js†L226-L283】
  - Dependencies: Relies on `Math.floor` and local logic only.【F:src/gameplay.js†L159-L165】
  - Edge cases handled or missed: Handles NaN indices and non-positive lengths by returning `0`; does not clamp to wrap-around behavior (callers handle looping separately).【F:src/gameplay.js†L159-L165】
  - Performance: Constant, invoked frequently during animation updates.【F:src/gameplay.js†L159-L283】
  - Units / spaces: Index positions only.【F:src/gameplay.js†L159-L165】
  - Determinism: Deterministic for numeric inputs.【F:src/gameplay.js†L159-L165】
  - Keep / change / delete: Keep; essential safeguard against array bounds errors.
  - Confidence / assumptions: High confidence; assumes callers pass finite lengths.

- `switchSpriteAnimationClip`
  - Purpose: Activates a different clip on an animation state, optionally restarting timing so sprites can transition between base and interaction animations.【F:src/gameplay.js†L168-L196】
  - Inputs: `anim` — animation state to mutate; `clipName` — `'base'` or `'interact'`; `restart` — boolean indicating whether to reset timers and indices.【F:src/gameplay.js†L168-L188】
  - Outputs: None; mutates the animation state in place.【F:src/gameplay.js†L168-L195】
  - Side effects: Updates `anim.active`, `frameIndex`, `direction`, `accumulator`, and playback flags; may update `currentFrame`.【F:src/gameplay.js†L172-L195】
  - Shared state touched and where it’s used: Called when interactive sprites finish interacting to return to the base clip, and when gameplay triggers interaction animations.【F:src/gameplay.js†L274-L283】【F:src/gameplay.js†L1934-L1944】
  - Dependencies: Uses `clampFrameIndex` to keep indices valid before sampling frames.【F:src/gameplay.js†L177-L194】
  - Edge cases handled or missed: Ignores requests when the desired clip is absent, and supports non-restarting transitions; does not provide blended transitions between clips.【F:src/gameplay.js†L168-L195】
  - Performance: Constant per invocation, typically triggered on discrete events rather than every frame.【F:src/gameplay.js†L168-L195】
  - Units / spaces: Operates on frame indices and seconds stored in the animation state.【F:src/gameplay.js†L168-L195】
  - Determinism: Deterministic given the same animation state and parameters.【F:src/gameplay.js†L168-L195】
  - Keep / change / delete: Keep; encapsulates clip-toggle logic that would be verbose inline.
  - Confidence / assumptions: High confidence; assumes animation states follow the structure from `createSpriteAnimationState`.

- `updateSpriteUv`
  - Purpose: Recomputes a sprite’s UV coordinates whenever its animation frame changes so rendering samples the correct atlas tile.【F:src/gameplay.js†L198-L205】
  - Inputs: `sprite` — object expected to contain `atlasInfo` metadata and the current `animFrame` index.【F:src/gameplay.js†L198-L204】
  - Outputs: None directly; assigns a `uv` object onto the sprite when data is valid.【F:src/gameplay.js†L198-L205】
  - Side effects: Mutates `sprite.uv` in place after validating atlas info.【F:src/gameplay.js†L198-L205】
  - Shared state touched and where it’s used: Called immediately after sprite creation and every time animation advances to keep GPU buffers in sync.【F:src/gameplay.js†L862-L865】【F:src/gameplay.js†L268-L283】
  - Dependencies: Uses `atlasFrameUv` to compute the coordinate data.【F:src/gameplay.js†L202-L205】
  - Edge cases handled or missed: Exits early when atlas metadata or frame index is missing, preventing crashes but leaving `sprite.uv` unchanged; does not fallback to default UVs when atlas info is absent.【F:src/gameplay.js†L198-L204】
  - Performance: Constant per invocation; runs each frame for animated sprites and on spawn for static sprites.【F:src/gameplay.js†L198-L205】【F:src/gameplay.js†L862-L865】
  - Units / spaces: Produces normalized [0,1] UV coordinates compatible with WebGL buffers.【F:src/gameplay.js†L202-L205】
  - Determinism: Deterministic with identical sprite metadata.【F:src/gameplay.js†L198-L205】
  - Keep / change / delete: Keep; central utility avoids duplicating atlas logic across render paths.
  - Confidence / assumptions: High confidence; assumes sprites that require UVs provide valid `atlasInfo`.

- `advanceSpriteAnimation`
  - Purpose: Steps a sprite’s animation forward based on elapsed time, handling looping, once, and ping-pong playback while updating sprite frames and UVs.【F:src/gameplay.js†L207-L285】
  - Inputs: `sprite` — expects an `animation` state from `createSpriteAnimationState`; `dt` — delta time in seconds since the last update.【F:src/gameplay.js†L207-L285】
  - Outputs: None; mutates the sprite’s animation state and `animFrame`/`uv` properties.【F:src/gameplay.js†L207-L285】
  - Side effects: Updates frame indices, accumulators, playback flags, current frame, and triggers clip switches back to the base animation when interaction clips finish.【F:src/gameplay.js†L220-L283】
  - Shared state touched and where it’s used: Invoked during gameplay updates to animate active sprites each frame.【F:src/gameplay.js†L2067-L2069】
  - Dependencies: Leverages `currentAnimationClip`, `clampFrameIndex`, `updateSpriteUv`, and `switchSpriteAnimationClip` to manage playback safely.【F:src/gameplay.js†L210-L283】
  - Edge cases handled or missed: Handles missing animation data, empty frame lists, and ensures playback stops at ends for `once` clips; ping-pong mode reverses direction; does not account for variable frame durations per frame.【F:src/gameplay.js†L210-L283】
  - Performance: While-loop can iterate multiple frames if `dt` is large, but otherwise runs in constant time per sprite per frame; frequency equals the sprite update cadence.【F:src/gameplay.js†L233-L266】【F:src/gameplay.js†L2067-L2072】
  - Units / spaces: Uses seconds for `dt` and frame durations, and frame indices for atlas lookups.【F:src/gameplay.js†L222-L283】
  - Determinism: Deterministic for the same sprite state and `dt`; dependent on floating-point accumulation order.【F:src/gameplay.js†L207-L285】
  - Keep / change / delete: Keep; consolidates complex playback behavior in one tested routine.
  - Confidence / assumptions: High confidence; assumes `dt` is non-negative and relatively small (per-frame timestep).

- `createSpriteMetaEntry`
  - Purpose: Produces a sprite metadata descriptor by merging defaults with catalog-provided metrics so runtime systems know scale, tint, textures, and atlas layout.【F:src/gameplay.js†L378-L409】
  - Inputs: `metrics` — optional object supplying overrides such as `wN`, `aspect`, `tint`, `textureKey`, and `atlas` data; defaults to `SPRITE_METRIC_FALLBACK`.【F:src/gameplay.js†L378-L406】
  - Outputs: Returns a new metadata object with scalar fields plus `tex` and `frameUv` helper functions tailored to the sprite.【F:src/gameplay.js†L384-L407】
  - Side effects: None; creates and returns a new object each call.【F:src/gameplay.js†L378-L407】
  - Shared state touched and where it’s used: Catalog building code calls this when converting sprite definitions into runtime metadata used during sprite instantiation.【F:src/gameplay.js†L732-L738】
  - Dependencies: Reads `World.assets.textures` when resolving textures and reuses `atlasFrameUv` for atlas frame lookups.【F:src/gameplay.js†L388-L407】
  - Edge cases handled or missed: Provides cloned tint arrays to avoid shared mutation, falls back to default texture lookups, and handles missing atlas info by returning `null`; does not deep-clone nested atlas objects beyond spread syntax.【F:src/gameplay.js†L384-L407】
  - Performance: Constant-time object construction per catalog entry.【F:src/gameplay.js†L378-L407】
  - Units / spaces: Encapsulates normalized width (`wN`) and aspect ratios, which correspond to world-space scaling parameters.【F:src/gameplay.js†L384-L399】
  - Determinism: Deterministic for the same metrics input and current world texture map.【F:src/gameplay.js†L384-L407】
  - Keep / change / delete: Keep; centralizes sprite metadata normalization across catalogs.
  - Confidence / assumptions: High confidence; assumes metrics resemble SpriteCatalog definitions and that textures may be missing during early bootstrap.

- `createInitialMetrics`
  - Purpose: Initializes the player metrics tracker with zeroed counters and timers so race statistics start from a clean slate.【F:src/gameplay.js†L1043-L1057】
  - Inputs: None.【F:src/gameplay.js†L1043-L1057】
  - Outputs: Returns a fresh metrics object containing counters for hits, boosts, air time, and other race stats.【F:src/gameplay.js†L1043-L1057】
  - Side effects: None; creates a new object.【F:src/gameplay.js†L1043-L1057】
  - Shared state touched and where it’s used: Assigned to `state.metrics` on initialization and whenever stats reset after a race.【F:src/gameplay.js†L1108-L1110】【F:src/gameplay.js†L2738-L2739】
  - Dependencies: None.【F:src/gameplay.js†L1043-L1057】
  - Edge cases handled or missed: Sets guard-rail cooldown and boolean flags to sensible defaults; does not include derived metrics like average speed (calculated elsewhere).【F:src/gameplay.js†L1043-L1057】
  - Performance: Constant; invoked on startup and resets only.【F:src/gameplay.js†L1043-L1057】
  - Units / spaces: Fields represent counts, seconds, or booleans depending on metric (e.g., `airTime` in seconds).【F:src/gameplay.js†L1043-L1057】
  - Determinism: Deterministic—always returns identical baseline data.【F:src/gameplay.js†L1043-L1057】
  - Keep / change / delete: Keep; provides a single source of truth for metric defaults.
  - Confidence / assumptions: High confidence; assumes downstream code increments these properties directly.

- `getSpriteMeta`
  - Purpose: Retrieves the sprite metadata definition for a given kind, falling back to defaults when overrides are absent.【F:src/gameplay.js†L1112-L1117】
  - Inputs: `kind` — sprite kind identifier string.【F:src/gameplay.js†L1112-L1117】
  - Outputs: Returns a metadata object describing size, tint, texture resolver, and atlas info.【F:src/gameplay.js†L1112-L1117】
  - Side effects: None; returns references without modifying state.【F:src/gameplay.js†L1112-L1117】
  - Shared state touched and where it’s used: Consulted whenever gameplay needs sprite dimensions—for example, to compute the player hitbox or spawn interactions.【F:src/gameplay.js†L1209-L1210】【F:src/gameplay.js†L1926-L1934】
  - Dependencies: Reads from `state.spriteMeta` (runtime overrides) and `DEFAULT_SPRITE_META` constants.【F:src/gameplay.js†L1102-L1117】
  - Edge cases handled or missed: Falls back to a generic default when neither overrides nor built-ins cover the requested kind, ensuring callers still receive reasonable metrics.【F:src/gameplay.js†L1112-L1117】
  - Performance: Constant lookup; executed frequently during gameplay loops.【F:src/gameplay.js†L1112-L1934】
  - Units / spaces: Metadata fields (e.g., `wN`, `aspect`) correspond to normalized world width and scaling ratios.【F:src/gameplay.js†L1112-L1117】
  - Determinism: Deterministic for the same state configuration.【F:src/gameplay.js†L1112-L1117】
  - Keep / change / delete: Keep; central accessor prevents scattering fallback logic.
  - Confidence / assumptions: High confidence; assumes `state.spriteMeta` is kept up to date with overrides from sprite data.

- `defaultGetKindScale`
  - Purpose: Supplies the default scaling rule for sprite kinds, scaling the player sprite while leaving others unchanged.【F:src/gameplay.js†L1041-L1093】
  - Inputs: `kind` — sprite kind identifier (string).【F:src/gameplay.js†L1041-L1042】
  - Outputs: Returns `player.scale` when the kind is `'PLAYER'`, otherwise `1`.【F:src/gameplay.js†L1041-L1042】
  - Side effects: None.【F:src/gameplay.js†L1041-L1042】
  - Shared state touched and where it’s used: Assigned to `state.getKindScale` so width calculations and hitboxes can scale sprites appropriately by kind.【F:src/gameplay.js†L1092-L1093】
  - Dependencies: Reads `player.scale` from configuration captured earlier in the module.【F:src/gameplay.js†L9-L22】【F:src/gameplay.js†L1041-L1042】
  - Edge cases handled or missed: Provides a simple fallback when no specialized scaler is injected; does not handle other kinds needing non-unit scale without overrides.【F:src/gameplay.js†L1041-L1093】
  - Performance: Constant; invoked whenever width calculations run.【F:src/gameplay.js†L1041-L1210】
  - Units / spaces: Returns scalar multipliers applied to normalized sprite widths.【F:src/gameplay.js†L1041-L1210】
  - Determinism: Deterministic for a given config.【F:src/gameplay.js†L1041-L1042】
  - Keep / change / delete: Keep; provides a safe default when no dynamic scaling strategy is supplied.
  - Confidence / assumptions: High confidence; assumes player scale is defined in configuration.

- `segmentAtS`
  - Purpose: Finds the track segment that covers a given longitudinal `s` position, wrapping around the track length as needed.【F:src/gameplay.js†L1119-L1123】
  - Inputs: `s` — world distance along the track (can be outside `[0, trackLength)`).【F:src/gameplay.js†L1119-L1123】
  - Outputs: Returns the corresponding segment object or `null` if no segments exist.【F:src/gameplay.js†L1119-L1123】
  - Side effects: None.【F:src/gameplay.js†L1119-L1123】
  - Shared state touched and where it’s used: Drives numerous gameplay queries—e.g., boost detection and effects rely on it to inspect the player’s current segment.【F:src/gameplay.js†L1188-L1191】【F:src/gameplay.js†L1213-L1236】
  - Dependencies: Depends on `trackLengthRef`, `wrapByLength`, `segmentLength`, and the `segments` array.【F:src/gameplay.js†L73-L1133】
  - Edge cases handled or missed: Returns `null` when no segments are available or track length is non-positive; uses floor division to select a segment but assumes evenly sized segments.【F:src/gameplay.js†L1119-L1133】
  - Performance: Constant time; executed frequently each frame for physics and rendering.【F:src/gameplay.js†L1119-L1236】
  - Units / spaces: Operates in the track’s `s` distance space; segment length derived from configuration.【F:src/gameplay.js†L73-L1133】
  - Determinism: Deterministic for given `s` and current track state.【F:src/gameplay.js†L1119-L1123】
  - Keep / change / delete: Keep; core utility for spatial queries along the track.
  - Confidence / assumptions: High confidence; assumes segment data is continuous and segment lengths are consistent.

- `segmentAtIndex`
  - Purpose: Retrieves a segment by index with automatic wrapping so callers can iterate forwards or backwards around the loop safely.【F:src/gameplay.js†L1125-L1129】
  - Inputs: `idx` — integer index (may be negative or beyond the segment count).【F:src/gameplay.js†L1125-L1129】
  - Outputs: Returns the wrapped segment or `null` when no segments exist.【F:src/gameplay.js†L1125-L1129】
  - Side effects: None.【F:src/gameplay.js†L1125-L1129】
  - Shared state touched and where it’s used: Used extensively when generating sprite placements and when computing neighbor segments for effects.【F:src/gameplay.js†L742-L783】【F:src/gameplay.js†L2116-L2124】
  - Dependencies: Utilizes `hasSegments()` and `wrapSegmentIndex` to ensure safe access.【F:src/gameplay.js†L77-L90】【F:src/gameplay.js†L1125-L1129】
  - Edge cases handled or missed: Returns `null` when the segment list is empty; does not validate that the returned segment is fully populated (assumes data integrity).【F:src/gameplay.js†L1125-L1129】
  - Performance: Constant lookup; used frequently during placement loops.【F:src/gameplay.js†L742-L2124】
  - Units / spaces: Works with zero-based segment indices.【F:src/gameplay.js†L1125-L1129】
  - Determinism: Deterministic for a given index and segment list.【F:src/gameplay.js†L1125-L1129】
  - Keep / change / delete: Keep; wrapper simplifies repetitive modulo logic.
  - Confidence / assumptions: High confidence; assumes `segments` array remains stable during iteration.

- `elevationAt`
  - Purpose: Computes the interpolated road height at a longitudinal position using the current segment geometry.【F:src/gameplay.js†L1131-L1137】
  - Inputs: `s` — world distance along the track.【F:src/gameplay.js†L1131-L1137】
  - Outputs: Returns the vertical world coordinate at that `s`, defaulting to `0` when no segments exist.【F:src/gameplay.js†L1131-L1137】
  - Side effects: None.【F:src/gameplay.js†L1131-L1137】
  - Shared state touched and where it’s used: Feeds into ground-profile calculations and physics routines when determining vehicle height and camera tilt.【F:src/gameplay.js†L1139-L1148】【F:src/gameplay.js†L2412-L2416】
  - Dependencies: Uses `trackLengthRef`, `wrapByLength`, `segmentLength`, and `lerp` to blend between segment endpoints.【F:src/gameplay.js†L52-L1137】
  - Edge cases handled or missed: Safely handles empty track or zero length by returning `0`; assumes segments provide `p1.world`/`p2.world` coordinates.【F:src/gameplay.js†L1131-L1137】
  - Performance: Constant; invoked frequently each frame during physics and rendering.【F:src/gameplay.js†L1131-L2416】
  - Units / spaces: Works in world height units consistent with segment `y` values.【F:src/gameplay.js†L1131-L1137】
  - Determinism: Deterministic for a given `s` and track data.【F:src/gameplay.js†L1131-L1137】
  - Keep / change / delete: Keep; central interpolation helper for vertical sampling.
  - Confidence / assumptions: High confidence; assumes segment endpoints are valid and ordered along `s`.

- `groundProfileAt`
  - Purpose: Estimates the road’s slope and curvature around a position so physics and rendering can react to elevation changes smoothly.【F:src/gameplay.js†L1139-L1148】
  - Inputs: `s` — world distance along the track.【F:src/gameplay.js†L1139-L1148】
  - Outputs: Returns `{ y, dy, d2y }` containing elevation, first derivative, and second derivative.【F:src/gameplay.js†L1139-L1148】
  - Side effects: None.【F:src/gameplay.js†L1139-L1148】
  - Shared state touched and where it’s used: Supplies height data to player floor calculations and other slope-aware systems.【F:src/gameplay.js†L1153-L1160】【F:src/gameplay.js†L1888-L1897】
  - Dependencies: Relies on `elevationAt` sampled slightly ahead and behind the target point, using a step based on segment length.【F:src/gameplay.js†L1139-L1148】
  - Edge cases handled or missed: Provides zero derivatives when segments are missing; uses a minimum sampling distance to avoid division by zero but may underrepresent very sharp transitions.【F:src/gameplay.js†L1139-L1148】
  - Performance: Calls `elevationAt` three times per invocation; used repeatedly in physics updates.【F:src/gameplay.js†L1139-L1897】
  - Units / spaces: Elevation (`y`) in world units, slopes (`dy`, `d2y`) per unit `s`.【F:src/gameplay.js†L1139-L1148】
  - Determinism: Deterministic given current track geometry.【F:src/gameplay.js†L1139-L1148】
  - Keep / change / delete: Keep; encapsulates derivative sampling needed for physics smoothing.
  - Confidence / assumptions: High confidence; assumes segment spacing is fine-grained enough for finite difference approximation.

- `playerFloorHeightAt`
  - Purpose: Determines the player vehicle’s floor height at a given `s` and lateral position, respecting custom floor overrides when available.【F:src/gameplay.js†L1150-L1159】
  - Inputs: `s` — longitudinal position (defaults to current player `s`); `nNorm` — normalized lateral offset (defaults to player N); `groundProfile` — optional precomputed `{ y, dy, d2y }` to reuse.【F:src/gameplay.js†L1150-L1159】
  - Outputs: Returns the height value the player should rest on.【F:src/gameplay.js†L1150-L1159】
  - Side effects: None.【F:src/gameplay.js†L1150-L1159】
  - Shared state touched and where it’s used: Called throughout physics updates to keep the player aligned with the road surface during movement and landings.【F:src/gameplay.js†L1897-L1903】【F:src/gameplay.js†L2215-L2221】
  - Dependencies: Prefers `World.floorElevationAt` when defined, falling back to `groundProfileAt` otherwise.【F:src/gameplay.js†L1151-L1160】
  - Edge cases handled or missed: Handles missing floor samplers by using the road profile; assumes provided `groundProfile` matches the same `s`/`nNorm`.【F:src/gameplay.js†L1150-L1160】
  - Performance: Constant after optional profile reuse; invoked every frame for player physics.【F:src/gameplay.js†L1150-L2221】
  - Units / spaces: Returns height in world units (same scale as elevation samples).【F:src/gameplay.js†L1150-L1159】
  - Determinism: Deterministic for the same track state and inputs.【F:src/gameplay.js†L1150-L1159】
  - Keep / change / delete: Keep; consolidates multi-source floor sampling logic.
  - Confidence / assumptions: High confidence; assumes `floorElevationAt` (when provided) returns finite values.

- `boostZonesOnSegment`
  - Purpose: Retrieves the list of boost zones attached to a segment so gameplay and rendering can highlight or process them.【F:src/gameplay.js†L1162-L1165】
  - Inputs: `seg` — segment object, expected to carry a `features.boostZones` array.【F:src/gameplay.js†L1162-L1165】
  - Outputs: Returns the boost-zone array or an empty list when absent.【F:src/gameplay.js†L1162-L1165】
  - Side effects: None.【F:src/gameplay.js†L1162-L1165】
  - Shared state touched and where it’s used: Used to detect player boost interactions and to render boost indicators on the road.【F:src/gameplay.js†L1180-L1184】【F:src/render.js†L1092-L1098】
  - Dependencies: None; simple property accessor.【F:src/gameplay.js†L1162-L1165】
  - Edge cases handled or missed: Returns an empty array when the property is missing or not an array; does not deep-copy results, so callers should avoid mutating shared zone definitions.【F:src/gameplay.js†L1162-L1165】
  - Performance: Constant; invoked every frame for the active segment during boost checks and drawing.【F:src/gameplay.js†L1180-L1184】【F:src/render.js†L1092-L1098】
  - Units / spaces: Boost zones encode normalized lateral bounds and types, consistent with other gameplay zone data.【F:src/gameplay.js†L1162-L1184】
  - Determinism: Deterministic for a given segment object.【F:src/gameplay.js†L1162-L1165】
  - Keep / change / delete: Keep; small helper keeps feature access consistent and safe.
  - Confidence / assumptions: High confidence; assumes segments store boost-zone definitions under `features.boostZones`.
  - `playerWithinBoostZone`
    - Purpose: Checks whether a player's normalized lateral position falls between a boost zone's start and end bounds, defaulting to lane clamps when the zone omits them.【F:src/gameplay.js†L1170-L1178】
    - Inputs: `zone` — boost zone with optional `nStart`/`nEnd`; `nNorm` — player lateral offset clamped to lane range (defaults come from ±2 passed through `clampBoostLane`).【F:src/gameplay.js†L69-L75】【F:src/gameplay.js†L1170-L1178】
    - Outputs: Returns `true` when `nNorm` lies between the zone bounds, otherwise `false`.【F:src/gameplay.js†L1176-L1178】
    - Side effects: None; purely computes a boolean.【F:src/gameplay.js†L1170-L1178】
    - Shared state touched and where it’s used: Does not mutate shared state; consumed by `boostZonesForPlayer` while evaluating the player's active boost zones in jump detection and physics updates.【F:src/gameplay.js†L1182-L1191】【F:src/gameplay.js†L2178-L2184】
    - Dependencies: Uses `clampBoostLane` plus `Math.min`/`Math.max` to sanitize bounds.【F:src/gameplay.js†L1172-L1177】
    - Edge cases handled or missed: Returns `false` when the zone object is missing; handles reversed start/end ordering via `Math.min`/`Math.max`, but assumes `nNorm` is finite.【F:src/gameplay.js†L1171-L1178】
    - Performance: Constant time; invoked once per zone when filtering the current segment each frame.【F:src/gameplay.js†L1182-L1184】【F:src/gameplay.js†L2178-L2184】
    - Units / spaces: Operates in normalized lane (`N`) space shared with `state.playerN` and lane clamps.【F:src/gameplay.js†L1172-L1178】【F:src/gameplay.js†L2170-L2184】
    - Determinism: Deterministic for given inputs because it performs only arithmetic comparisons.【F:src/gameplay.js†L1170-L1178】
    - Keep / change / delete: Keep; consolidates lane-bound fallback logic that would otherwise repeat inside callers.
    - Confidence / assumptions: High confidence; assumes `clampBoostLane` returns consistent bounds and `nNorm` already reflects the player.

  - `boostZonesForPlayer`
    - Purpose: Collects only the boost zones on a segment that currently cover the player's lateral position so other systems can react.【F:src/gameplay.js†L1181-L1184】
    - Inputs: `seg` — segment containing potential zones; `nNorm` — player’s normalized lane offset to test.【F:src/gameplay.js†L1181-L1184】
    - Outputs: Returns a filtered array of zones that include `nNorm`, or an empty array when none match.【F:src/gameplay.js†L1182-L1184】
    - Side effects: None; produces a new filtered array and leaves segment data untouched.【F:src/gameplay.js†L1181-L1184】
    - Shared state touched and where it’s used: Reads segment feature data but no globals; used by `jumpZoneForPlayer` and by the per-frame physics step to drive boost behavior.【F:src/gameplay.js†L1187-L1191】【F:src/gameplay.js†L2178-L2184】
    - Dependencies: Calls `boostZonesOnSegment` and `playerWithinBoostZone` for filtering.【F:src/gameplay.js†L1182-L1184】
    - Edge cases handled or missed: Short-circuits when no zones exist; assumes zone objects are well-formed and does not deep-clone them, so later mutation would affect segment data.【F:src/gameplay.js†L1182-L1184】
    - Performance: Iterates over the existing zone array; runs every frame for the current segment so zone lists should stay small.【F:src/gameplay.js†L1182-L1184】【F:src/gameplay.js†L2178-L2184】
    - Units / spaces: Uses normalized lane coordinates for comparisons consistent with boost zone definitions.【F:src/gameplay.js†L1181-L1184】
    - Determinism: Deterministic given the segment’s zone order and player position.【F:src/gameplay.js†L1181-L1184】
    - Keep / change / delete: Keep; clear helper isolates boost-zone filtering away from callers.
    - Confidence / assumptions: High confidence; assumes segment `features.boostZones` contains immutable zone descriptors during a frame.

  - `jumpZoneForPlayer`
    - Purpose: Finds the jump-type boost zone currently under the player so hops can trigger air boosts.【F:src/gameplay.js†L1187-L1192】
    - Inputs: None; derives the player's segment `s` and lateral position from global state.【F:src/gameplay.js†L1187-L1191】
    - Outputs: Returns the matching zone object or `null` when no jump zone applies.【F:src/gameplay.js†L1189-L1192】
    - Side effects: None; performs lookups only.【F:src/gameplay.js†L1187-L1192】
    - Shared state touched and where it’s used: Reads `state.phys.s` and `state.playerN`; used during hop attempts and spacebar boosts to decide whether to award jump bonuses.【F:src/gameplay.js†L1187-L1191】【F:src/gameplay.js†L1884-L1901】【F:src/gameplay.js†L2586-L2590】
    - Dependencies: Calls `segmentAtS`, `boostZonesForPlayer`, and compares against `boost.types.jump`.【F:src/gameplay.js†L1187-L1192】
    - Edge cases handled or missed: Returns `null` if the segment is missing or no jump zone exists; assumes `state.phys.s` is finite and segment data is current.【F:src/gameplay.js†L1187-L1192】
    - Performance: Constant time; executed when hopping or polling jump zones during input handling.【F:src/gameplay.js†L1884-L1901】【F:src/gameplay.js†L2586-L2590】
    - Units / spaces: Works in track distance (`s`) and normalized lane space, matching the rest of the boost system.【F:src/gameplay.js†L1187-L1191】
    - Determinism: Deterministic for a given game state snapshot.【F:src/gameplay.js†L1187-L1192】
    - Keep / change / delete: Keep; encapsulates jump-zone lookup so callers remain concise.
    - Confidence / assumptions: High confidence; assumes boost zone data stays synchronized with `segmentAtS`.

  - `applyBoostImpulse`
    - Purpose: Adds a forward speed impulse to the player capped by the boosted top speed when a boost event fires.【F:src/gameplay.js†L1194-L1199】
    - Inputs: None; uses `state.phys.vtan`, `player.topSpeed`, and boost tuning constants.【F:src/gameplay.js†L1194-L1199】
    - Outputs: No return value; updates `state.phys.vtan` in place.【F:src/gameplay.js†L1194-L1199】
    - Side effects: Clamps and mutates the player's tangential velocity.【F:src/gameplay.js†L1194-L1199】
    - Shared state touched and where it’s used: Modifies `state.phys`; invoked by `applyJumpZoneBoost` and by drive boost handling inside the physics step.【F:src/gameplay.js†L1202-L1206】【F:src/gameplay.js†L2201-L2205】
    - Dependencies: Relies on `clamp`, player/drift tuning, and the shared physics state object.【F:src/gameplay.js†L1194-L1199】
    - Edge cases handled or missed: Prevents negative speeds via `Math.max`, and exits gracefully when boost cap is zero; assumes `player.topSpeed` and `drift.boostScale` are finite.【F:src/gameplay.js†L1194-L1199】
    - Performance: Constant; triggered only when boosts are awarded, not every frame.【F:src/gameplay.js†L1202-L1206】【F:src/gameplay.js†L2201-L2205】
    - Units / spaces: Operates on tangential world speed (`vtan`).【F:src/gameplay.js†L1194-L1199】
    - Determinism: Deterministic given the same state and tuning constants.【F:src/gameplay.js†L1194-L1199】
    - Keep / change / delete: Keep; centralizes boost capping so the impulse logic stays consistent.
    - Confidence / assumptions: High confidence; assumes physics state is mutable and accessible here.

  - `applyJumpZoneBoost`
    - Purpose: Activates the player's boost timer and flash effect when entering a jump zone, layering on a speed impulse.【F:src/gameplay.js†L1202-L1207】
    - Inputs: `zone` — jump zone descriptor; ignored when falsy.【F:src/gameplay.js†L1202-L1203】
    - Outputs: None; mutates state timers and velocity.【F:src/gameplay.js†L1204-L1207】
    - Side effects: Extends `state.boostTimer`, bumps `state.phys.boostFlashTimer`, and calls `applyBoostImpulse`.【F:src/gameplay.js†L1204-L1207】
    - Shared state touched and where it’s used: Writes to global state and physics timers; triggered by hops and by spacebar boost input.【F:src/gameplay.js†L1884-L1901】【F:src/gameplay.js†L2586-L2590】
    - Dependencies: Uses `applyBoostImpulse` along with `Math.max` and boost timing constants from `drift`.【F:src/gameplay.js†L1204-L1207】
    - Edge cases handled or missed: Returns immediately if no zone is provided; assumes timers are numeric and non-negative.【F:src/gameplay.js†L1202-L1207】
    - Performance: Constant; runs only when a jump boost is triggered.【F:src/gameplay.js†L1884-L1901】【F:src/gameplay.js†L2586-L2590】
    - Units / spaces: Timer values are measured in seconds, aligning with physics time `phys.t`.【F:src/gameplay.js†L1204-L1207】
    - Determinism: Deterministic; no randomness involved.【F:src/gameplay.js†L1202-L1207】
    - Keep / change / delete: Keep; bundles jump-specific boost side effects in one place.
    - Confidence / assumptions: High confidence; assumes `state.phys.boostFlashTimer` exists and is time-based.

  - `playerHalfWN`
    - Purpose: Computes half of the player's sprite width in normalized lane units for spacing and collision checks.【F:src/gameplay.js†L1209-L1211】
    - Inputs: None; references player sprite metadata and scale from state.【F:src/gameplay.js†L1209-L1211】
    - Outputs: Returns half-width in normalized units (may be `0` if metadata is missing).【F:src/gameplay.js†L1209-L1211】
    - Side effects: None.【F:src/gameplay.js†L1209-L1211】
    - Shared state touched and where it’s used: Reads sprite meta via `getSpriteMeta` and `state.getKindScale`; widely used for smoke spawning, sparks, lateral limits, and collision tests.【F:src/gameplay.js†L1209-L1211】【F:src/gameplay.js†L1213-L1296】【F:src/gameplay.js†L1904-L1917】【F:src/gameplay.js†L1922-L1975】
    - Dependencies: Depends on `getSpriteMeta('PLAYER')` and `state.getKindScale('PLAYER')`.【F:src/gameplay.js†L1209-L1211】
    - Edge cases handled or missed: Returns `NaN` if player metadata lacks `wN`, so it assumes the metadata is populated.【F:src/gameplay.js†L1209-L1211】
    - Performance: Constant; invoked in several per-frame loops so keeping it lightweight avoids repeated metadata math in callers.【F:src/gameplay.js†L1213-L1975】
    - Units / spaces: Normalized road-width (`N`) units.【F:src/gameplay.js†L1209-L1211】
    - Determinism: Deterministic for the same sprite meta and scale.【F:src/gameplay.js†L1209-L1211】
    - Keep / change / delete: Keep; avoids duplicating scale logic throughout gameplay code.
    - Confidence / assumptions: Medium confidence; assumes metadata is loaded before use.

  - `spawnDriftSmokeSprites`
    - Purpose: Spawns transient drift-smoke sprites at both sides of the player while drifting to visualize tire slip.【F:src/gameplay.js†L1213-L1247】
    - Inputs: None; relies on current physics state for position, velocity, and segment selection.【F:src/gameplay.js†L1213-L1247】
    - Outputs: Returns nothing; appends new sprite objects into the current segment's `sprites` list.【F:src/gameplay.js†L1221-L1247】
    - Side effects: Allocates sprites via `allocDriftSmokeSprite`, mutates segment sprite arrays, and uses `Math.random` for jitter and inherited speed, introducing nondeterminism.【F:src/gameplay.js†L1221-L1247】
    - Shared state touched and where it’s used: Reads and writes segment sprite arrays and physics data; called repeatedly during the drift state update loop.【F:src/gameplay.js†L1213-L1247】【F:src/gameplay.js†L2289-L2299】
    - Dependencies: Uses `hasSegments`, `segmentAtS`, `playerHalfWN`, `ensureArray`, `trackLengthRef`, `wrapDistance`, and sprite allocation helpers.【F:src/gameplay.js†L1213-L1247】
    - Edge cases handled or missed: Early-outs if segments/physics are unavailable or the player is airborne; assumes `allocDriftSmokeSprite` succeeds and does not guard against allocation failure.【F:src/gameplay.js†L1213-L1247】
    - Performance: Loops over two offsets and allocates per iteration; triggered repeatedly while drifting so excessive drift duration can create many sprites.【F:src/gameplay.js†L1220-L1247】【F:src/gameplay.js†L2289-L2299】
    - Units / spaces: Positions sprites using normalized lateral offsets and wrapped track distance `s`; TTL measured in seconds.【F:src/gameplay.js†L1219-L1238】
    - Determinism: Non-deterministic because of multiple `Math.random()` samples for jitter and speed variance.【F:src/gameplay.js†L1230-L1233】
    - Keep / change / delete: Keep; encapsulates all drift-smoke initialization logic though pooling could limit allocations further.
    - Confidence / assumptions: Medium confidence; assumes sprite pools are large enough to satisfy allocations without leaks.

  - `spawnSparksSprites`
    - Purpose: Emits spark sprites near the contact side when the player scrapes a guard rail for visual feedback.【F:src/gameplay.js†L1250-L1296】
    - Inputs: `contactSide` — optional sign indicating which side triggered the sparks (defaults to player leaning side).【F:src/gameplay.js†L1250-L1259】
    - Outputs: No return; appends configured spark sprites to the current segment.【F:src/gameplay.js†L1260-L1296】
    - Side effects: Allocates sprites, mutates segment arrays, and samples random jitter, velocities, and screen offsets, affecting determinism.【F:src/gameplay.js†L1260-L1296】
    - Shared state touched and where it’s used: Uses physics state, player lateral position, and guard-rail contact; invoked inside the guard-rail handling loop in the physics update.【F:src/gameplay.js†L1250-L1296】【F:src/gameplay.js†L2366-L2377】
    - Dependencies: Relies on `hasSegments`, `segmentAtS`, `playerHalfWN`, `ensureArray`, `trackLengthRef`, `wrapDistance`, `allocSparksSprite`, and interpolation helpers like `lerp`.【F:src/gameplay.js†L1250-L1296】
    - Edge cases handled or missed: Exits when no segments, when the player is airborne, or when contact side is indeterminate; assumes sprite allocation succeeds.【F:src/gameplay.js†L1251-L1296】
    - Performance: Creates one sprite per call with several random computations; executed repeatedly while scraping rails, so sustained contact spawns many particles.【F:src/gameplay.js†L1259-L1296】【F:src/gameplay.js†L2366-L2377】
    - Units / spaces: Positions use normalized offsets and wrapped track distance; motion data mixes track units with screen-space velocities.【F:src/gameplay.js†L1259-L1295】
    - Determinism: Non-deterministic because of jitter and random velocity sampling.【F:src/gameplay.js†L1269-L1291】
    - Keep / change / delete: Keep; encapsulates spark setup though random seeds could be injected for replay determinism.
    - Confidence / assumptions: Medium confidence; assumes guard-rail contact detection prevents duplicate spawns within a frame.

  - `applyDriftSmokeMotion`
    - Purpose: Advances drift-smoke sprite motion over time, applying drag and moving sprites between segments when necessary.【F:src/gameplay.js†L1299-L1338】
    - Inputs: `sprite` — expected to be a drift-smoke sprite; `dt` — simulation step in seconds; `currentSeg` — segment currently iterated (optional).【F:src/gameplay.js†L1299-L1305】
    - Outputs: Returns a new segment reference when the sprite crosses into another segment; otherwise `null`.【F:src/gameplay.js†L1308-L1338】
    - Side effects: Mutates the sprite’s position, offsets, and drift motion velocities with drag decay.【F:src/gameplay.js†L1308-L1334】
    - Shared state touched and where it’s used: Reads track length and segment data; invoked during the per-frame sprite animation update loop.【F:src/gameplay.js†L1299-L1338】【F:src/gameplay.js†L2040-L2108】
    - Dependencies: Uses `trackLengthRef`, `wrapDistance`, and `segmentAtS` for wrapping and segment lookup.【F:src/gameplay.js†L1306-L1334】
    - Edge cases handled or missed: Returns early for missing sprites, wrong kinds, or non-positive time steps; assumes `sprite.driftMotion` exists.【F:src/gameplay.js†L1299-L1334】
    - Performance: Constant work per sprite; executed for every drift-smoke sprite each frame, so large numbers of smoke puffs can add up.【F:src/gameplay.js†L1299-L1338】【F:src/gameplay.js†L2040-L2108】
    - Units / spaces: Evolves both track-distance `s` and normalized lateral offset values; drag factors interpreted per second.【F:src/gameplay.js†L1308-L1334】
    - Determinism: Deterministic for given initial motion values and `dt`.【F:src/gameplay.js†L1299-L1338】
    - Keep / change / delete: Keep; isolates physics integration for smoke particles.
    - Confidence / assumptions: High confidence; assumes calling code initializes `sprite.driftMotion`.

  - `applySparksMotion`
    - Purpose: Updates spark sprite motion, including track movement, lateral slide, and screen-space trails.【F:src/gameplay.js†L1341-L1406】
    - Inputs: `sprite` — spark sprite; `dt` — time step; `currentSeg` — current segment context.【F:src/gameplay.js†L1341-L1346】
    - Outputs: Returns a different segment when the sprite crosses boundaries, otherwise `null`.【F:src/gameplay.js†L1350-L1404】
    - Side effects: Mutates track position, normalized offset, screen offsets, and motion velocities with drag and gravity.【F:src/gameplay.js†L1350-L1394】
    - Shared state touched and where it’s used: Reads track length and segment data; invoked during sprite animation updates for every spark sprite.【F:src/gameplay.js†L1341-L1404】【F:src/gameplay.js†L2040-L2108】
    - Dependencies: Uses `trackLengthRef`, `wrapDistance`, `segmentAtS`, and drag parameters stored on the sprite.【F:src/gameplay.js†L1348-L1404】
    - Edge cases handled or missed: Early returns for invalid sprites or zero time steps; assumes `sprite.driftMotion` carries screen-motion parameters.【F:src/gameplay.js†L1341-L1394】
    - Performance: Constant per sprite; cost grows with number of active sparks spawned during scraping.【F:src/gameplay.js†L1341-L1404】【F:src/gameplay.js†L2366-L2377】【F:src/gameplay.js†L2040-L2108】
    - Units / spaces: Mixes track-distance `s`, normalized offsets, and pixel-space offsets for screen trails.【F:src/gameplay.js†L1350-L1394】
    - Determinism: Deterministic once initial motion parameters are set (randomness happens at spawn time).【F:src/gameplay.js†L1341-L1404】
    - Keep / change / delete: Keep; provides encapsulated kinematics for sparks.
    - Confidence / assumptions: High confidence; assumes spark sprites always own a motion payload.

  - `carMeta`
    - Purpose: Retrieves the metadata describing a car sprite, defaulting to generic car data when custom metadata is absent.【F:src/gameplay.js†L1408-L1411】
    - Inputs: `car` — NPC car object that may include `type` and `meta`.【F:src/gameplay.js†L1408-L1411】
    - Outputs: Returns a metadata object for the car sprite.【F:src/gameplay.js†L1408-L1411】
    - Side effects: None.【F:src/gameplay.js†L1408-L1411】
    - Shared state touched and where it’s used: Reads from the sprite metadata table via `getSpriteMeta`; used by width/height helpers before collision logic.【F:src/gameplay.js†L1408-L1415】【F:src/gameplay.js†L1574-L1583】
    - Dependencies: Depends on `getSpriteMeta` and optional `car.meta` overrides.【F:src/gameplay.js†L1408-L1411】
    - Edge cases handled or missed: Falls back to `'CAR'` metadata when car type/meta missing; assumes `getSpriteMeta` returns something meaningful.【F:src/gameplay.js†L1408-L1411】
    - Performance: Constant and inexpensive; called for each collision width/height calculation.【F:src/gameplay.js†L1408-L1415】【F:src/gameplay.js†L1574-L1583】
    - Units / spaces: Metadata includes normalized width/height values used elsewhere.【F:src/gameplay.js†L1408-L1415】
    - Determinism: Deterministic for a given car object and metadata table.【F:src/gameplay.js†L1408-L1411】
    - Keep / change / delete: Keep; centralizes metadata fallback logic.
    - Confidence / assumptions: High confidence; assumes metadata table is already loaded.

  - `carHalfWN`
    - Purpose: Calculates half the normalized width of an NPC car to support spacing, avoidance, and collision checks.【F:src/gameplay.js†L1413-L1415】
    - Inputs: `car` — NPC car descriptor.【F:src/gameplay.js†L1413-L1415】
    - Outputs: Returns half-width in normalized units, defaulting to `0` if metadata lacks `wN`.【F:src/gameplay.js†L1413-L1415】
    - Side effects: None.【F:src/gameplay.js†L1413-L1415】
    - Shared state touched and where it’s used: Leverages `carMeta`; referenced by player smoke spawning and collision avoidance routines.【F:src/gameplay.js†L1413-L1415】【F:src/gameplay.js†L1213-L1296】【F:src/gameplay.js†L1965-L2000】【F:src/gameplay.js†L2455-L2535】
    - Dependencies: Calls `carMeta` to fetch the metadata.【F:src/gameplay.js†L1413-L1415】
    - Edge cases handled or missed: Returns `0` if metadata is missing or lacks `wN`, which may underrepresent actual car width.【F:src/gameplay.js†L1413-L1415】
    - Performance: Constant; computed frequently inside loops so avoiding repeated metadata lookups via this helper keeps code concise.【F:src/gameplay.js†L1413-L1415】
    - Units / spaces: Normalized road width units shared with NPC positioning.【F:src/gameplay.js†L1413-L1415】
    - Determinism: Deterministic for the same car metadata.【F:src/gameplay.js†L1413-L1415】
    - Keep / change / delete: Keep; simple helper aids readability.
    - Confidence / assumptions: High confidence; assumes metadata is static per car.

  - `currentPlayerForwardSpeed`
    - Purpose: Returns the player's current forward (tangential) speed clamped to a non-negative value.【F:src/gameplay.js†L1418-L1421】
    - Inputs: None; reads from `state.phys.vtan`.【F:src/gameplay.js†L1418-L1421】
    - Outputs: Non-negative numeric forward speed.【F:src/gameplay.js†L1418-L1421】
    - Side effects: None.【F:src/gameplay.js†L1418-L1421】
    - Shared state touched and where it’s used: Reads physics state; leveraged when computing near misses and sprite collision pushes.【F:src/gameplay.js†L1418-L1421】【F:src/gameplay.js†L1449-L1451】【F:src/gameplay.js†L1515-L1525】
    - Dependencies: Uses `Math.max` and `Number.isFinite` to sanitize values.【F:src/gameplay.js†L1418-L1421】
    - Edge cases handled or missed: Treats non-finite speeds as zero; assumes physics state exists.【F:src/gameplay.js†L1418-L1421】
    - Performance: Constant; often called during collision handling but trivial in cost.【F:src/gameplay.js†L1418-L1451】
    - Units / spaces: Tangential world speed units.【F:src/gameplay.js†L1418-L1421】
    - Determinism: Deterministic.【F:src/gameplay.js†L1418-L1421】
    - Keep / change / delete: Keep; avoids repeating guard logic on `state.phys.vtan`.
    - Confidence / assumptions: High confidence; assumes physics state object stays defined.

  - `npcForwardSpeed`
    - Purpose: Sanitizes an NPC car's forward speed for collision comparisons.【F:src/gameplay.js†L1423-L1425】
    - Inputs: `car` — NPC car with a `speed` property.【F:src/gameplay.js†L1423-L1425】
    - Outputs: Returns a non-negative forward speed.【F:src/gameplay.js†L1423-L1425】
    - Side effects: None.【F:src/gameplay.js†L1423-L1425】
    - Shared state touched and where it’s used: Reads the car object; used in near-miss scoring and collision resolution to determine push direction.【F:src/gameplay.js†L1423-L1425】【F:src/gameplay.js†L1450-L1451】【F:src/gameplay.js†L1991-L1995】
    - Dependencies: None beyond basic math checks.【F:src/gameplay.js†L1423-L1425】
    - Edge cases handled or missed: Returns `0` when the car or speed is invalid; assumes speeds are already in player-forward units.【F:src/gameplay.js†L1423-L1425】
    - Performance: Constant.【F:src/gameplay.js†L1423-L1425】
    - Units / spaces: Tangential world speed.【F:src/gameplay.js†L1423-L1425】
    - Determinism: Deterministic.【F:src/gameplay.js†L1423-L1425】
    - Keep / change / delete: Keep; keeps sanity checks centralized.
    - Confidence / assumptions: High confidence; assumes car objects expose `speed`.

  - `ensureCarNearMissReset`
    - Purpose: Marks an NPC car as ready for a future near-miss when the player is sufficiently far laterally away.【F:src/gameplay.js†L1428-L1436】
    - Inputs: `car` — NPC object; `combinedHalf` — sum of player and car half-widths; `lateralGap` — current lateral separation.【F:src/gameplay.js†L1428-L1436】
    - Outputs: None.【F:src/gameplay.js†L1428-L1436】
    - Side effects: Mutates the car’s `CAR_NEAR_MISS_READY` flag.【F:src/gameplay.js†L1428-L1436】
    - Shared state touched and where it’s used: Operates on car state within collision loops; called each time cars are evaluated for overlap.【F:src/gameplay.js†L1428-L1436】【F:src/gameplay.js†L1965-L1975】
    - Dependencies: Relies on numeric checks and `NEAR_MISS_RESET_SCALE` constant.【F:src/gameplay.js†L1434-L1436】
    - Edge cases handled or missed: Immediately readies the flag when parameters are invalid or combined width is non-positive; assumes `car` is mutable.【F:src/gameplay.js†L1428-L1436】
    - Performance: Constant per car.【F:src/gameplay.js†L1428-L1436】
    - Units / spaces: Lateral distances in normalized lane units.【F:src/gameplay.js†L1434-L1436】
    - Determinism: Deterministic.【F:src/gameplay.js†L1428-L1436】
    - Keep / change / delete: Keep; keeps near-miss gating logic separate from collision detection.
    - Confidence / assumptions: High confidence; assumes callers provide consistent gap measurements.

  - `tryRegisterCarNearMiss`
    - Purpose: Detects and records a near-miss event when the player passes close to an NPC without colliding.【F:src/gameplay.js†L1439-L1455】
    - Inputs: `car`, `combinedHalf`, and `lateralGap` matching the collision context.【F:src/gameplay.js†L1439-L1444】
    - Outputs: None.【F:src/gameplay.js†L1439-L1455】
    - Side effects: Updates the car’s `CAR_NEAR_MISS_READY` flag and increments `state.metrics.nearMisses`.【F:src/gameplay.js†L1453-L1455】
    - Shared state touched and where it’s used: Requires `state.metrics` and physics state; invoked in the car collision loop after separation checks.【F:src/gameplay.js†L1439-L1455】【F:src/gameplay.js†L1965-L1975】
    - Dependencies: Uses `shortestSignedTrackDistance`, `currentPlayerForwardSpeed`, and `npcForwardSpeed` to verify near-miss conditions.【F:src/gameplay.js†L1445-L1451】
    - Edge cases handled or missed: Exits when metrics are absent, when the car isn’t ready, or when gaps exceed thresholds; assumes `phys.s` and `car.z` are finite.【F:src/gameplay.js†L1439-L1451】
    - Performance: Constant per candidate car.【F:src/gameplay.js†L1439-L1455】
    - Units / spaces: Mixes track distance (`s`) with normalized lateral distance checks.【F:src/gameplay.js†L1445-L1451】
    - Determinism: Deterministic given state and inputs.【F:src/gameplay.js†L1439-L1455】
    - Keep / change / delete: Keep; isolates metrics bookkeeping from collision logic.
    - Confidence / assumptions: Medium confidence; assumes metrics object is initialized before collisions are processed.

  - `computeCollisionPush`
    - Purpose: Calculates forward and lateral push velocities to separate the player from another object after contact.【F:src/gameplay.js†L1457-L1491】
    - Inputs: `forwardSpeed` — player speed; `playerOffset`/`targetOffset` — normalized lateral positions; `forwardMaxSegments`/`lateralMax` — tuning caps (defaults supplied).【F:src/gameplay.js†L1457-L1463】
    - Outputs: Returns `{ forwardVel, lateralVel }` or `null` when no push is needed.【F:src/gameplay.js†L1470-L1491】
    - Side effects: None.【F:src/gameplay.js†L1457-L1491】
    - Shared state touched and where it’s used: Reads tuning constants and `segmentLength`; used when applying pushes to sprites and NPC cars after collisions.【F:src/gameplay.js†L1457-L1491】【F:src/gameplay.js†L1515-L1526】【F:src/gameplay.js†L1596-L1610】
    - Dependencies: Uses `clamp01`, `Math.sign`, and collision tuning constants such as `COLLISION_PUSH_DURATION`.【F:src/gameplay.js†L1470-L1489】
    - Edge cases handled or missed: Returns `null` for zero speeds, missing segment length, or negligible offsets; assumes offsets are normalized to [-1,1].【F:src/gameplay.js†L1464-L1486】
    - Performance: Constant; called only when a collision requires response.【F:src/gameplay.js†L1457-L1491】
    - Units / spaces: Converts normalized distances and segment counts into world velocities via segment length and duration.【F:src/gameplay.js†L1470-L1491】
    - Determinism: Deterministic for given inputs.【F:src/gameplay.js†L1457-L1491】
    - Keep / change / delete: Keep; reusable push computation shared by sprites and cars.
    - Confidence / assumptions: High confidence; assumes tuning constants remain positive.

  - `configureImpactableSprite`
    - Purpose: Initializes and sanitizes the impact motion state on an impactable sprite so collision pushes can be applied safely.【F:src/gameplay.js†L1494-L1506】
    - Inputs: `sprite` — sprite descriptor expected to carry `impactable` flag.【F:src/gameplay.js†L1494-L1496】
    - Outputs: Returns the sprite’s `impactState` object or `null` when not impactable.【F:src/gameplay.js†L1497-L1506】
    - Side effects: Creates or normalizes `sprite.impactState`, setting default timers and velocities to zero.【F:src/gameplay.js†L1497-L1505】
    - Shared state touched and where it’s used: Called during sprite creation and whenever pushes update impactable sprites; mutates the sprite object in place.【F:src/gameplay.js†L858-L861】【F:src/gameplay.js†L1494-L1506】【F:src/gameplay.js†L1512-L1515】【F:src/gameplay.js†L1531-L1532】
    - Dependencies: Relies on `Number.isFinite` checks and the sprite’s `impactable` flag.【F:src/gameplay.js†L1494-L1505】
    - Edge cases handled or missed: Returns `null` when the sprite is absent or not impactable; resets NaN timers/velocities to zero but assumes the sprite object is mutable.【F:src/gameplay.js†L1494-L1505】
    - Performance: Constant and cheap; invoked per impactable sprite during interactions and animation updates.【F:src/gameplay.js†L1494-L1532】【F:src/gameplay.js†L2040-L2108】
    - Units / spaces: Stores velocities in track/lateral units consistent with collision push logic.【F:src/gameplay.js†L1497-L1505】
    - Determinism: Deterministic; no randomness involved.【F:src/gameplay.js†L1494-L1506】
    - Keep / change / delete: Keep; provides a safe initialization point for impactable sprites.
    - Confidence / assumptions: High confidence; assumes all impactable sprites should carry a mutable `impactState`.

  - `applyImpactPushToSprite`
    - Purpose: Applies a freshly computed collision push to an impactable sprite, starting its impact timer and velocity.【F:src/gameplay.js†L1509-L1526】
    - Inputs: `sprite` — candidate sprite to push.【F:src/gameplay.js†L1509-L1515】
    - Outputs: None.【F:src/gameplay.js†L1509-L1526】
    - Side effects: Configures the sprite’s impact state and writes new lateral/forward velocities plus timer duration.【F:src/gameplay.js†L1512-L1526】
    - Shared state touched and where it’s used: Reads player state for offsets and stores results on the sprite; called when resolving sprite interactions with the player.【F:src/gameplay.js†L1515-L1526】【F:src/gameplay.js†L1951-L1953】
    - Dependencies: Uses `configureImpactableSprite`, `computeCollisionPush`, `currentPlayerForwardSpeed`, and collision tuning constants.【F:src/gameplay.js†L1512-L1526】
    - Edge cases handled or missed: Returns early if the sprite is absent, not impactable, or if no push is produced; assumes `sprite.offset` is valid.【F:src/gameplay.js†L1509-L1525】
    - Performance: Constant; runs when the player collides with an impactable sprite, which is relatively infrequent.【F:src/gameplay.js†L1509-L1526】【F:src/gameplay.js†L1924-L1958】
    - Units / spaces: Velocities align with track distance per second and normalized lateral offsets.【F:src/gameplay.js†L1515-L1526】
    - Determinism: Deterministic for identical collision contexts.【F:src/gameplay.js†L1509-L1526】
    - Keep / change / delete: Keep; bridges collision detection and sprite motion in a focused helper.
    - Confidence / assumptions: High confidence; assumes `sprite.offset` mirrors normalized N space.

  - `updateImpactableSprite`
    - Purpose: Steps an impactable sprite’s push motion forward, updating offsets, timers, and optionally moving it to a new segment.【F:src/gameplay.js†L1529-L1572】
    - Inputs: `sprite` — impactable sprite; `dt` — elapsed time; `currentSeg` — segment currently iterated (optional).【F:src/gameplay.js†L1529-L1537】
    - Outputs: Returns the new segment when the sprite crosses into another, otherwise `null`.【F:src/gameplay.js†L1548-L1571】
    - Side effects: Mutates sprite offsets, wrapped `s` position, and impact velocities/timer; may update `sprite.segIndex`.【F:src/gameplay.js†L1536-L1568】
    - Shared state touched and where it’s used: Uses track queries and physics state for wrapping; invoked inside the sprite animation loop each frame.【F:src/gameplay.js†L1529-L1571】【F:src/gameplay.js†L2040-L2108】
    - Dependencies: Calls `configureImpactableSprite`, `trackLengthRef`, `segmentAtIndex`, `wrapDistance`, and `segmentAtS`.【F:src/gameplay.js†L1531-L1558】
    - Edge cases handled or missed: Returns early for invalid sprites or non-positive `dt`; clamps timers and zeroes velocities when finished, but assumes `sprite.segIndex` is valid when wrapping.【F:src/gameplay.js†L1529-L1568】
    - Performance: Constant work per sprite per frame; heavy numbers of impactable sprites could add cost.【F:src/gameplay.js†L1529-L1571】【F:src/gameplay.js†L2040-L2108】
    - Units / spaces: Handles normalized lateral offsets and wrapped track distance (`s`), with timers in seconds.【F:src/gameplay.js†L1544-L1568】
    - Determinism: Deterministic given identical initial impact state and `dt`.【F:src/gameplay.js†L1529-L1571】
    - Keep / change / delete: Keep; cleanly separates impact motion from interaction detection.
    - Confidence / assumptions: Medium confidence; assumes referenced segments remain valid while sprites move.

  - `carHitboxHeight`
    - Purpose: Calculates an NPC car’s hitbox height in world units, honoring explicit overrides or deriving it from width and aspect ratio.【F:src/gameplay.js†L1574-L1583】
    - Inputs: `car` — NPC descriptor; `s` — optional longitudinal position for road-width queries (defaults to player `s`).【F:src/gameplay.js†L1574-L1580】
    - Outputs: Returns a numeric height in world units.【F:src/gameplay.js†L1578-L1583】
    - Side effects: None.【F:src/gameplay.js†L1574-L1583】
    - Shared state touched and where it’s used: Reads track width functions and car metadata; used when checking if the player is above an NPC during collisions.【F:src/gameplay.js†L1574-L1589】【F:src/gameplay.js†L1978-L1988】
    - Dependencies: Calls `carMeta`, `roadWidthAt`, and falls back to `track.roadWidth`.【F:src/gameplay.js†L1574-L1580】
    - Edge cases handled or missed: Supports explicit `hitbox.height` or `heightN`; assumes aspect ratios and widths are finite and returns `0` otherwise.【F:src/gameplay.js†L1576-L1583】
    - Performance: Constant; invoked for each collision height check.【F:src/gameplay.js†L1574-L1583】
    - Units / spaces: World height units consistent with elevation samples.【F:src/gameplay.js†L1579-L1583】
    - Determinism: Deterministic given car metadata and track width.【F:src/gameplay.js†L1574-L1583】
    - Keep / change / delete: Keep; centralizes hitbox derivation logic.
    - Confidence / assumptions: Medium confidence; assumes `roadWidthAt` is available or falls back to `track.roadWidth`.

  - `carHitboxTopY`
    - Purpose: Computes the world-space Y coordinate of an NPC car’s hitbox top, blending road elevation with hitbox height.【F:src/gameplay.js†L1586-L1591】
    - Inputs: `car` — NPC descriptor (uses its `z` and lateral offset when available).【F:src/gameplay.js†L1586-L1589】
    - Outputs: Returns a world Y coordinate.【F:src/gameplay.js†L1589-L1591】
    - Side effects: None.【F:src/gameplay.js†L1586-L1591】
    - Shared state touched and where it’s used: Reads from physics state and elevation functions; used to ensure airborne players clear NPC roofs before treating contacts as collisions.【F:src/gameplay.js†L1586-L1591】【F:src/gameplay.js†L1978-L1988】
    - Dependencies: Uses `floorElevationAt` when available, falling back to `elevationAt`, plus `carHitboxHeight`.【F:src/gameplay.js†L1588-L1591】
    - Edge cases handled or missed: Defaults to player `s` and zero lateral offset when car data is missing; assumes elevation helpers return finite numbers.【F:src/gameplay.js†L1586-L1591】
    - Performance: Constant.【F:src/gameplay.js†L1586-L1591】
    - Units / spaces: World vertical units consistent with road elevation.【F:src/gameplay.js†L1588-L1591】
    - Determinism: Deterministic given the same inputs.【F:src/gameplay.js†L1586-L1591】
    - Keep / change / delete: Keep; simplifies collision height comparisons.
    - Confidence / assumptions: High confidence; assumes elevation helpers are reliable at the queried positions.

  - `applyNpcCollisionPush`
    - Purpose: Starts a collision push response on an NPC car when the player rear-ends it, mirroring the player-side push.【F:src/gameplay.js†L1593-L1610】
    - Inputs: `car` — NPC to push; `playerForwardSpeed` — player speed at impact.【F:src/gameplay.js†L1593-L1600】
    - Outputs: None.【F:src/gameplay.js†L1593-L1610】
    - Side effects: Ensures `car.collisionPush` exists then sets its velocities and timer.【F:src/gameplay.js†L1605-L1610】
    - Shared state touched and where it’s used: Mutates the NPC car object; called during player-vs-NPC collision resolution.【F:src/gameplay.js†L1593-L1610】【F:src/gameplay.js†L1993-L2015】
    - Dependencies: Uses `computeCollisionPush` and collision tuning constants including `COLLISION_PUSH_DURATION`.【F:src/gameplay.js†L1596-L1610】
    - Edge cases handled or missed: Returns if the car is missing or if `computeCollisionPush` yields nothing; assumes NPC object is mutable.【F:src/gameplay.js†L1593-L1608】
    - Performance: Constant per collision event.【F:src/gameplay.js†L1593-L1610】
    - Units / spaces: Push velocities share the same track-distance and normalized lateral units as the player push.【F:src/gameplay.js†L1596-L1610】
    - Determinism: Deterministic for a given collision context.【F:src/gameplay.js†L1593-L1610】
    - Keep / change / delete: Keep; mirrors player push logic for NPC feedback.
    - Confidence / assumptions: High confidence; assumes `COLLISION_PUSH_DURATION` positive.

  - `playerBaseHeight`
    - Purpose: Determines the player’s current floor height, choosing the road surface when grounded or the physics Y when airborne.【F:src/gameplay.js†L1613-L1618】
    - Inputs: None.【F:src/gameplay.js†L1613-L1618】
    - Outputs: Returns a world Y value.【F:src/gameplay.js†L1613-L1618】
    - Side effects: None.【F:src/gameplay.js†L1613-L1618】
    - Shared state touched and where it’s used: Reads from `state.phys` and `floorElevationAt`; used in collision checks to skip NPC hits while airborne.【F:src/gameplay.js†L1613-L1618】【F:src/gameplay.js†L1978-L1988】
    - Dependencies: Uses `floorElevationAt` when grounded.【F:src/gameplay.js†L1614-L1617】
    - Edge cases handled or missed: Falls back to `phys.y` when ungrounded or when floor samplers are unavailable; assumes physics state exists.【F:src/gameplay.js†L1613-L1618】
    - Performance: Constant.【F:src/gameplay.js†L1613-L1618】
    - Units / spaces: World height units.【F:src/gameplay.js†L1613-L1618】
    - Determinism: Deterministic.【F:src/gameplay.js†L1613-L1618】
    - Keep / change / delete: Keep; clarifies base-height logic across collision checks.
    - Confidence / assumptions: High confidence; assumes `phys.grounded` flag accurately reflects landing state.

  - `npcLateralLimit`
    - Purpose: Calculates how far an NPC car may move laterally, respecting its width, safety padding, and guard-rail constraints.【F:src/gameplay.js†L1621-L1629】
    - Inputs: `segIndex` — segment index; `car` — NPC descriptor.【F:src/gameplay.js†L1621-L1628】
    - Outputs: Returns a symmetric lateral limit in normalized units.【F:src/gameplay.js†L1621-L1629】
    - Side effects: None.【F:src/gameplay.js†L1621-L1629】
    - Shared state touched and where it’s used: Reads car metadata, track rail info, and NPC tuning; used across NPC spawn, steering, and collision logic to clamp offsets.【F:src/gameplay.js†L1621-L1629】【F:src/gameplay.js†L2455-L2535】
    - Dependencies: Uses `carHalfWN`, `segmentAtIndex`, and track guard-rail configuration.【F:src/gameplay.js†L1621-L1628】
    - Edge cases handled or missed: Accounts for guard rails when present; assumes `track.railInset` and NPC padding values are valid numbers.【F:src/gameplay.js†L1623-L1628】
    - Performance: Constant; invoked repeatedly while steering NPCs.【F:src/gameplay.js†L1621-L1629】【F:src/gameplay.js†L2455-L2535】
    - Units / spaces: Normalized lane units relative to the road width.【F:src/gameplay.js†L1621-L1629】
    - Determinism: Deterministic.【F:src/gameplay.js†L1621-L1629】
    - Keep / change / delete: Keep; encapsulates guard-rail aware clamping.
    - Confidence / assumptions: Medium confidence; assumes segment guard-rail data stays synchronized with indices.

  - `slopeAngleDeg`
    - Purpose: Converts a slope ratio into an absolute angle in degrees for cliff limit comparisons.【F:src/gameplay.js†L1632-L1635】
    - Inputs: `slope` — rise/run ratio.【F:src/gameplay.js†L1632-L1635】
    - Outputs: Returns the absolute slope angle in degrees (or `0` for invalid input).【F:src/gameplay.js†L1632-L1635】
    - Side effects: None.【F:src/gameplay.js†L1632-L1635】
    - Shared state touched and where it’s used: Used by `slopeLimitRatio` and cliff-steepness evaluation code.【F:src/gameplay.js†L1632-L1639】【F:src/gameplay.js†L1848-L1853】
    - Dependencies: Relies on `Math.atan`, `Math.abs`, and conversion to degrees.【F:src/gameplay.js†L1632-L1635】
    - Edge cases handled or missed: Returns `0` when slope is non-finite, preventing downstream NaNs.【F:src/gameplay.js†L1632-L1635】
    - Performance: Constant.【F:src/gameplay.js†L1632-L1635】
    - Units / spaces: Outputs degrees derived from slope ratios.【F:src/gameplay.js†L1632-L1635】
    - Determinism: Deterministic.【F:src/gameplay.js†L1632-L1635】
    - Keep / change / delete: Keep; small helper keeps degree conversion centralized.
    - Confidence / assumptions: High confidence; assumes slope inputs are numeric.

  - `slopeLimitRatio`
    - Purpose: Expresses how close a slope is to the configured cliff angle limit as a 0..1+ ratio.【F:src/gameplay.js†L1637-L1641】
    - Inputs: `slope` — rise/run ratio.【F:src/gameplay.js†L1637-L1641】
    - Outputs: Returns `angleDeg / CLIFF_LIMIT_DEG`, or `0` when the limit is disabled.【F:src/gameplay.js†L1637-L1641】
    - Side effects: None.【F:src/gameplay.js†L1637-L1641】
    - Shared state touched and where it’s used: Reads global `CLIFF_LIMIT_DEG`; used by `slopeExceedsLimit` and cliff steepness heuristics.【F:src/gameplay.js†L1637-L1645】【F:src/gameplay.js†L1850-L1853】
    - Dependencies: Calls `slopeAngleDeg`.【F:src/gameplay.js†L1637-L1640】
    - Edge cases handled or missed: Returns `0` when the limit is missing or non-positive, effectively disabling ratio-based logic.【F:src/gameplay.js†L1637-L1641】
    - Performance: Constant.【F:src/gameplay.js†L1637-L1641】
    - Units / spaces: Ratio (unitless).【F:src/gameplay.js†L1637-L1641】
    - Determinism: Deterministic.【F:src/gameplay.js†L1637-L1641】
    - Keep / change / delete: Keep; simple ratio helper clarifies limit math.
    - Confidence / assumptions: High confidence; assumes `CLIFF_LIMIT_DEG` describes a positive degree limit when enabled.

  - `slopeExceedsLimit`
    - Purpose: Flags slopes whose angle surpasses the configured cliff safety threshold.【F:src/gameplay.js†L1643-L1645】
    - Inputs: `slope` — rise/run ratio.【F:src/gameplay.js†L1643-L1645】
    - Outputs: Boolean indicating whether the slope is over the limit.【F:src/gameplay.js†L1643-L1645】
    - Side effects: None.【F:src/gameplay.js†L1643-L1645】
    - Shared state touched and where it’s used: Checks `CLIFF_LIMIT_DEG`; referenced by section and surface evaluators when warning about steep cliffs.【F:src/gameplay.js†L1643-L1663】
    - Dependencies: Calls `slopeLimitRatio`.【F:src/gameplay.js†L1644-L1645】
    - Edge cases handled or missed: Returns `false` when the limit is unset or non-positive; assumes slope ratio input is finite.【F:src/gameplay.js†L1643-L1645】
    - Performance: Constant.【F:src/gameplay.js†L1643-L1645】
    - Units / spaces: Operates on slope ratios; result unitless.【F:src/gameplay.js†L1643-L1645】
    - Determinism: Deterministic.【F:src/gameplay.js†L1643-L1645】
    - Keep / change / delete: Keep; keeps slope comparisons consistent.
    - Confidence / assumptions: High confidence; assumes `slopeLimitRatio` returns sensible ratios.

  - `cliffSectionExceedsLimit`
    - Purpose: Evaluates a cliff cross-section’s slope to determine if it breaches the configured steepness limit.【F:src/gameplay.js†L1648-L1654】
    - Inputs: `section` — object containing `dx`/`dy` components.【F:src/gameplay.js†L1648-L1653】
    - Outputs: Boolean indicating whether the section exceeds the limit.【F:src/gameplay.js†L1648-L1654】
    - Side effects: None.【F:src/gameplay.js†L1648-L1654】
    - Shared state touched and where it’s used: Consumed by `segmentHasSteepCliff` when scanning cliff samples.【F:src/gameplay.js†L1674-L1688】
    - Dependencies: Calls `slopeExceedsLimit` after computing slope magnitude from `dx`/`dy`.【F:src/gameplay.js†L1652-L1654】
    - Edge cases handled or missed: Returns `false` when the section is missing or nearly flat (both deltas near zero); assumes `dx`/`dy` measured in consistent units.【F:src/gameplay.js†L1648-L1654】
    - Performance: Constant.【F:src/gameplay.js†L1648-L1654】
    - Units / spaces: Works in cliff geometric units (`dx`/`dy`) relative to world scale.【F:src/gameplay.js†L1650-L1654】
    - Determinism: Deterministic.【F:src/gameplay.js†L1648-L1654】
    - Keep / change / delete: Keep; localized helper simplifies `segmentHasSteepCliff`.
    - Confidence / assumptions: Medium confidence; assumes `dx` is non-zero for meaningful slopes.

  - `cliffInfoExceedsLimit`
    - Purpose: Checks aggregated cliff surface info for any slope component that surpasses the configured limit.【F:src/gameplay.js†L1659-L1664】
    - Inputs: `info` — structure with `slope`, `slopeA`, and `slopeB` fields.【F:src/gameplay.js†L1659-L1664】
    - Outputs: Boolean indicating whether any component is too steep.【F:src/gameplay.js†L1659-L1664】
    - Side effects: None.【F:src/gameplay.js†L1659-L1664】
    - Shared state touched and where it’s used: Used within `segmentHasSteepCliff` as part of the per-sample evaluation.【F:src/gameplay.js†L1681-L1687】
    - Dependencies: Calls `slopeExceedsLimit` on each slope component.【F:src/gameplay.js†L1661-L1664】
    - Edge cases handled or missed: Returns `false` when info is missing; assumes slope fields are numeric.【F:src/gameplay.js†L1659-L1664】
    - Performance: Constant.【F:src/gameplay.js†L1659-L1664】
    - Units / spaces: Uses slope ratios derived from cliff surface sampling.【F:src/gameplay.js†L1659-L1664】
    - Determinism: Deterministic.【F:src/gameplay.js†L1659-L1664】
    - Keep / change / delete: Keep; keeps multi-slope checks concise inside segment scanning.
    - Confidence / assumptions: High confidence; assumes upstream samplers populate slope fields consistently.
  - `segmentHasSteepCliff`
    - Purpose: Scans a segment’s cliff samples to detect any section whose slope exceeds the configured limit, aborting early once a violation is found.【F:src/gameplay.js†L1667-L1689】
    - Inputs: `segIndex` — segment index to inspect; should correspond to cached cliff parameters for sampling positions `t` and lateral offsets `n`.【F:src/gameplay.js†L1669-L1684】
    - Outputs: Returns `true` if any sampled cliff section fails the limit check; otherwise `false`.【F:src/gameplay.js†L1667-L1689】
    - Side effects: None; only reads configuration and helper outputs.【F:src/gameplay.js†L1667-L1689】
    - Shared state touched and where it’s used: Reads global cliff sampling arrays and delegates to `cliffParamsAt`/`cliffSurfaceInfoAt`; used by `playerLateralLimit` to tighten lateral bounds on hazardous segments.【F:src/gameplay.js†L1668-L1687】【F:src/gameplay.js†L1913-L1915】
    - Dependencies: Calls `cliffParamsAt`, `cliffSectionExceedsLimit`, `cliffSurfaceInfoAt`, and `cliffInfoExceedsLimit`.【F:src/gameplay.js†L1671-L1685】
    - Edge cases it handles or misses: Gracefully skips work when the cliff limit is disabled or data is missing, but assumes the sampling arrays contain finite values.【F:src/gameplay.js†L1668-L1688】
    - Performance: Iterates across the configured angle and lateral sample arrays per invocation; low constant cost per queried segment.【F:src/gameplay.js†L1669-L1687】
    - Units / spaces: Works in segment indices with depth samples `t` (0..1) and normalized lateral offsets beyond ±1 road width.【F:src/gameplay.js†L1669-L1683】
    - Determinism: Deterministic given the same track data and configuration.【F:src/gameplay.js†L1667-L1689】
    - Keep / change / delete: Keep; localized helper avoids duplicating steep-cliff scans (alternate would be inlining into `playerLateralLimit`).
    - Confidence / assumptions: Medium confidence; assumes `cliffParamsAt` returns consistent `dx`/`dy` measurements for both cliff sides.
  - `wrapDistance`
    - Purpose: Adds a delta to a track position and wraps it to the track length so movers seamlessly loop around the circuit.【F:src/gameplay.js†L1692-L1694】
    - Inputs: `v` — starting S position; `dv` — delta to apply; `max` — wrap length (typically total track S). Accepts finite numbers; if `max` is non-positive the downstream helper defines the behavior.【F:src/gameplay.js†L1692-L1694】
    - Outputs: Returns the wrapped S coordinate produced by `wrapByLength`.【F:src/gameplay.js†L1692-L1694】
    - Side effects: None.【F:src/gameplay.js†L1692-L1694】
    - Shared state touched and where it’s used: Touches no shared state; reused when moving sprites and NPC cars to keep them within track bounds.【F:src/gameplay.js†L1311-L1314】【F:src/gameplay.js†L2527-L2534】
    - Dependencies: Thin wrapper over `wrapByLength`.【F:src/gameplay.js†L1693-L1694】
    - Edge cases it handles or misses: Relies on `wrapByLength` for handling invalid lengths; does not validate NaNs itself.【F:src/gameplay.js†L1692-L1694】
    - Performance: Constant-time.【F:src/gameplay.js†L1692-L1694】
    - Units / spaces: Operates in longitudinal track `s` units.【F:src/gameplay.js†L1692-L1694】
    - Determinism: Deterministic for deterministic inputs.【F:src/gameplay.js†L1692-L1694】
    - Keep / change / delete: Keep; single-purpose helper clarifies intent (alternatively call `wrapByLength` directly).
    - Confidence / assumptions: High confidence; assumes callers supply finite numbers.
  - `shortestSignedTrackDistance`
    - Purpose: Computes the minimal signed longitudinal separation between two positions on the looping track.【F:src/gameplay.js†L1696-L1705】
    - Inputs: `a` — reference S position; `b` — comparison S position; expects finite numbers, falling back to raw subtraction when track length is invalid.【F:src/gameplay.js†L1696-L1703】
    - Outputs: Returns a signed distance in S units, normalized to ±half the track length when available.【F:src/gameplay.js†L1696-L1705】
    - Side effects: None.【F:src/gameplay.js†L1696-L1705】
    - Shared state touched and where it’s used: Reads the dynamic track length via `trackLengthRef`; used when registering NPC near-misses to measure forward gaps.【F:src/gameplay.js†L1697-L1704】【F:src/gameplay.js†L1445-L1454】
    - Dependencies: Calls `trackLengthRef` and uses modulo arithmetic.【F:src/gameplay.js†L1697-L1704】
    - Edge cases it handles or misses: Handles missing or non-positive track lengths and non-finite deltas, but assumes `trackLengthRef` reflects the active course.【F:src/gameplay.js†L1697-L1704】
    - Performance: Constant-time.【F:src/gameplay.js†L1696-L1705】
    - Units / spaces: Returns distances in world S units.【F:src/gameplay.js†L1696-L1705】
    - Determinism: Deterministic.【F:src/gameplay.js†L1696-L1705】
    - Keep / change / delete: Keep; encapsulates wrap-aware subtraction (alternative would be duplicating the modulo math inline).
    - Confidence / assumptions: High confidence; assumes `trackLengthRef` stays synchronized with course updates.
  - `nearestSegmentCenter`
    - Purpose: Snaps an arbitrary longitudinal position to the center of its nearest road segment for respawn logic.【F:src/gameplay.js†L1708-L1710】
    - Inputs: `s` — world S coordinate; expects finite numbers tied to segment length.【F:src/gameplay.js†L1708-L1710】
    - Outputs: Returns the S position at the midpoint of the nearest segment.【F:src/gameplay.js†L1708-L1710】
    - Side effects: None.【F:src/gameplay.js†L1708-L1710】
    - Shared state touched and where it’s used: Uses global `segmentLength`; leveraged by `queueRespawn` to drop players back on segment centers.【F:src/gameplay.js†L1708-L1710】【F:src/gameplay.js†L2764-L2767】
    - Dependencies: Math rounding only.【F:src/gameplay.js†L1708-L1710】
    - Edge cases it handles or misses: Assumes `segmentLength` is positive and finite; no extra guards present.【F:src/gameplay.js†L1708-L1710】
    - Performance: Constant-time.【F:src/gameplay.js†L1708-L1710】
    - Units / spaces: Works in track S units measured by `segmentLength`.【F:src/gameplay.js†L1708-L1710】
    - Determinism: Deterministic.【F:src/gameplay.js†L1708-L1710】
    - Keep / change / delete: Keep; concise helper clarifies respawn centering (alternative would be duplicating the rounding math).
    - Confidence / assumptions: High confidence; assumes `segmentLength` is initialized.
  - `cliffSurfaceInfoAt`
    - Purpose: Derives cliff height and slope information beyond the road edge at a sampled segment position, returning a normalized info object for downstream checks.【F:src/gameplay.js†L1724-L1801】
    - Inputs: `segIndex` — segment index being sampled; `nNorm` — normalized lateral coordinate where |n|>1 falls outside the road; `t` — longitudinal interpolation along the segment (defaults to 0).【F:src/gameplay.js†L1724-L1780】
    - Outputs: Returns an info object containing `heightOffset`, `slope`, `slopeA/B`, `coverageA/B`, and `section` flags describing the sampled cliff portions.【F:src/gameplay.js†L1724-L1801】
    - Side effects: None; allocates a new info object.【F:src/gameplay.js†L1724-L1801】
    - Shared state touched and where it’s used: Reads shared track data via `cliffParamsAt`, `segmentAtIndex`, `roadWidthAt`, and `track.roadWidth`; reused by steep-cliff detection and tilt computations.【F:src/gameplay.js†L1728-L1779】【F:src/gameplay.js†L1681-L1684】【F:src/gameplay.js†L1804-L1814】
    - Dependencies: Calls `cliffParamsAt`, `segmentAtIndex`, `roadWidthAt`, `clamp01`, and `createCliffInfo`.【F:src/gameplay.js†L1728-L1798】
    - Edge cases it handles or misses: Returns default info for in-road samples, missing params, or zero-width cliffs; assumes provided `dx`/`dy` pairs describe contiguous sections.【F:src/gameplay.js†L1725-L1799】
    - Performance: Constant-time despite several arithmetic branches.【F:src/gameplay.js†L1724-L1801】
    - Units / spaces: Uses segment S (`t`) and normalized lateral coordinates `n`, translating cliff widths/height deltas into slope ratios.【F:src/gameplay.js†L1734-L1794】
    - Determinism: Deterministic given the same cliff data.【F:src/gameplay.js†L1724-L1801】
    - Keep / change / delete: Keep; consolidates cliff sampling math (alternative would be duplicating calculations in each consumer).
    - Confidence / assumptions: Medium confidence; assumes cliff parameter objects include `left/right` sections with finite `dx`/`dy`.
  - `cliffLateralSlopeAt`
    - Purpose: Convenience accessor that returns the aggregate lateral slope component from `cliffSurfaceInfoAt` for a given sample.【F:src/gameplay.js†L1803-L1806】
    - Inputs: `segIndex` — segment index; `nNorm` — normalized lateral coordinate; `t` — optional longitudinal interpolation.【F:src/gameplay.js†L1803-L1806】
    - Outputs: Returns the `slope` field from the computed cliff info (defaults to 0).【F:src/gameplay.js†L1803-L1806】
    - Side effects: None.【F:src/gameplay.js†L1803-L1806】
    - Shared state touched and where it’s used: Delegates to `cliffSurfaceInfoAt`; consumed by `applyCliffPushForce` when applying lateral push-back near cliffs.【F:src/gameplay.js†L1803-L1806】【F:src/gameplay.js†L1869-L1878】
    - Dependencies: Calls `cliffSurfaceInfoAt`.【F:src/gameplay.js†L1803-L1805】
    - Edge cases it handles or misses: Inherits `cliffSurfaceInfoAt`’s handling; no additional guards.【F:src/gameplay.js†L1803-L1806】
    - Performance: Constant-time.【F:src/gameplay.js†L1803-L1806】
    - Units / spaces: Returns slope ratios derived from cliff geometry.【F:src/gameplay.js†L1803-L1806】
    - Determinism: Deterministic.【F:src/gameplay.js†L1803-L1806】
    - Keep / change / delete: Keep; keeps push-force code succinct (alternative is inlining the info lookup).
    - Confidence / assumptions: High confidence; assumes cliff info helpers stay stable.
  - `getAdditiveTiltDeg`
    - Purpose: Computes an additional player/camera roll angle based on local cliff slope to visually lean away from steep drops.【F:src/gameplay.js†L1808-L1825】
    - Inputs: None; derives data from current state, tilt configuration, and sampled cliff info.【F:src/gameplay.js†L1808-L1824】
    - Outputs: Returns a signed degree offset clamped by `tiltAdd.tiltAddMaxDeg` when configured.【F:src/gameplay.js†L1822-L1825】
    - Side effects: None; pure calculation.【F:src/gameplay.js†L1808-L1825】
    - Shared state touched and where it’s used: Reads `state.phys`, `state.playerN`, and cliff data; exposed via `state.getAdditiveTiltDeg` and consumed during render-time tilt smoothing.【F:src/gameplay.js†L1809-L1824】【F:src/gameplay.js†L1828-L1828】【F:src/render.js†L1032-L1049】
    - Dependencies: Calls `segmentAtS`, `clamp01`, `cliffSurfaceInfoAt`, `Math.atan`, and uses tilt config values.【F:src/gameplay.js†L1810-L1825】
    - Edge cases it handles or misses: Returns 0 when tilt add is disabled, no segment exists, or info is missing; assumes cliff slopes are finite.【F:src/gameplay.js†L1809-L1825】
    - Performance: Constant-time per call.【F:src/gameplay.js†L1808-L1825】
    - Units / spaces: Outputs degrees derived from slope ratios; depends on normalized player lateral position.【F:src/gameplay.js†L1813-L1825】
    - Determinism: Deterministic given the same game state.【F:src/gameplay.js†L1808-L1825】
    - Keep / change / delete: Keep; isolates camera-tilt math (alternative would be embedding logic in render loop).
    - Confidence / assumptions: Medium confidence; assumes tilt configuration flags remain synchronized with render expectations.
  - `updateCameraFromFieldOfView`
    - Purpose: Recomputes camera projection parameters (depth, near plane, playerZ) when the field of view changes.【F:src/gameplay.js†L1830-L1836】
    - Inputs: None; operates on `state.camera.fieldOfView`.【F:src/gameplay.js†L1830-L1836】
    - Outputs: No return value; updates `state.camera.cameraDepth`, `nearZ`, and `playerZ`.【F:src/gameplay.js†L1831-L1836】
    - Side effects: Mutates camera state fields derived from FOV.【F:src/gameplay.js†L1831-L1836】
    - Shared state touched and where it’s used: Writes to `state.camera`; invoked by `setFieldOfView` and during initialization to keep projection data current.【F:src/gameplay.js†L1831-L1836】【F:src/gameplay.js†L1838-L1844】
    - Dependencies: Uses `Math.tan` and camera constants.【F:src/gameplay.js†L1830-L1835】
    - Edge cases it handles or misses: Assumes a finite positive FOV; lacks guards for extreme values that would blow up `Math.tan`.【F:src/gameplay.js†L1830-L1836】
    - Performance: Constant-time.【F:src/gameplay.js†L1830-L1836】
    - Units / spaces: Converts degrees to radians and updates world depth offsets (`playerZ`).【F:src/gameplay.js†L1831-L1836】
    - Determinism: Deterministic.【F:src/gameplay.js†L1830-L1836】
    - Keep / change / delete: Keep; centralizes camera projection math (alternative is duplicating the trig in callers).
    - Confidence / assumptions: High confidence; assumes camera state exists before invocation.
  - `setFieldOfView`
    - Purpose: Setter that applies a new camera FOV and immediately refreshes dependent projection values.【F:src/gameplay.js†L1838-L1844】
    - Inputs: `fov` — field of view in degrees; expected to be finite.【F:src/gameplay.js†L1838-L1840】
    - Outputs: None.【F:src/gameplay.js†L1838-L1841】
    - Side effects: Updates `state.camera.fieldOfView` and calls `updateCameraFromFieldOfView`.【F:src/gameplay.js†L1838-L1844】
    - Shared state touched and where it’s used: Mutates camera state; exposed via `state.camera.updateFromFov` so other systems (e.g., reset) can reuse it.【F:src/gameplay.js†L1838-L1844】【F:src/gameplay.js†L2689-L2694】
    - Dependencies: Relies on `updateCameraFromFieldOfView`.【F:src/gameplay.js†L1839-L1844】
    - Edge cases it handles or misses: Does not clamp FOV values; assumes caller sanitizes input.【F:src/gameplay.js†L1838-L1844】
    - Performance: Constant-time.【F:src/gameplay.js†L1838-L1844】
    - Units / spaces: Input/field stored in degrees.【F:src/gameplay.js†L1838-L1839】
    - Determinism: Deterministic.【F:src/gameplay.js†L1838-L1844】
    - Keep / change / delete: Keep; simple setter keeps camera updates uniform (alternative is writing to the state and calling the helper manually).
    - Confidence / assumptions: High confidence; assumes camera object has been initialized.
  - `cliffSteepnessMultiplier`
    - Purpose: Converts a slope ratio into a multiplier that grows as the slope approaches or exceeds the configured cliff limit, intensifying push-back forces.【F:src/gameplay.js†L1846-L1860】
    - Inputs: `slope` — lateral slope ratio; expected finite number.【F:src/gameplay.js†L1846-L1853】
    - Outputs: Returns a multiplier ≥1 that scales with steepness.【F:src/gameplay.js†L1846-L1860】
    - Side effects: None.【F:src/gameplay.js†L1846-L1860】
    - Shared state touched and where it’s used: Reads `CLIFF_LIMIT_DEG` and slope helpers; consumed by `applyCliffPushForce` to weight the lateral correction.【F:src/gameplay.js†L1846-L1855】【F:src/gameplay.js†L1876-L1877】
    - Dependencies: Calls `slopeAngleDeg` and `slopeLimitRatio`.【F:src/gameplay.js†L1849-L1855】
    - Edge cases it handles or misses: Returns 1 when limits are disabled, slopes are near flat, or ratios are non-positive; assumes finite slopes.【F:src/gameplay.js†L1847-L1859】
    - Performance: Constant-time.【F:src/gameplay.js†L1846-L1860】
    - Units / spaces: Operates on dimensionless slope ratios and degree limits.【F:src/gameplay.js†L1846-L1855】
    - Determinism: Deterministic.【F:src/gameplay.js†L1846-L1860】
    - Keep / change / delete: Keep; encapsulates easing curve for steepness (alternative would be hard-coding math in `applyCliffPushForce`).
    - Confidence / assumptions: Medium confidence; assumes limit configuration matches slope sampling units.
  - `applyCliffPushForce`
    - Purpose: Nudges the player back toward the road when drifting beyond the guard rails, scaling the correction with distance and cliff steepness.【F:src/gameplay.js†L1863-L1879】
    - Inputs: `step` — base steering delta (used to scale the applied push); expects finite number.【F:src/gameplay.js†L1863-L1878】
    - Outputs: None (adjusts `state.playerN` in place).【F:src/gameplay.js†L1877-L1879】
    - Side effects: Reads the current segment and modifies `state.playerN`.【F:src/gameplay.js†L1865-L1879】
    - Shared state touched and where it’s used: Accesses `state.playerN`, `state.phys`, and cliff configuration; invoked from `updatePhysics` each frame while integrating steering.【F:src/gameplay.js†L1863-L1879】【F:src/gameplay.js†L2169-L2170】
    - Dependencies: Calls `segmentAtS`, `clamp01`, `cliffLateralSlopeAt`, and `cliffSteepnessMultiplier`.【F:src/gameplay.js†L1866-L1877】
    - Edge cases it handles or misses: No effect when the player is within road bounds, when slopes are flat, or when the direction cannot be determined; assumes cliff samples exist for off-road positions.【F:src/gameplay.js†L1864-L1878】
    - Performance: Constant-time per invocation.【F:src/gameplay.js†L1863-L1879】
    - Units / spaces: Operates on normalized lateral coordinate `state.playerN` and uses slopes derived from cliff geometry.【F:src/gameplay.js†L1873-L1879】
    - Determinism: Deterministic given the same state and sampling functions.【F:src/gameplay.js†L1863-L1879】
    - Keep / change / delete: Keep; encapsulates cliff push logic (alternative is embedding calculations inside `updatePhysics`).
    - Confidence / assumptions: Medium confidence; assumes cliff sampling returns meaningful slopes for |n|>1.
  - `doHop`
    - Purpose: Applies the player’s hop impulse, transitioning from grounded to airborne motion and seeding drift/boost interactions.【F:src/gameplay.js†L1884-L1902】
    - Inputs: None; relies on `state.phys`, jump zone info, and player tuning.【F:src/gameplay.js†L1884-L1901】
    - Outputs: Returns `true` when a hop is initiated, otherwise `false`.【F:src/gameplay.js†L1884-L1902】
    - Side effects: Mutates player physics (velocities, grounded flag, next hop timer) and triggers jump-zone boosts.【F:src/gameplay.js†L1884-L1901】
    - Shared state touched and where it’s used: Writes to `state.phys` and leverages jump zone helpers; called from `updatePhysics` when hop input is detected.【F:src/gameplay.js†L1884-L1901】【F:src/gameplay.js†L2137-L2139】
    - Dependencies: Uses `jumpZoneForPlayer`, `groundProfileAt`, `tangentNormalFromSlope`, `playerFloorHeightAt`, and `applyJumpZoneBoost`.【F:src/gameplay.js†L1887-L1901】
    - Edge cases it handles or misses: Guarded by grounded state and hop cooldown; assumes terrain normals and impulses are finite.【F:src/gameplay.js†L1884-L1901】
    - Performance: Constant-time.【F:src/gameplay.js†L1884-L1902】
    - Units / spaces: Works in world velocities and positions relative to track S/Y coordinates.【F:src/gameplay.js†L1887-L1900】
    - Determinism: Deterministic given the same state and random-free dependencies.【F:src/gameplay.js†L1884-L1902】
    - Keep / change / delete: Keep; isolates hop physics (alternative is embedding hop logic directly into `updatePhysics`).
    - Confidence / assumptions: Medium confidence; assumes `player.hopImpulse` and normals are tuned for stable trajectories.
  - `playerLateralLimit`
    - Purpose: Computes the maximum lateral travel the player can have within a segment, considering car width, guard rails, and cliff safety limits.【F:src/gameplay.js†L1904-L1917】
    - Inputs: `segIndex` — segment index being evaluated.【F:src/gameplay.js†L1904-L1911】
    - Outputs: Returns a symmetric normalized bound (≥0).【F:src/gameplay.js†L1904-L1917】
    - Side effects: None.【F:src/gameplay.js†L1904-L1917】
    - Shared state touched and where it’s used: Reads player dimensions, lane bounds, guard-rail features, and steep-cliff status; used when clamping player motion and when respawning.【F:src/gameplay.js†L1904-L1916】【F:src/gameplay.js†L2346-L2354】【F:src/gameplay.js†L2684-L2686】
    - Dependencies: Calls `playerHalfWN`, `segmentAtIndex`, and `segmentHasSteepCliff`.【F:src/gameplay.js†L1904-L1915】
    - Edge cases it handles or misses: Falls back to lane width when no guard rail/cliff limit exists; assumes features metadata is present when rails apply.【F:src/gameplay.js†L1906-L1916】
    - Performance: Constant-time.【F:src/gameplay.js†L1904-L1917】
    - Units / spaces: Returns normalized lateral coordinate bounds relative to road width.【F:src/gameplay.js†L1904-L1917】
    - Determinism: Deterministic.【F:src/gameplay.js†L1904-L1917】
    - Keep / change / delete: Keep; centralizes lateral clamp logic (alternative is duplicating guard-rail math in callers).
    - Confidence / assumptions: Medium confidence; assumes guard-rail flags accurately match segment geometry.
  - `resolveSpriteInteractionsInSeg`
    - Purpose: Processes sprite-player interactions within a segment, triggering toggles, animations, impacts, and cleanup for collected props.【F:src/gameplay.js†L1920-L1959】
    - Inputs: `seg` — segment object whose `sprites` array is inspected.【F:src/gameplay.js†L1920-L1924】
    - Outputs: None; mutates sprites/segment arrays in place.【F:src/gameplay.js†L1920-L1959】
    - Side effects: Marks sprites as interacted, updates metrics, removes toggled sprites, and may recycle transient sprites.【F:src/gameplay.js†L1924-L1959】
    - Shared state touched and where it’s used: Reads player lateral position and metrics; invoked by `resolveSegmentCollisions` during collision passes.【F:src/gameplay.js†L1922-L1958】【F:src/gameplay.js†L2027-L2029】
    - Dependencies: Uses `playerHalfWN`, `getSpriteMeta`, `switchSpriteAnimationClip`, `applyImpactPushToSprite`, and `recycleTransientSprite`.【F:src/gameplay.js†L1922-L1956】
    - Edge cases it handles or misses: Skips empty segments, ignores zero-width sprites, and checks interaction flags before double-triggering; assumes sprite metadata supplies widths.【F:src/gameplay.js†L1920-L1957】
    - Performance: Iterates sprites in a segment; cost proportional to sprite count, typically limited to on-screen segments.【F:src/gameplay.js†L1922-L1959】
    - Units / spaces: Compares normalized lateral offsets (`state.playerN`) against sprite widths in normalized units.【F:src/gameplay.js†L1922-L1934】
    - Determinism: Deterministic, aside from reliance on deterministic sprite state transitions.【F:src/gameplay.js†L1920-L1959】
    - Keep / change / delete: Keep; isolates sprite-interaction logic (alternative is folding into the broader collision loop).
    - Confidence / assumptions: Medium confidence; assumes sprite metadata is accurate and `seg.sprites` holds mutable arrays.
  - `resolveCarCollisionsInSeg`
    - Purpose: Handles collisions between the player and NPC cars within a segment, applying velocity transfers, landing logic, and metrics updates.【F:src/gameplay.js†L1962-L2021】
    - Inputs: `seg` — segment whose `cars` array is tested.【F:src/gameplay.js†L1962-L1969】
    - Outputs: Returns `true` if a collision occurred, otherwise `false`.【F:src/gameplay.js†L1962-L2021】
    - Side effects: Mutates player physics, applies collision push to cars, stamps cooldown timers, and increments metrics counters.【F:src/gameplay.js†L1978-L2019】
    - Shared state touched and where it’s used: Reads and writes `state.phys`, `state.metrics`, and car metadata; orchestrated by `resolveSegmentCollisions`.【F:src/gameplay.js†L1962-L2019】【F:src/gameplay.js†L2025-L2029】
    - Dependencies: Uses `playerHalfWN`, `carHalfWN`, `ensureCarNearMissReset`, `tryRegisterCarNearMiss`, `groundProfileAt`, `tangentNormalFromSlope`, `playerFloorHeightAt`, and `applyNpcCollisionPush`.【F:src/gameplay.js†L1965-L2014】
    - Edge cases it handles or misses: Skips empty car arrays, respects airborne immunity unless hop height is low, enforces per-car cooldown, and forces landings when configured; assumes car data includes speeds and offsets.【F:src/gameplay.js†L1964-L2016】
    - Performance: Iterates cars within the segment; cost scales with local NPC density.【F:src/gameplay.js†L1964-L2017】
    - Units / spaces: Operates in normalized lateral offsets and world velocities/positions.【F:src/gameplay.js†L1966-L2012】
    - Determinism: Deterministic, barring any randomness in upstream car behavior.【F:src/gameplay.js†L1962-L2021】
    - Keep / change / delete: Keep; encapsulates complex collision handling (alternative is embedding logic in the integration loop).
    - Confidence / assumptions: Medium confidence; assumes car hitboxes and cooldown constants are tuned consistently.
  - `resolveSegmentCollisions`
    - Purpose: Processes both car and sprite collision handling for a single segment and reports whether a car impact occurred.【F:src/gameplay.js†L2025-L2029】
    - Inputs: `seg` — segment instance to resolve.【F:src/gameplay.js†L2025-L2028】
    - Outputs: Returns `true` when a car collision was registered; otherwise `false`.【F:src/gameplay.js†L2025-L2029】
    - Side effects: Delegates side effects to the underlying car/sprite helpers.【F:src/gameplay.js†L2025-L2029】
    - Shared state touched and where it’s used: Relies on `state` mutations performed inside delegated calls; invoked directly during the physics sweep to handle current and crossed segments.【F:src/gameplay.js†L2025-L2029】【F:src/gameplay.js†L2398-L2407】
    - Dependencies: Calls `resolveCarCollisionsInSeg` and `resolveSpriteInteractionsInSeg`.【F:src/gameplay.js†L2025-L2029】
    - Edge cases it handles or misses: Immediately returns `false` when the segment is falsy; assumes segment arrays exist when provided.【F:src/gameplay.js†L2025-L2028】
    - Performance: Constant overhead beyond delegated per-object loops.【F:src/gameplay.js†L2025-L2029】
    - Units / spaces: Inherits units from delegated helpers (normalized lateral, world velocities).【F:src/gameplay.js†L2025-L2029】
    - Determinism: Deterministic given deterministic delegates.【F:src/gameplay.js†L2025-L2029】
    - Keep / change / delete: Keep; provides a single entry point for collision resolution (alternative is calling the two helpers separately each time).
    - Confidence / assumptions: High confidence; assumes delegates remain side-effectful as intended.
  - `resolveCollisions`
    - Purpose: Convenience wrapper that resolves collisions in the player’s current segment.【F:src/gameplay.js†L2032-L2036】
    - Inputs: None; derives the segment from `state.phys.s`.【F:src/gameplay.js†L2032-L2035】
    - Outputs: Returns the result of `resolveSegmentCollisions`, or `false` if no segment exists.【F:src/gameplay.js†L2032-L2036】
    - Side effects: None beyond delegated collision work.【F:src/gameplay.js†L2032-L2036】
    - Shared state touched and where it’s used: Reads `state.phys.s` to fetch the segment; currently unused elsewhere, but available for debugging or scripting.【F:src/gameplay.js†L2033-L2036】
    - Dependencies: Calls `segmentAtS` and `resolveSegmentCollisions`.【F:src/gameplay.js†L2033-L2036】
    - Edge cases it handles or misses: Returns `false` when the segment lookup fails; assumes `state.phys.s` is finite.【F:src/gameplay.js†L2033-L2036】
    - Performance: Constant beyond delegated work.【F:src/gameplay.js†L2032-L2036】
    - Units / spaces: Uses track S positions for lookup.【F:src/gameplay.js†L2033-L2036】
    - Determinism: Deterministic.【F:src/gameplay.js†L2032-L2036】
    - Keep / change / delete: Keep; handy shim for potential external callers (alternative is invoking `resolveSegmentCollisions(segmentAtS(...))` manually).
    - Confidence / assumptions: Medium confidence; assumes future tooling may call it despite no in-repo uses.
  - `updateSpriteAnimations`
    - Purpose: Advances sprite animations, lifetimes, and motion effects across all segments, recycling expired instances and transferring moving effects between segments.【F:src/gameplay.js†L2038-L2108】
    - Inputs: `dt` — time step in seconds; expects non-negative finite value.【F:src/gameplay.js†L2038-L2107】
    - Outputs: None; mutates sprite state and segment arrays.【F:src/gameplay.js†L2038-L2107】
    - Side effects: Decrements TTLs, updates animation frames, moves impactable effects, and may relocate sprites between segment arrays.【F:src/gameplay.js†L2051-L2104】
    - Shared state touched and where it’s used: Iterates the global `segments` collection and sprite metadata; executed each physics tick to keep effects alive.【F:src/gameplay.js†L2039-L2106】【F:src/gameplay.js†L2409-L2410】
    - Dependencies: Calls helpers such as `recycleTransientSprite`, `applyDriftSmokeMotion`, `applySparksMotion`, `advanceSpriteAnimation`, `updateImpactableSprite`, and `ensureArray`.【F:src/gameplay.js†L2041-L2103】
    - Edge cases it handles or misses: Skips segments without sprites, guards against invalid animation data, and ensures frame indices stay within bounds; assumes sprite arrays are mutable.【F:src/gameplay.js†L2041-L2093】
    - Performance: Loops over all segments and their sprites each frame; cost proportional to active sprite count.【F:src/gameplay.js†L2039-L2106】
    - Units / spaces: Works with normalized offsets (`spr.offset`), TTL seconds, and animation frame indices.【F:src/gameplay.js†L2051-L2103】
    - Determinism: Deterministic provided helper motion/animation code is deterministic.【F:src/gameplay.js†L2038-L2107】
    - Keep / change / delete: Keep; central tick for sprite effects (alternative is distributing animation updates across multiple sites).
    - Confidence / assumptions: Medium confidence; assumes sprite helpers behave consistently and segments remain enumerable.
  - `collectSegmentsCrossed`
    - Purpose: Identifies which segments the player traversed during an integration step so collision checks can process them in order.【F:src/gameplay.js†L2111-L2124】
    - Inputs: `startS` — starting S position; `endS` — ending S position; expects finite numbers and positive `segmentLength`.【F:src/gameplay.js†L2111-L2118】
    - Outputs: Returns an array of segment objects encountered between the endpoints (excluding the starting segment).【F:src/gameplay.js†L2111-L2124】
    - Side effects: None.【F:src/gameplay.js†L2111-L2124】
    - Shared state touched and where it’s used: Uses `segmentLength`, `wrapSegmentIndex`, and `segmentAtIndex`; consumed by `updatePhysics` to replay collisions for crossed segments.【F:src/gameplay.js†L2112-L2123】【F:src/gameplay.js†L2254-L2261】
    - Dependencies: Calls `hasSegments`, `wrapSegmentIndex`, and `segmentAtIndex`.【F:src/gameplay.js†L2111-L2123】
    - Edge cases it handles or misses: Early-outs when there are no segments, length is invalid, or no segment crossing occurred.【F:src/gameplay.js†L2111-L2124】
    - Performance: Iterates once per crossed segment; cost proportional to the number of segments traversed in the step.【F:src/gameplay.js†L2119-L2123】
    - Units / spaces: Operates in track S units normalized by `segmentLength`.【F:src/gameplay.js†L2112-L2120】
    - Determinism: Deterministic.【F:src/gameplay.js†L2111-L2124】
    - Keep / change / delete: Keep; isolates wrap-aware traversal logic (alternative is duplicating the loop in `updatePhysics`).
    - Confidence / assumptions: High confidence; assumes segment indices wrap correctly via `wrapSegmentIndex`.
  - `updatePhysics`
    - Purpose: Advances the player’s physics simulation for one timestep, incorporating input, drift, boosts, collisions, effects, and race bookkeeping.【F:src/gameplay.js†L2127-L2431】
    - Inputs: `dt` — simulation timestep in seconds; expected non-negative finite value.【F:src/gameplay.js†L2127-L2135】
    - Outputs: None; mutates global game state.【F:src/gameplay.js†L2127-L2431】
    - Side effects: Updates player physics (`state.phys`), input flags, drift state, boost timers, metrics, zone effects, collision outcomes, sprite animations, and may queue respawns.【F:src/gameplay.js†L2137-L2430】
    - Shared state touched and where it’s used: Operates on `state.phys`, `state.input`, `state.metrics`, segment data, and effects timers; called each frame by `step`.【F:src/gameplay.js†L2127-L2430】【F:src/gameplay.js†L2785-L2787】
    - Dependencies: Invokes numerous helpers including `doHop`, `segmentAtS`, `boostZonesForPlayer`, `groundProfileAt`, `tangentNormalFromSlope`, `applyCliffPushForce`, `collectSegmentsCrossed`, `resolveSegmentCollisions`, `updateSpriteAnimations`, and `queueRespawn`.【F:src/gameplay.js†L2137-L2416】
    - Edge cases it handles or misses: Guards against missing segments, caps boost timers, handles landing transitions, enforces guard-rail scraping penalties, tracks lap completion, and prevents respawn queues while reset matte is active; assumes helper functions succeed and that `trackLengthRef` is valid when laps matter.【F:src/gameplay.js†L2129-L2416】
    - Performance: Executes once per frame; loops over crossed segments and active effects, making it one of the heaviest runtime functions.【F:src/gameplay.js†L2194-L2407】
    - Units / spaces: Works in world S/Y coordinates, normalized lateral positions, and seconds for timers.【F:src/gameplay.js†L2149-L2407】
    - Determinism: Deterministic given deterministic inputs and helper behavior (no randomness inside the routine).【F:src/gameplay.js†L2127-L2431】
    - Keep / change / delete: Keep; central integration loop is necessary (alternative would be decomposing into smaller orchestrated steps).
    - Confidence / assumptions: Medium confidence; assumes all referenced helpers and state fields are initialized before stepping.
  - `clearSegmentCars`
    - Purpose: Empties the per-segment car lists in preparation for respawning NPCs.【F:src/gameplay.js†L2433-L2437】
    - Inputs: None.【F:src/gameplay.js†L2433-L2437】
    - Outputs: None; mutates segment arrays.【F:src/gameplay.js†L2433-L2437】
    - Side effects: Truncates each segment’s `cars` array to zero length.【F:src/gameplay.js†L2433-L2437】
    - Shared state touched and where it’s used: Iterates the global `segments` collection; invoked by `spawnCars` before repopulating NPCs.【F:src/gameplay.js†L2433-L2437】【F:src/gameplay.js†L2445-L2446】
    - Dependencies: Calls `hasSegments`.【F:src/gameplay.js†L2433-L2436】
    - Edge cases it handles or misses: Skips work if segments are unavailable; assumes each segment’s `cars` property is an array when present.【F:src/gameplay.js†L2433-L2437】
    - Performance: O(number of segments).【F:src/gameplay.js†L2433-L2437】
    - Units / spaces: Works on collection indices; no physical units.【F:src/gameplay.js†L2433-L2437】
    - Determinism: Deterministic.【F:src/gameplay.js†L2433-L2437】
    - Keep / change / delete: Keep; dedicated reset helper keeps spawning routine clean (alternative is inlining the loop into `spawnCars`).
    - Confidence / assumptions: High confidence; assumes segments own mutable `cars` arrays.
  - `spawnCars`
    - Purpose: Populates the world with NPC cars at random segments, seeding their offsets, types, and speeds.【F:src/gameplay.js†L2440-L2463】
    - Inputs: None.【F:src/gameplay.js†L2440-L2463】
    - Outputs: None; fills `state.cars` and segment `cars` arrays.【F:src/gameplay.js†L2440-L2463】
    - Side effects: Clears previous cars, allocates new car objects, and mutates segment collections; relies on `Math.random`.【F:src/gameplay.js†L2441-L2463】
    - Shared state touched and where it’s used: Updates `state.cars` and segment `cars`; invoked during scene reset to refresh traffic.【F:src/gameplay.js†L2442-L2463】【F:src/gameplay.js†L2740-L2743】
    - Dependencies: Calls `hasSegments`, `clearSegmentCars`, `segmentAtS`, `npcLateralLimit`, `getSpriteMeta`, and `ensureArray`.【F:src/gameplay.js†L2440-L2462】
    - Edge cases it handles or misses: Bail outs when segments are absent; otherwise assumes NPC metadata exists and road bounds are valid.【F:src/gameplay.js†L2441-L2462】
    - Performance: O(number of NPCs); linear in configured `NPC.total`.【F:src/gameplay.js†L2447-L2463】
    - Units / spaces: Chooses longitudinal positions in segment units and normalized lateral offsets within computed bounds.【F:src/gameplay.js†L2449-L2458】
    - Determinism: Non-deterministic because of `Math.random`.【F:src/gameplay.js†L2449-L2460】
    - Keep / change / delete: Keep; encapsulates spawn logic (alternative is to expose a deterministic seeding method if needed).
    - Confidence / assumptions: Medium confidence; assumes NPC constants (`NPC.total`, `CAR_TYPES`) are configured.
  - `steerAvoidance`
    - Purpose: Computes a lateral offset adjustment for an NPC to avoid the player or other cars ahead within a configurable lookahead window.【F:src/gameplay.js†L2466-L2499】
    - Inputs: `car` — NPC descriptor; `carSeg` — current segment; `playerSeg` — player’s segment; `playerW` — player half-width in normalized units.【F:src/gameplay.js†L2466-L2470】
    - Outputs: Returns a signed lateral delta to add to the car’s offset (can be 0).【F:src/gameplay.js†L2466-L2499】
    - Side effects: None directly; only computes a value.【F:src/gameplay.js†L2466-L2499】
    - Shared state touched and where it’s used: Reads `state.phys` and `state.playerN` to gauge proximity; called by `tickCars` before advancing NPCs.【F:src/gameplay.js†L2471-L2499】【F:src/gameplay.js†L2509-L2513】
    - Dependencies: Uses `segments`, `segmentAtIndex`, `overlap`, `npcLateralLimit`, and car width helpers.【F:src/gameplay.js†L2471-L2498】
    - Edge cases it handles or misses: Skips computation when segments are missing, caps responses when cars leave their lateral bounds, and scales avoidance inversely with lookahead distance; assumes lookahead segments exist.【F:src/gameplay.js†L2467-L2499】
    - Performance: Loops through a limited lookahead and peer cars; cost proportional to lookahead × local car density.【F:src/gameplay.js†L2471-L2498】
    - Units / spaces: Operates in normalized lateral offsets and compares speeds in world units.【F:src/gameplay.js†L2477-L2493】
    - Determinism: Deterministic given deterministic state inputs.【F:src/gameplay.js†L2466-L2499】
    - Keep / change / delete: Keep; isolates avoidance heuristics (alternative is embedding logic directly in `tickCars`).
    - Confidence / assumptions: Medium confidence; assumes lookahead configuration and overlap thresholds are tuned.
  - `tickCars`
    - Purpose: Updates all NPC cars for the frame, applying avoidance steering, collision pushes, and longitudinal movement while syncing segment membership.【F:src/gameplay.js†L2502-L2538】
    - Inputs: `dt` — timestep in seconds.【F:src/gameplay.js†L2502-L2522】
    - Outputs: None; mutates car objects and segment arrays.【F:src/gameplay.js†L2502-L2537】
    - Side effects: Adjusts car offsets, advances positions with wrapping, applies collision push decay, and migrates cars between segment lists.【F:src/gameplay.js†L2510-L2536】
    - Shared state touched and where it’s used: Operates on `state.cars`, `segments`, and car-specific collision push state; executed each frame by `step`.【F:src/gameplay.js†L2502-L2537】【F:src/gameplay.js†L2785-L2787】
    - Dependencies: Calls `hasSegments`, `segmentAtS`, `steerAvoidance`, `playerHalfWN`, `wrapDistance`, `npcLateralLimit`, and `ensureArray`.【F:src/gameplay.js†L2503-L2536】
    - Edge cases it handles or misses: Skips processing when there are no segments or cars, clears stale collision pushes, clamps offsets within NPC limits, and updates segment ownership safely; assumes collision push structures are well-formed.【F:src/gameplay.js†L2503-L2536】
    - Performance: Linear in the number of active cars per frame.【F:src/gameplay.js†L2504-L2537】
    - Units / spaces: Uses world S for positions and normalized lateral offsets for lane clamping.【F:src/gameplay.js†L2511-L2536】
    - Determinism: Deterministic aside from any randomness embedded in prior spawn data.【F:src/gameplay.js†L2502-L2538】
    - Keep / change / delete: Keep; central NPC update loop (alternative is splitting into multiple passes).
    - Confidence / assumptions: Medium confidence; assumes car metadata (speed, offset) remains valid across frames.
  - `spawnProps`
    - Purpose: Loads sprite placement data and instantiates all static/ambient props across the track, rebuilding sprite metadata overrides.【F:src/gameplay.js†L2541-L2571】
    - Inputs: None (async).【F:src/gameplay.js†L2541-L2571】
    - Outputs: Returns a promise that resolves once props are spawned; updates `state.spriteMeta`.【F:src/gameplay.js†L2541-L2571】
    - Side effects: Clears existing segment sprite arrays, logs warnings on load failure, updates sprite metadata, and creates sprite instances via factories.【F:src/gameplay.js†L2542-L2570】
    - Shared state touched and where it’s used: Mutates `segments`, `state.spriteMeta`, and relies on asset loading; called during scene resets and exposed publicly.【F:src/gameplay.js†L2541-L2571】【F:src/gameplay.js†L2740-L2743】【F:src/gameplay.js†L2796-L2799】
    - Dependencies: Calls `hasSegments`, `ensureSpriteDataLoaded`, `buildSpriteMetaOverrides`, `generateSpriteInstances`, and `createSpriteFromInstance`.【F:src/gameplay.js†L2541-L2569】
    - Edge cases it handles or misses: Falls back to default metadata when loading fails or data is incomplete; assumes placement data is well-formed when present.【F:src/gameplay.js†L2542-L2569】
    - Performance: Iterates through all segments and generated instances; cost proportional to track size and placement count.【F:src/gameplay.js†L2542-L2570】
    - Units / spaces: Utilizes segment indices and sprite metadata defined in asset data.【F:src/gameplay.js†L2546-L2568】
    - Determinism: Deterministic given deterministic asset data (no randomization).【F:src/gameplay.js†L2541-L2571】
    - Keep / change / delete: Keep; centralizes prop loading (alternative is to inline asset handling in reset logic).
    - Confidence / assumptions: Medium confidence; assumes asset pipeline supplies consistent catalog and placement structures.
  - `resetPlayerState`
    - Purpose: Reinitializes the player’s physics, camera smoothing, drift state, and related timers to a known baseline, optionally overriding position and timers.【F:src/gameplay.js†L2631-L2676】
    - Inputs: Options object with optional `s`, `playerN`, `cameraHeight`, and `timers` overrides; defaults to current state values.【F:src/gameplay.js†L2631-L2651】
    - Outputs: None.【F:src/gameplay.js†L2631-L2676】
    - Side effects: Mutates `state.phys`, `state.playerN`, camera smoothing values, drift/boost timers, pending respawns, and metrics guards.【F:src/gameplay.js†L2637-L2675】
    - Shared state touched and where it’s used: Resets numerous `state` fields; invoked by respawn logic and scene resets.【F:src/gameplay.js†L2631-L2676】【F:src/gameplay.js†L2684-L2687】【F:src/gameplay.js†L2742-L2747】
    - Dependencies: Calls `playerFloorHeightAt`, `computeDriftSmokeInterval`, and `computeSparksInterval`.【F:src/gameplay.js†L2641-L2666】
    - Edge cases it handles or misses: Defaults to current player lateral position when not provided, resets timers when supplied, and clears metrics flags; assumes physics state object exists.【F:src/gameplay.js†L2637-L2676】
    - Performance: Constant-time.【F:src/gameplay.js†L2631-L2676】
    - Units / spaces: Works in world S/Y coordinates and normalized lateral offsets.【F:src/gameplay.js†L2637-L2644】
    - Determinism: Deterministic for given inputs.【F:src/gameplay.js†L2631-L2676】
    - Keep / change / delete: Keep; shared reset utility reduces duplication (alternative is scattering manual resets across call sites).
    - Confidence / assumptions: High confidence; assumes dependent helper intervals return valid numbers.
  - `respawnPlayerAt`
    - Purpose: Respawns the player at a specific longitudinal position and lateral offset, clamping within allowed bounds before delegating to `resetPlayerState`.【F:src/gameplay.js†L2679-L2687】
    - Inputs: `sTarget` — desired S position; `nNorm` — desired normalized lateral position (default 0).【F:src/gameplay.js†L2679-L2687】
    - Outputs: None.【F:src/gameplay.js†L2679-L2687】
    - Side effects: Wraps the S coordinate, clamps the lateral offset, and invokes `resetPlayerState`.【F:src/gameplay.js†L2679-L2687】
    - Shared state touched and where it’s used: Reads track length and player limits; used by the reset matte to complete respawns and exported on the Gameplay API.【F:src/gameplay.js†L2679-L2687】【F:src/render.js†L2032-L2055】
    - Dependencies: Calls `trackLengthRef`, `segmentAtS`, `playerLateralLimit`, `clamp`, and `resetPlayerState`.【F:src/gameplay.js†L2680-L2687】
    - Edge cases it handles or misses: Supports tracks with zero length (no wrap), ensures lateral offset respects local limits; assumes segment lookup succeeds or defaults to index 0.【F:src/gameplay.js†L2680-L2687】
    - Performance: Constant-time.【F:src/gameplay.js†L2679-L2687】
    - Units / spaces: Operates on track S units and normalized lateral offsets.【F:src/gameplay.js†L2680-L2686】
    - Determinism: Deterministic.【F:src/gameplay.js†L2679-L2687】
    - Keep / change / delete: Keep; thin wrapper ensures respawns respect limits (alternative is repeating wrap/limit math at call sites).
    - Confidence / assumptions: High confidence; assumes `playerLateralLimit` returns sensible bounds even if the segment lookup falls back to index 0.
  - `applyDefaultFieldOfView`
    - Purpose: Syncs the active camera state with the default gameplay FOV, either via the registered updater or by directly assigning the stored value.【F:src/gameplay.js†L2689-L2696】
    - Inputs: None.【F:src/gameplay.js†L2689-L2696】
    - Outputs: None.【F:src/gameplay.js†L2689-L2696】
    - Side effects: Invokes `state.camera.updateFromFov` if available or sets `cameraState.fieldOfView` directly.【F:src/gameplay.js†L2689-L2695】
    - Shared state touched and where it’s used: Reads from `state.camera` and `camera` defaults; called at scene reset to initialize the camera.【F:src/gameplay.js†L2689-L2696】【F:src/gameplay.js†L2699-L2706】
    - Dependencies: Uses camera state and the callback installed by `setFieldOfView`.【F:src/gameplay.js†L2689-L2695】
    - Edge cases it handles or misses: Falls back to direct assignment when no updater is registered; assumes `cameraState` exists when `state` is initialized.【F:src/gameplay.js†L2689-L2696】
    - Performance: Constant-time.【F:src/gameplay.js†L2689-L2696】
    - Units / spaces: Deals with degrees for FOV values.【F:src/gameplay.js†L2689-L2695】
    - Determinism: Deterministic.【F:src/gameplay.js†L2689-L2696】
    - Keep / change / delete: Keep; provides a safe way to reapply defaults (alternative is duplicating the callback-check each time).
    - Confidence / assumptions: High confidence; assumes `state.camera` is populated before reset.
  - `resetScene`
    - Purpose: Reinitializes the entire gameplay scene—reloading track/cliff data, resetting texture zones, metrics, props, cars, and player state to start a new session.【F:src/gameplay.js†L2699-L2751】
    - Inputs: None (async).【F:src/gameplay.js†L2699-L2751】
    - Outputs: Returns a promise that resolves when setup completes.【F:src/gameplay.js†L2699-L2751】
    - Side effects: Applies default FOV, rebuilds track/cliff data, resets zone arrays, recreates metrics, respawns props/cars, resets player/race state, and logs warnings on CSV issues.【F:src/gameplay.js†L2699-L2750】
    - Shared state touched and where it’s used: Mutates global `data` zone arrays, `state.metrics`, `state.cars`, and player/race state; invoked by bootstrap and app flows to start or restart gameplay.【F:src/gameplay.js†L2699-L2751】【F:src/bootstrap.js†L38-L65】【F:src/app.js†L722-L767】
    - Dependencies: Calls `applyDefaultFieldOfView`, `buildTrackFromCSV`, `buildCliffsFromCSV_Lite`, `enforceCliffWrap`, `pushZone`, `createInitialMetrics`, `spawnProps`, `spawnCars`, and `resetPlayerState`.【F:src/gameplay.js†L2700-L2747】
    - Edge cases it handles or misses: Catches and logs CSV load failures, ignores optional cliff build errors, and resets zones even when no segments exist; assumes asset paths are accessible.【F:src/gameplay.js†L2702-L2750】
    - Performance: Potentially heavy; performs async IO and iterates across segments to rebuild zones and props.【F:src/gameplay.js†L2702-L2750】
    - Units / spaces: Works in segment indices, track S units, and timer defaults.【F:src/gameplay.js†L2700-L2747】
    - Determinism: Deterministic aside from external IO results and randomness used by downstream spawns (e.g., car spawning).【F:src/gameplay.js†L2699-L2751】
    - Keep / change / delete: Keep; orchestrates full-scene setup (alternative would be splitting into multiple public calls but adds coordination complexity).
    - Confidence / assumptions: Medium confidence; assumes external CSV assets exist and `state.callbacks` handle optional notifications.
  - `queueReset`
    - Purpose: Requests a full scene reset by notifying callbacks, unless a reset matte is already active.【F:src/gameplay.js†L2754-L2759】
    - Inputs: None.【F:src/gameplay.js†L2754-L2759】
    - Outputs: None.【F:src/gameplay.js†L2754-L2759】
    - Side effects: Clears pending respawns and triggers `state.callbacks.onQueueReset` if provided.【F:src/gameplay.js†L2754-L2759】
    - Shared state touched and where it’s used: Mutates `state.pendingRespawn` and consults `state.resetMatteActive`; bound to the `R` key in the input handlers and exported via Gameplay API.【F:src/gameplay.js†L2754-L2759】【F:src/gameplay.js†L2596-L2598】【F:src/gameplay.js†L2799-L2802】
    - Dependencies: Relies on callback presence checks only.【F:src/gameplay.js†L2754-L2759】
    - Edge cases it handles or misses: No-ops if the reset matte is active; assumes callbacks handle asynchronous work safely.【F:src/gameplay.js†L2754-L2759】
    - Performance: Constant-time.【F:src/gameplay.js†L2754-L2759】
    - Units / spaces: Not applicable.【F:src/gameplay.js†L2754-L2759】
    - Determinism: Deterministic aside from callback behavior.【F:src/gameplay.js†L2754-L2759】
    - Keep / change / delete: Keep; provides a central reset hook (alternative is inlining callback invocation in input handlers).
    - Confidence / assumptions: High confidence; assumes callbacks manage visual reset flow.
- `queueRespawn`
- `startRaceSession`
- `step`

### 3.5 Sprite Placement, RNG, & Effects (`src/gameplay.js`)
- `splitCsvLine`
- `parseCsvWithHeader`
- `parseNumberRange`
- `parseNumericRange`
- `parseSpritePool`
- `parsePlacementMode`
- `normalizeSeed`
- `createRng`
- `randomInRange`
- `computeAxisScaleWeight`
- `computeAxisAtlasBias`
- `computePlacementBias`
- `biasedRandom01`
- `sampleScaleValue`
- `sampleUniformIndex`
- `sampleBiasedIndex`
- `computeLaneStep`
- `dedupePositions`
- `computeLanePositions`
- `clampSegmentRange`
- `selectAsset`
- `determineInitialFrame`
- `buildSpriteMetaOverrides`
- `generateSpriteInstances`
- `createSpriteFromInstance`
- `loadSpriteCsv`
- `parseSpritePlacements`
- `ensureSpriteDataLoaded`
- `computeDriftSmokeInterval`
- `allocDriftSmokeSprite`
- `recycleDriftSmokeSprite`
- `computeSparksInterval`
- `allocSparksSprite`
- `recycleSparksSprite`
- `recycleTransientSprite`
- `keyActionFromFlag`
- `createKeyHandler`

### 3.6 Track & Environment Management (`src/world.js`)
- `resolveAssetUrl`
- `loadImage`
- `defaultTextureLoader`
- `loadTexturesWith`
- `resetCliffSeries`
- `randomSnowScreenColor`
- `roadWidthAt`
- `addSegment`
- `lastY`
- `addRoad`
- `buildTrackFromCSV`
- `buildCliffsFromCSV_Lite`
- `enforceCliffWrap`
- `pushZone`
- `findZone`
- `vSpanForSeg`
- `clampBoostLane`
- `clampRoadLane`
- `laneToCenterOffset`
- `laneToRoadRatio`
- `getZoneLaneBounds`
- `parseBoostZoneType`
- `parseBoostLaneValue`
- `segmentAtS`
- `elevationAt`
- `cliffParamsAt`
  - `cliffSurfaceInfoAt`
    - Purpose: Derives cliff height and slope information beyond the road edge at a sampled segment position, returning a normalized info object for downstream checks.【F:src/gameplay.js†L1724-L1801】
    - Inputs: `segIndex` — segment index being sampled; `nNorm` — normalized lateral coordinate where |n|>1 falls outside the road; `t` — longitudinal interpolation along the segment (defaults to 0).【F:src/gameplay.js†L1724-L1780】
    - Outputs: Returns an info object containing `heightOffset`, `slope`, `slopeA/B`, `coverageA/B`, and `section` flags describing the sampled cliff portions.【F:src/gameplay.js†L1724-L1801】
    - Side effects: None; allocates a new info object.【F:src/gameplay.js†L1724-L1801】
    - Shared state touched and where it’s used: Reads shared track data via `cliffParamsAt`, `segmentAtIndex`, `roadWidthAt`, and `track.roadWidth`; reused by steep-cliff detection and tilt computations.【F:src/gameplay.js†L1728-L1779】【F:src/gameplay.js†L1681-L1684】【F:src/gameplay.js†L1804-L1814】
    - Dependencies: Calls `cliffParamsAt`, `segmentAtIndex`, `roadWidthAt`, `clamp01`, and `createCliffInfo`.【F:src/gameplay.js†L1728-L1798】
    - Edge cases it handles or misses: Returns default info for in-road samples, missing params, or zero-width cliffs; assumes provided `dx`/`dy` pairs describe contiguous sections.【F:src/gameplay.js†L1725-L1799】
    - Performance: Constant-time despite several arithmetic branches.【F:src/gameplay.js†L1724-L1801】
    - Units / spaces: Uses segment S (`t`) and normalized lateral coordinates `n`, translating cliff widths/height deltas into slope ratios.【F:src/gameplay.js†L1734-L1794】
    - Determinism: Deterministic given the same cliff data.【F:src/gameplay.js†L1724-L1801】
    - Keep / change / delete: Keep; consolidates cliff sampling math (alternative would be duplicating calculations in each consumer).
    - Confidence / assumptions: Medium confidence; assumes cliff parameter objects include `left/right` sections with finite `dx`/`dy`.
- `floorElevationAt`
  - `cliffLateralSlopeAt`
    - Purpose: Convenience accessor that returns the aggregate lateral slope component from `cliffSurfaceInfoAt` for a given sample.【F:src/gameplay.js†L1803-L1806】
    - Inputs: `segIndex` — segment index; `nNorm` — normalized lateral coordinate; `t` — optional longitudinal interpolation.【F:src/gameplay.js†L1803-L1806】
    - Outputs: Returns the `slope` field from the computed cliff info (defaults to 0).【F:src/gameplay.js†L1803-L1806】
    - Side effects: None.【F:src/gameplay.js†L1803-L1806】
    - Shared state touched and where it’s used: Delegates to `cliffSurfaceInfoAt`; consumed by `applyCliffPushForce` when applying lateral push-back near cliffs.【F:src/gameplay.js†L1803-L1806】【F:src/gameplay.js†L1869-L1878】
    - Dependencies: Calls `cliffSurfaceInfoAt`.【F:src/gameplay.js†L1803-L1805】
    - Edge cases it handles or misses: Inherits `cliffSurfaceInfoAt`’s handling; no additional guards.【F:src/gameplay.js†L1803-L1806】
    - Performance: Constant-time.【F:src/gameplay.js†L1803-L1806】
    - Units / spaces: Returns slope ratios derived from cliff geometry.【F:src/gameplay.js†L1803-L1806】
    - Determinism: Deterministic.【F:src/gameplay.js†L1803-L1806】
    - Keep / change / delete: Keep; keeps push-force code succinct (alternative is inlining the info lookup).
    - Confidence / assumptions: High confidence; assumes cliff info helpers stay stable.

### 3.7 Rendering & Camera Systems (`src/render.js`)
- `areTexturesEnabled`
- `randomColorFor`
- `makeColor`
- `applyDeadzone`
- `smoothTowards`
- `atlasUvFromRowCol`
- `computePlayerAtlasSamples`
- `computePlayerSpriteSamples`
- `createPerfTracker`
- `makeFrameStats`
- `beginFrame`
- `endFrame`
- `wrapRenderer`
- `markSolidStart`
- `markSolidEnd`
- `isSolidActive`
- `countDrawCall`
- `registerDrawListSize`
- `registerStrip`
- `registerSprite`
- `registerSnowScreen`
- `registerSnowQuad`
- `registerBoostQuad`
- `registerPhysicsSteps`
- `registerSegment`
- `getLastFrameStats`
- `isSnowFeatureEnabled`
- `numericOr`
- `orderedRange`
- `rangeFromConfig`
- `computeSnowScreenBaseRadius`
- `mulberry32`
- `buildSnowField`
- `ensureSnowFieldPool`
- `snowFieldFor`
- `fogNear`
- `computeOverlayEnabled`
- `syncOverlayVisibility`
- `createPoint`
- `projectWorldPoint`
- `projectSegPoint`
- `padWithSpriteOverlap`
- `computeCliffLaneProgress`
- `fogArray`
- `getTrackLength`
- `projectPoint`
- `makeCliffLeftQuads`
- `makeCliffRightQuads`
- `fogFactorFromZ`
- `spriteFarScaleFromZ`
- `drawParallaxLayer`
- `renderHorizon`
- `drawRoadStrip`
- `drawBoostZonesOnStrip`
- `drawBillboard`
- `drawBillboardRotated`
- `segmentAtS`
- `elevationAt`
- `groundProfileAt`
- `boostZonesOnSegment`
- `zonesFor`
- `renderScene`
- `createCameraFrame`
- `applyCameraTilt`
- `buildWorldDrawList`
- `enqueuePlayer`
- `renderDrawList`
- `renderSnowScreen`
- `renderStrip`
- `renderPlayer`
- `computeDebugPanels`
- `worldToOverlay`
- `drawBoostCrossSection`
- `mapRatio`
- `fmtSeconds`
- `fmtCount`
- `fmtSpeed`
- `fmtFloat`
- `renderOverlay`
- `start`
- `tick`
- `draw`
- `startReset`
- `startRespawn`
- `attach`
- `frame`
- `loop`

### 3.8 WebGL Renderer (`src/gl/renderer.js`)
- `constructor`
- `_createShader`
- `_createProgram`
- `_makeWhiteTex`
- `loadTexture`
- `begin`
- `setRollPivot`
- `drawQuadTextured`
- `drawQuadSolid`
- `makeCircleTex`
- `end`
- `padQuad`
- `makeRotatedQuad`

### 3.9 Sprite Catalog (`src/sprite-catalog.js`)
- `freezeClip`
- `makeFrames`
- `makeAtlasFrameAssets`
- `cloneCatalog`
- `getTextureManifest`
- `getCatalogEntry`
- `getMetrics`

### 3.10 Math Utilities (`src/math.js`)
- `clamp`
- `clamp01`
- `lerp`
- `pctRem`
- `createEaseIn`
- `createEaseOut`
- `createEaseInOut`
- `easeLinear01`
- `easeInQuad01`
- `easeOutQuad01`
- `easeInOutQuad01`
- `easeInCub01`
- `easeOutCub01`
- `easeInOutCub01`
- `createCurveEase`
- `easeLinear`
- `easeInQuad`
- `easeOutQuad`
- `easeInCub`
- `easeOutCub`
- `getEase01`
- `computeCurvature`
- `tangentNormalFromSlope`

### 3.11 Testing Utilities (`test/glrenderer.resize.test.js`)
- `assert`
- `makeRenderer`
- `gl.viewport`
- `gl.clearColor`
- `gl.clear`
- `gl.uniform2f`
- `gl.uniform1i`
- `gl.uniform3f`

## 4. Cleanup Priorities Aligned to Our Goals

### 4.1 Make the Code Easier to Read
- Split giant files like `app.js`, `gameplay.js`, and `world.js` into smaller modules with clear names.
- Add short docs that explain what each module exports and how the pieces connect.
- Use the same naming style everywhere (for example, always `camelCase` for functions and consistent prefixes like `init` or `create`).
- Replace hidden globals with explicit imports and exports so we know where values come from.

### 4.2 Trim Repeated or Unused Code
- Move shared helpers such as HTML escaping or asset URL builders into one place.
- Remove menu states or debug toggles that no longer run.
- Consolidate repeated HTML or sprite templates into reusable builders.

### 4.3 Speed Up Runtime
- Profile the render loop to find slow steps, then batch sprite draws and cut down allocations.
- Cache expensive calculations (segment projections, easing curves, texture lookups) so we do them once per update.
- Limit DOM work by batching menu updates and making sure network requests (like leaderboards) run asynchronously.
- Watch for code that creates lots of short-lived objects and switch to in-place updates where possible.

### 4.4 Future Changes
- Add a persistence step that writes new leaderboard scores back into `data/leaderboard.csv` so every finished race stays tracked after reloads.
